{% extends "dashboard/layout.html" %}


{% block title %}
  전자결재
{% endblock %}


{% block css %}
  <style>
  </style>
{% endblock %}


{% block content %}
  <form id="documentForm" method="post">{% csrf_token %}</form>

  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h6 class="m-0 h3 text-gray-800"> 문서 양식 등록 </h6>
    </div>

    <div class="card-body">
      <div class="row mb-3">
        <div class="col-6">
          <label for="formTitle" class="font-weight-bold text-primary">문서명</label>
          <input id="formTitle" name="formTitle" class="form-control">
        </div>
        <div class="col-3">
          <label for="firstCategory" class="font-weight-bold text-primary">대분류</label>
          <select id="firstCategory" name="firstCategory" class="form-control"></select>
        </div>
        <div class="col-3">
          <div class="d-flex flex-row align-items-center justify-content-between">
            <label for="secondCategory" class="font-weight-bold text-primary">소분류</label>
            <a href="#" role="button" id="addCategory" data-toggle="modal" data-target="#categoryModal">
              <i class="fas fa-plus-circle fa-fw text-primary"></i>
            </a>
          </div>
          <select id="secondCategory" name="secondCategory" class="form-control"></select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-12">
          <label for="comment" class="font-weight-bold text-primary">문서설명</label>
          <input id="comment" name="comment" class="form-control">
        </div>
      </div>

      <div class="d-flex flex-row align-items-center justify-content-between">
        <label for="formHtml" class="font-weight-bold text-primary">본문</label>
        <span>※ 문서편집기 하단을 드래그 하여 크기를 조정할 수 있습니다.</span>
      </div>
      <div id="formHtml"></div>
    </div>
    <div class="text-center mb-3">
      <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_cancel()">
        <span class="icon text-white-50"> <i class="fas fa-times"> </i> </span>
        <span class="text">취소</span>
      </a>
      <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
        <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
        <span class="text">등록</span>
      </a>
    </div>
  </div>

  <!-- category Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="categoryModalLabel">문서 분류 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <div onkeydown="javascript: if (event.keyCode == 13) {btn_register();}">
            <div class="row mb-3">
              <div class="col-6">
                <label for="firstCategoryAdd" class="font-weight-bold text-primary">대분류</label>
                <input type="text" class="form-control" id="firstCategoryAdd" name="firstCategoryAdd">
              </div>
              <div class="col-6">
                <label for="secondCategoryAdd" class="font-weight-bold text-primary">소분류</label>
                <input type="text" class="form-control" id="secondCategoryAdd" name="secondCategoryAdd">
              </div>
            </div>
          </div>
          <span class="text-danger">※ 오타없이 입력해주세요.</span>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_register()">등록</a>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}
  <script type="text/javascript">
    // 문서 양식 등록
    function btn_save() {
        const documentForm = $('#documentForm');
        $('<input />', {
            type: 'hidden',
            name: 'formTitle',
            value: $('#formTitle').val()
        }).appendTo(documentForm);
        $('<input />', {
            type: 'hidden',
            name: 'firstCategory',
            value: $('#firstCategory').val()
        }).appendTo(documentForm);
        $('<input />', {
            type: 'hidden',
            name: 'secondCategory',
            value: $('#secondCategory').val()
        }).appendTo(documentForm);
        $('<input />', {
            type: 'hidden',
            name: 'comment',
            value: $('#comment').val()
        }).appendTo(documentForm);
        $('<input />', {
            type: 'hidden',
            name: 'formHtml',
            value: $('#formHtml').summernote('code')
        }).appendTo(documentForm);
        documentForm[0].submit();
    }

    // 문서 분류 등록
    function btn_register() {
        const firstCategoryAdd = $('#firstCategoryAdd').val();
        const secondCategoryAdd = $('#secondCategoryAdd').val();
        if (firstCategoryAdd === '') {
            alert('대분류를 입력해주세요.');
            return false;
        }
        if (secondCategoryAdd === '') {
            alert('소분류를 입력해주세요.');
            return false;
        }
        $.ajax({
            url: "{% url 'approval:postdocumentcategory' %}",
            method: 'POST',
            cache: false,
            data: {
                "firstCategoryAdd": firstCategoryAdd,
                "secondCategoryAdd": secondCategoryAdd,
            },
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function (message) {
                alert(message);
                load_category();
                $('.close').click();
            }
        });
    }

    // 분류 로드
    function load_category() {
        const firstCategory = $('#firstCategory');
        const secondCategory = $('#secondCategory');

        $.ajax({
            url: "{% url 'approval:documentcategoryasjson' %}",
            method: 'GET',
            cache: false,
            data: {"category": "first"},
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function (returnData) {
                firstCategory.empty();
                firstCategory.append('<option value="" selected="">---------</option>');
                secondCategory.append('<option value="" selected="">대분류 선택</option>');
                for (let i=0; i<returnData.length; i++){
                    firstCategory.append(
                        '<option value="' + returnData[i].firstCategory + '">' +
                        returnData[i].firstCategory + '</option>'
                    );
                }
            }
        });

        firstCategory.change(function() {
            $.ajax({
                url: "{% url 'approval:documentcategoryasjson' %}",
                method: 'GET',
                cache: false,
                data: {
                    "category": "second",
                    "firstCategory": this.value,
                },
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function (returnData) {
                    secondCategory.empty();
                    for (let i=0; i<returnData.length; i++){
                        secondCategory.append(
                            '<option value="' + returnData[i].secondCategory + '">' +
                            returnData[i].secondCategory + '</option>'
                        );
                    }
                }
            });
        });
    }

    $(document).ready(function() {
        // 분류 로드
        load_category();

        // 본문 작성
        const toolbar = [
            ['font', ['fontsize', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor']],
            ['font2', ['ol', 'ul', 'paragraph', 'height']],
            ['insert', ['picture', 'link', 'table', 'hr']],
            ['util', ['codeview', 'help']]
        ];
        let formHtml = $('#formHtml');
        formHtml.summernote({
            placeholder: '결재 문서 내용 작성',
            tabsize: 2,
            height: document.documentElement.clientHeight * 0.5,
            toolbar: toolbar,
            spellCheck: false,
            disableGrammar: true,
        });
    })

  </script>
{% endblock %}
