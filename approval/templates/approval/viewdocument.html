{% extends "dashboard/layout.html" %}


{% block title %}
전자결재
{% endblock %}


{% block css %}
<style>
  .pc-table {
    color: #333333;
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  .pc-table td, .pc-table th {
    padding: 8px 15px;
    vertical-align: middle;
    font-size: 14px;
    border: 1px dotted #858796a3;
  }

  .pc-table-title {
    width: 10%;
    background-color: #f8f9fc;
    text-align: center;
    font-weight: bold;
  }

  .pc-table-top {
    width: 10%;
    background-color: #f8f9fc;
    text-align: center;
  }

  .pc-table-bottom {
    width: 10%;
    text-align: center;
  }

  .pc-table-detail {
    width: 40%;
    text-align: left;
  }
</style>
{% endblock %}


{% block content %}
<form id="documentForm" method="post">{% csrf_token %}</form>

<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
    <h6 class="m-0 h3 text-gray-800">
      {{ document.formId.formNumber }}.
      {{ document.formId.formTitle }}
    </h6>
  </div>

  <div class="card-body">
    <table class="pc-table">
      <tbody>
      <tr>
        <td class="pc-table-title" colspan="1">문서 종류</td>
        <td class="pc-table-detail" colspan="4">
          {{ document.formId.categoryId.firstCategory }} >
          {{ document.formId.categoryId.secondCategory }} >
          {{ document.formId.formTitle }}
        </td>
        <td class="pc-table-title" colspan="1">문서 번호</td>
        <td class="pc-table-detail" colspan="4">{{ document.documentNumber }}</td>
      </tr>
      <tr>
        <td class="pc-table-title" colspan="1">기안 부서</td>
        <td class="pc-table-detail" colspan="4">{{ document.writeEmp.empDeptName }}</td>
        <td class="pc-table-title" colspan="1">기&nbsp;&nbsp;안&nbsp;&nbsp;자</td>
        <td class="pc-table-detail" colspan="4">{{ document.writeEmp.empName }}</td>
      </tr>
      <tr>
        <td class="pc-table-title" colspan="1">보존 연한</td>
        <td class="pc-table-detail" colspan="4">
          {% if document.preservationYear == 9999 %} 영구
          {% else %} {{ document.preservationYear }}년
          {% endif %}
        </td>
        <td class="pc-table-title" colspan="1">보안 등급</td>
        <td class="pc-table-detail" colspan="4">{{ document.securityLevel }}등급</td>
      </tr>
      <tr>
        <td class="pc-table-title" colspan="1">기안 일시</td>
        <td class="pc-table-detail" colspan="4">{{ document.draftDatetime | date:"Y.m.d. H:i:s" }}</td>
        <td class="pc-table-title" colspan="1">완료 일시</td>
        <td class="pc-table-detail" colspan="4">{{ document.approveDatetime | date:"Y.m.d. H:i:s" }}</td>
      </tr>
      {% if document.formId.approvalFormat == '신청' %}
        {% for approvals in approvalList %}
          {% for approval in approvals %}
            {% if approval.name == '신청' or approval.name == '승인'%}
              <tr class="pc-table-title">
                <td rowspan="3">{{ approval.name }}</td>
              {% for a in approval.data %}
                <td rowspan="1" class="font-weight-normal">{{ a.approvalEmp__empPosition__positionName}}</td>
              {% endfor %}
              </tr>
              <tr>
              {% for a in approval.data %}
                <td rowspan="1" height="80px" class="text-center">
                {% if a.approvalStatus == '완료' %}
                  <div><img src="/media/icon/accepted.png" width="45%"></div>
                  <div>{{ a.approvalDatetime | date:"Y.m.d" }}</div>
                {% elif a.approvalStatus == '반려' %}
                  <div><img src="/media/icon/rejected.png" width="45%"></div>
                  <div>{{ a.approvalDatetime | date:"Y.m.d" }}</div>
                {% elif a.approvalStatus == '대기' %}
                  {% if user.employee.empId == a.approvalEmp and a.approvalEmp in do_approval %}
                    <span>
                      <button class="btn btn-primary" onclick="document.location.href='/approval/approvedocument/{{a.approvalId}}/'">승인</button>
                      <button class="btn btn-danger" onclick="document.location.href='/approval/returndocument/{{a.approvalId}}/'">반려</button></span>
                  {% else %}
                    <span>대기</span>
                  {% endif %}
                {% elif a.approvalStatus == '정지' %}
                  <span>-</span>
                {% endif %}
                </td>
              {% endfor %}
              </tr>
              <tr class="pc-table-bottom">
              {% for a in approval.data %}
                <td rowspan="1">{{ a.approvalEmp__empName}}</td>
              {% endfor %}
              </tr>
            {% endif %}
          {% endfor %}
        {% endfor %}
      {% elif document.formId.approvalFormat == '결재' %}
        {% for approvals in approvalList %}
          {% for approval in approvals %}
            {% if approval.name == '결재' or approval.name == '합의' or approval.name == '재무합의' %}
              <tr class="pc-table-title">
                <td rowspan="3">{{ approval.name }}</td>
              {% for a in approval.data %}
                <td rowspan="1" class="font-weight-normal">{{ a.approvalEmp__empPosition__positionName }}</td>
              {% endfor %}
              </tr>
              <tr>
              {% for a in approval.data %}
                <td rowspan="1" height="80px" class="text-center">
                {% if a.approvalStatus == '완료' %}
                  <div><img src="/media/icon/accepted.png" width="45%"></div>
                  <div>{{ a.approvalDatetime | date:"Y.m.d" }}</div>
                {% elif a.approvalStatus == '반려' %}
                  <div><img src="/media/icon/rejected.png" width="45%"></div>
                  <div>{{ a.approvalDatetime | date:"Y.m.d" }}</div>
                {% elif a.approvalStatus == '대기' %}
                  {% if user.employee.empId == a.approvalEmp and a.approvalEmp in do_approval %}
                  <span>
                    <button class="btn btn-primary" onclick="document.location.href='/approval/approvedocument/{{a.approvalId}}/'">승인</button>
                    <button class="btn btn-danger" onclick="document.location.href='/approval/returndocument/{{a.approvalId}}/'">반려</button></span>
                  </span>
                  {% else %}
                  <span>대기</span>
                  {% endif %}
                {% elif a.approvalStatus == '정지' %}
                  <span>-</span>
                {% endif %}
                </td>
              {% endfor %}
              </tr>
              <tr class="pc-table-bottom">
              {% for a in approval.data %}
                <td rowspan="1">{{ a.approvalEmp__empName }}</td>
              {% endfor %}
              </tr>
            {% endif %}
          {% endfor %}
        {% endfor %}
      {% endif %}
        {% for approval in reference %}
            <tr class="pc-table-title">
              <td rowspan="3">{{ approval.name }}</td>
            {% for a in approval.data %}
              <td rowspan="1" class="font-weight-normal">{{ a.approvalEmp__empPosition__positionName }}</td>
            {% endfor %}
            </tr>
            <tr>
            {% for a in approval.data %}
              <td rowspan="1" class="text-center">
              {% if a.approvalStatus == '완료' %}
                <i class="text-primary fas fa-check"></i>
              {% elif a.approvalStatus == '대기' %}
                {% if user.employee.empId == a.approvalEmp and a.approvalEmp in check_approval%}
                <span>
                  <button class="btn btn-info" onclick="document.location.href='/approval/approvedocument/{{a.approvalId}}/'">확인</button>
                </span>
                {% else %}
                <span>대기</span>
                {% endif %}
              {% elif a.approvalStatus == '정지' %}
                <span>-</span>
              {% endif %}
              </td>
            {% endfor %}
            </tr>
            <tr class="pc-table-bottom">
            {% for a in approval.data %}
              <td rowspan="1">{{ a.approvalEmp__empName }}</td>
            {% endfor %}
            </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mt-3 ml-3 text-gray-900">
      <h4 class="mb-4">{{ document.title }}</h4>
      {{ document.contentHtml | safe }}
      <br>
      {% if files or related %}
        <hr>
        <br>
        <div class="row">
          {% if files %}
            <div class="col-6">
              <b>첨부파일</b>
              {% for f in files %}
              <br><a href="/media/{{ f.file }}" download>{{ f.fileName }} ({{ f.fileSize }}MB)</a>
              {% endfor %}
            </div>
          {% endif %}
          {% if related %}
            <div class="col-6">
              <b>관련문서</b>
              {% for r in related %}
              <br>
              <a href="/approval/viewdocument/{{ r.relatedDocumentId.documentId }}" target="_blank">
                [{{ r.relatedDocumentId.documentNumber }}]
                {{ r.relatedDocumentId.title }}
              </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}


{% block script %}
<script type="text/javascript">
    $(document).ready(function () {
        const reference = $('#reference');
        {% if reference %}
          reference.attr("data-id", "{{ reference }}");
        {% endif %}
        $('.empName').magicsearch({
            dataSource: {{ empNames|safe }},
            fields: 'name',
            id: 'id',
            multiple: true,
            multiField: 'name',
            format: '%name% %position% (%dept%)',
            multiStyle: {space: 5, width: 80},
            noResult: '검색결과없음',
            focusShow: false,
        });
    })

</script>
{% endblock %}
