{% extends "dashboard/layout.html" %}
{% load humanize %}


{% block title %}
  입출고관리
{% endblock %}


{% block css %}
  <style>
    pc-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table td, .pc-table th {
      padding: 5px 15px;
      text-align: center;
      vertical-align: middle;
      font-size: 17px;
      border: 1px solid rgba(206, 210, 219, 0.64);
    }

    pc-table2 {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table2 td, .pc-table th {
      padding: 3px 10px;
      text-align: center;
      vertical-align: middle;
      font-size: 15px;
      border: 1px solid rgba(206, 210, 219, 0.64);
    }

    .thumbnail{
    position: relative;
    z-index: 0;
    }

    .thumbnail:hover{
    background-color: transparent;
    z-index: 50;
    }

    .thumbnail span{ /*CSS for enlarged image*/
    position: absolute;
    background-color: lightyellow;
    padding: 5px;
    left: -1000px;
    border: 1px solid lightgrey;
    visibility: hidden;
    color: black;
    text-decoration: none;
    }

    .thumbnail span img{ /*CSS for enlarged image*/
    border-width: 0;
    padding: 2px;
    }

    .thumbnail:hover span{ /*CSS for enlarged image on hover*/
    visibility: visible;
    top: 0;
    left: 60px; /*position where enlarged image should offset horizontally */

    }
  </style>
{% endblock %}


{% block content %}
  <div class="row">
    <div class="col-xl-12">
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800">입출고관리</h6>
          <div class="dropdown no-arrow">
            <a class="btn btn-success" href="#" role="button" id="filterLink" data-toggle="modal" data-target="#filterModal">
              <i class="fas fa-filter d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-filter"></i> 조회</span>
            </a>
            <!--{% if user.is_staff %}-->
              <!--<a class="btn btn-primary" href="#" role="button" onclick="open_insertmodal()">-->
                <!--<i class="fas fa-pen d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-pen"></i> 일괄등록</span>-->
              <!--</a>-->
            <!--{% endif %}-->
          </div>
        </div>
        <div class="card-body">
          <h5>▼ <span class="text-primary font-weight-bold">입출고 목록</span></h5>
          <form method="POST" id="postForm">
            {% csrf_token %}
            <div class="form-group row m-2 pt-4">
              <div class="col-xl-4">
                <label for="productName" class="font-weight-bold text-primary"> 모델명 </label> {{ form.productName }}
              </div>
              <div class="col-xl-4">
                <label for="sizeName" class="font-weight-bold text-primary"> 사이즈 </label> {{ form.sizeName }}
              </div>
              <div class="col-xl-3">
                <label for="quantity" class="font-weight-bold text-primary"> 수량 </label> {{ form.quantity }}
              </div>
              <div class="col-xl-1 text-center">
                <span class="btn bg-info text-white mt-4 center" onclick="btn_post('입고')">입고</span>
                <span class="btn bg-danger text-white mt-4 center" onclick="btn_post('출고')">출고</span>
              </div>
            </div>
          </form>
          <div class="p-3">
            <table id="showreproduction" class="display" style="width:100%">
              <thead>
              <tr style="background-color: #deeef8; color: black;">
                <td>발생일자</td>
                <td>품명</td>
                <td>사이즈</td>
                <td>수량</td>
                <td>비고</td>
                <td><i class="fas fa-trash-alt text-secondary"></i></td>
              </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="filterModalLabel">검색조건</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="filterForm" method="POST" onkeydown="javascript: if (event.keyCode == 13) {btn_filter();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6">
                <label for="startdate" class="font-weight-bold text-primary">시작 일자</label>
                <input type="date" max="9999-12-31" class="form-control" id="startdate" name="startdate" required>
              </div>
              <div class="col-6">
                <label for="enddate" class="font-weight-bold text-primary">종료 일자</label>
                <input type="date" max="9999-12-31" class="form-control" id="enddate" name="enddate" required>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-6">
                <label for="filterProduct" class="font-weight-bold text-primary">모델명</label>
                <input type="text" class="form-control" id="filterProduct" name="filterProduct" required>
              </div>
              <div class="col-6">
                <label for="filterSize" class="font-weight-bold text-primary">사이즈</label>
                <input type="text" class="form-control" id="filterSize" name="filterSize" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_filter()">조회</a>
        </div>
      </div>
    </div>
  </div>

  <!-- insert Modal -->
  <div class="modal fade" id="insertModal" tabindex="-1" role="dialog" aria-labelledby="insertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="insertModalLabel">일괄등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="insertForm" action="/daesungwork/insertreproduction/" method="POST" onkeydown="javascript: if (event.keyCode == 13) {btn_insert();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-3">
                <label class="font-weight-bold text-primary">발생 일자</label>
                <input type="date" max="9999-12-31" class="form-control" name="postDate" id="insertPostDate" required>
              </div>
            </div>
          </form>
          <table id="insertTable" class="display" style="width:100%">
            <thead style="width:100%">
            <tr>
              <th class="font-weight-bold text-primary">담당자</th>
              <th class="font-weight-bold text-primary">구분</th>
              <th class="font-weight-bold text-primary">모델명</th>
              <th class="font-weight-bold text-primary">사이즈</th>
              <th class="font-weight-bold text-primary">수량</th>
              <th class="font-weight-bold">생성일</th>
              <!--<th><i id="addDisplay" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>-->
            </tr>
            </thead>
          </table>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_insert()">등록</a>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function product_select(productSelectId) {
          let productSelectObj = $('#' + productSelectId);
          $.ajax({
              url: "{% url 'daesungwork:productasjson' %}",
              method: 'GET',
              cache: false,
              data: {},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  productSelectObj.append('<option value="">------</option>');
                  for (let i=0; i<returnData.length; i++) {
                      productSelectObj.append(
                          '<option value="' + [returnData[i].productId + '">' + returnData[i].modelName] + '</option>'
                      );
                  }
              }
          });
      }


      function btn_filter() {
          document.getElementById("filterForm").submit();
      }

      function changeModel(modelName, sizeSelectId) {
          $.ajax({
              url: "{% url 'daesungwork:modelasjson' %}",
              method: 'POST',
              cache: false,
              data: {"modelName": modelName,},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var sizes = returnData[1];
                  $('#' + sizeSelectId).empty();
                  for (var count = 0; count < sizes.length; count++) {
                      var option = $("<option value=" + sizes[count].sizeId + ">" + sizes[count].size + "</option>");
                      $('#' + sizeSelectId).append(option);
                  }
              }
          });
      }

      function btn_post(typeName) {
          if (document.getElementById("productName").value === '') {
              alert("제품명을 입력해주세요.");
              return false;
          }
          if (document.getElementById("sizeName").value === '') {
              alert("사이즈를 선택해주세요.");
              return false;
          }
          if (document.getElementById("quantity").value === '') {
              alert("수량을 입력해주세요.");
              return false;
          }
          const postForm = document.getElementById('postForm');

          if(typeName == "입고")
          {
              postForm.action = "/daesungwork/poststockinout/입고/";
          }
          else if(mode == "출고")
          {
              postForm.action = "/daesungwork/poststockinout/출고/";
          }
          postForm.submit();
      }

      $(document).ready(function () {
          $('#showreproduction').dataTable({
              "processing": true,
              "ajax": {
                  "processing": true,
                  "type": 'POST',
                  "data": {
                      'startdate': '{{ startdate }}',
                      'enddate': '{{ enddate }}',
                      'modelName': '{{ modelName }}',
                  },
                  "url": "{% url 'daesungwork:stockinoutasjson' %}",
                  "dataSrc": ""
              },
              "columns": [
                  {data: "managerEmp__empName"},
                  {data: "typeName"},
                  {data: "productName__productPicture",
                     "render": function (data, type, row) {
                         return '<a class="thumbnail" href="#thumb"><img src="/media/' + row['productName__productPicture'] + '" height="80px" border="0" /><span><img src="/media/' + row['productName__productPicture'] + '" /><br /></span></a>'
                     },
                  },
                  {data: "productName__modelName"},
                  {data: "sizeName__size"},
                  {data: "quantity"},
                  {data: "createdDateTime"},
              ],
              "columnDefs": [
                  {targets: 0, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 1, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, width: "20%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap", orderable: false},
                  {targets: 3, width: "20%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 6, width: "20%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
              ],
              "deferRender": true,
              "bLengthChange": false,
              "order": [[6, 'desc']],
              "searching": true,
              "paging": true,
              "info": false,
              "scrollY": "80vh",
              "scrollX": true,
              "scrollCollapse": true,
              "language": {
                  "lengthMenu": "_MENU_",
                  "search": "검색:",
                  "zeroRecords": "결과 없음",
                  "processing": "로딩중",
                  "paginate": {
                      "first": "처음",
                      "last": "끝",
                      "next": "→",
                      "previous": "←"
                  },
              },
              "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
              },
              "footerCallback": function () {
              },
          });

      });


  </script>

{% endblock %}