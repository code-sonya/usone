{% extends "dashboard/layout.html" %}


{% block title %}
제품위치조회
{% endblock %}


{% block css %}

<style type="text/css">

/*Credits: Dynamic Drive CSS Library */
/*URL: http://www.dynamicdrive.com/style/ */

.thumbnail{
position: relative;
z-index: 0;
}

.thumbnail:hover{
background-color: transparent;
z-index: 50;
}

.thumbnail span{ /*CSS for enlarged image*/
position: absolute;
background-color: lightyellow;
padding: 5px;
left: -1000px;
border: 1px solid lightgrey;
visibility: hidden;
color: black;
text-decoration: none;
}

.thumbnail span img{ /*CSS for enlarged image*/
border-width: 0;
padding: 2px;
}

.thumbnail:hover span{ /*CSS for enlarged image on hover*/
visibility: visible;
top: 0;
left: 60px; /*position where enlarged image should offset horizontally */

}

</style>

{% endblock %}


{% block content %}

<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
    <h6 class="m-0 h3 text-gray-800">제품위치조회</h6>
    <div class="dropdown no-arrow">
      <a class="btn btn-success" href="#" role="button" id="filterLink" data-toggle="modal" data-target="#filterModal">
        <i class="fas fa-filter d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-filter"></i> 제품명검색</span>
      </a>
    </div>
  </div>

  <div class="card-body">
     <form id="changeForm" method="POST">
      <div class="row mb-3">
        <div class="input-group">
          <span class="col-sm-6 col-xl-1 form-control" style="border:1px solid white">창고명: </span>
          <select class="col-sm-6 col-xl-1 form-control" id="maincategory" name="maincategoryId">
            {% for maincategory in maincategorys %}
            <option value="{{ maincategory.categoryId }}" {% if maincategoryId == maincategory.categoryId %} selected {% endif %}>
              {{ maincategory.categoryName }}
            </option>
            {% endfor %}
          </select>
          <span class="col-sm-6 col-xl-1 form-control" style="border:1px solid white">위치: </span>
          <select class="col-sm-6 col-xl-1 form-control" id="subcategory" name="subcategoryId" onchange="btn_change()">
            {% for subcategory in subcategorys %}
            <option value="{{ subcategory.categoryId }}" {% if subcategoryId == subcategory.categoryId %} selected {% endif %}>
              {{ subcategory.categoryName }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
     </form>
    <div class="row">
      <h5 class="text-primary">
        <span class="ml-3 text-dark">▼</span> 창고 배치 정보
      </h5>
    </div>
    <div class="row">
      <div class="col-xl-4"></div>
      <div class="col-xl-4 text-center">
        {% if sectionImage %}
        <img src="/media/{{ sectionImage.warehouseDrawing }}" style="width: 100%;height: 100%;max-height: 400px">
        {% else %}
        <img src="/media/warehouse/noimage.png" style="height: 100%;max-height: 400px">
        {% endif %}
      </div>
      <div class="col-xl-4"></div>
    </div>
    <div class="table-responsive">
      <table id="showlocations" class="hover row-border" style="width: 100%;">
        <thead>
        <tr style="background-color: #deeef8; color: black;">
          <th>제품사진</th>
          <th>제품명</th>
          <th>사이즈</th>
          <th>단가</th>
        </tr>
        </thead>
      </table>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header bg-info text-gray-100">
        <h5 class="modal-title" id="filterModalLabel">조회조건</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span class="text-gray-100" aria-hidden="true">×</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="filterForm" method="POST" onkeydown="javascript: if (event.keyCode == 13) {btn_filter();}">
          {% csrf_token %}
          <!--<div class="row mb-1">-->
            <!--<div class="col-6 mb-3 mb-sm-0">-->
              <!--<label class="text-primary font-weight-bold">시작일자</label>-->
              <!--<input type="date" max="9999-12-31" class="form-control" name="startdate" value="{{ startdate }}">-->
            <!--</div>-->
            <!--<div class="col-6 mb-3 mb-sm-0">-->
              <!--<label class="text-primary font-weight-bold">종료일자</label>-->
              <!--<input type="date" max="9999-12-31" class="form-control" name="enddate" value="{{ enddate }}">-->
            <!--</div>-->
          <!--</div>-->
          <div class="row mb-1">
            <div class="col-6 mb-3 mb-sm-0">
              <label class="text-primary font-weight-bold">모델명</label>
              <select class="form-control" id="productId" name="productId" onchange="changeModel(this.value)">
                <option value="">-----</option>
                {% for product in products %}
                  <option value="{{ product.productId }}">{{ product.modelName }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 mb-3 mb-sm-0">
              <label class="text-secondary font-weight-bold">사이즈</label>
              <select class="form-control" id="sizeId" name="sizeId">
                <option value="">-----</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
        <a class="btn btn-info" href="#" onclick="btn_filter()">검색</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block script %}

<script type="text/javascript">
    function btn_change(){
        const changeForm = document.getElementById("changeForm");
        const productId = document.createElement("input");
        productId.setAttribute("type", "hidden");
        productId.setAttribute("name", "productId");
        productId.setAttribute("value", "{{ productId }}");
        changeForm.appendChild(productId);
        const sizeId = document.createElement("input");
        sizeId.setAttribute("type", "hidden");
        sizeId.setAttribute("name", "sizeId");
        sizeId.setAttribute("value", "{{ sizeId }}");
        changeForm.appendChild(sizeId);
        changeForm.submit();
    }

    function changeModel(modelName) {
        $.ajax({
            url: "{% url 'daesungwork:modelasjson' %}",
            method: 'POST',
            cache: false,
            data: {"modelName": modelName,},
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function (returnData) {
                var sizes = returnData[1];
                $('#sizeId').empty();
                $('#sizeId').append("<option value=''>------</option>");
                for (var count = 0; count < sizes.length; count++) {
                    var option = $("<option value=" + sizes[count].sizeId + ">" + sizes[count].size + "</option>");
                    $('#sizeId').append(option);
                }
            }
        });
    }

    function btn_filter() {

        if (productId === '') {
            alert("모델명을 선택해주세요.");
            return false;
        }
        const filterForm = document.getElementById("filterForm");
        const maincategoryId = document.createElement("input");
        maincategoryId.setAttribute("type", "hidden");
        maincategoryId.setAttribute("name", "maincategoryId");
        maincategoryId.setAttribute("value", "");
        filterForm.appendChild(maincategoryId);
        const subcategoryId = document.createElement("input");
        subcategoryId.setAttribute("type", "hidden");
        subcategoryId.setAttribute("name", "subcategoryId");
        subcategoryId.setAttribute("value", "");
        filterForm.appendChild(subcategoryId);
        filterForm.submit();
    }

    function replaceAll(str, searchStr, replaceStr) {
        var new_str = str.split(searchStr).join(replaceStr);
        return new_str.split("T").join(" ").slice(0, 10);
    }

    $(document).ready(function () {
        const reportsTable = $('#showlocations').DataTable({
            "processing": true,
            "ajax": {
                "processing": true,
                "type": 'POST',
                "data": {
                    'productId': '{{ productId }}',
                    'sizeId': '{{ sizeId }}',
                    'maincategoryId': '{{ maincategoryId }}',
                    'subcategoryId': '{{ subcategoryId }}',
                },
                "url": "{% url 'daesungwork:locationasjson' %}",
                "dataSrc": ""
            },
            "columnDefs": [
                {
                    targets: 0,
                    width: "25%",
                    className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    data: "productPicture",
                     "render": function (data, type, row) {
                         // return '<img height="80px" src="' + '/media/' + row['productPicture'] + '/' + '">'
                         return '<a class="thumbnail" href="#thumb"><img src="/media/' + row['productPicture'] + '" height="80px" border="0" /><span><img src="/media/' + row['productPicture'] + '" /><br />Simply beautiful.</span></a>'
                     },
                },
                {
                    targets: 1,
                    width: "25%",
                    className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    data: "modelName",
                },
                {
                    targets: 2,
                    width: "25%",
                    className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    data: "size__size",
                },
                {
                    targets: 3,
                    width: "25%",
                    className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    data: "unitPrice",
                },
            ],
            "deferRender": true,
            "bLengthChange": false,
            "order": [[0, 'desc']],
            "searching": true,
            "paging": true,
            "info": false,
            "scrollY": "80vh",
            "scrollX": false,
            "scrollCollapse": true,
            "language": {
                "lengthMenu": "_MENU_개씩 보기",
                "search": "검색:",
                "zeroRecords": "결과 없음",
                "processing": "로딩중",
                "paginate": {
                    "first": "처음",
                    "last": "끝",
                    "next": "→",
                    "previous": "←"
                },
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                  $('td:eq(3)', nRow).text(aData.unitPrice.toLocaleString());
            },
            "footerCallback": function () {

            },
        });
    });

</script>

{% endblock %}