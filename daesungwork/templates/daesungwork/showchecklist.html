{% extends "dashboard/layout.html" %}


{% block title %}
센터별 체크리스트
{% endblock %}

{% block css %}
<style>
  pc-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table td, .pc-table th {
      padding: 5px 15px;
      text-align: center;
      vertical-align: middle;
      font-size: 17px;
      border: 1px solid rgba(206, 210, 219, 0.64);
    }
  pc-table2 {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

  .pc-table2 td, .pc-table th {
    padding: 3px 10px;
    text-align: center;
    vertical-align: middle;
    font-size: 15px;
    border: 1px solid rgba(206, 210, 219, 0.64);
  }
</style>
{% endblock %}


{% block content %}

<div class="row">
  <div class="col-xl-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 h3 text-gray-800"> 센터별 체크리스트</h6>
        <a class="btn bg-primary text-white" href="#" role="button" id="postLink" data-toggle="modal" data-target="#postModal">
            <span>점검</span>
        </a>
      </div>

      <div class="card-body">
        <form method="POST" id="searchForm">
          {% csrf_token %}
          <div class="row col-12">
            <span class="col-xl-2 m-0">
              <select class="form-control" id="centerName">
                {% for center in centers %}
                <option value="{{ center.centerName }}">
                  {{ center.centerName }}
                </option>
                {% endfor %}
              </select>
            </span>
          </div>
          <h5 class="text-center d-none d-xl-block mb-3">
            <i class="fas fa-angle-left text-primary" onclick="btn_move(1)"></i>
            {{ thisMonday | date:"Y년 m월 d일" }} ~ {{ thisSunday | date:"Y년 m월 d일" }}
            <i class="fas fa-angle-right text-primary" onclick="btn_move(2)"></i>
          </h5>

          <h6 class="text-center d-xl-none mb-3">
            <i class="fas fa-angle-left text-primary" onclick="btn_move(1)"></i>
            {{ thisMonday | date:"Y년 m월 d일" }} ~ {{ thisSunday | date:"Y년 m월 d일" }}
            <i class="fas fa-angle-right text-primary" onclick="btn_move(2)"></i>
          </h6>
        </form>
          <div class="row mb-3 center">
            {% if checkLists %}
              <table class="pc-table m-2" style="width: 100%;">
                <tr style="background-color: #c5e4f8; color: black;">
                  <th class="font-weight-normal">점검내용</th>
                  <th class="font-weight-normal">담당구역</th>
                  <th class="font-weight-normal">추가관리</th>
                  <th class="font-weight-normal">대청소담당구역</th>
                </tr>
                {% for emp in centermanageremps %}
                  <tr>
                    <th class="font-weight-normal text-dark" style="background-color: #deeef8;">{{ emp.empId.empName }}</th>
                    <th class="font-weight-normal text-dark">{{ emp.manageArea.centerName }}</th>
                    <th class="font-weight-normal text-dark">{{ emp.additionalArea }}</th>
                    <th class="font-weight-normal text-dark">{{ emp.cleanupArea.centerName }}</th>
                  </tr>
                {% endfor %}
              </table>
            {% else %}
            <table class="pc-table m-2" style="width: 100%;">
              <tr style="background-color: #deeef8; color: black;">
                <td><span style="width:100%" class="text-center center mb-3">조회 기간에 해당하는 <span class="text-danger">체크리스트 없음</span></span></td>
              </tr>

            </table>
            {% endif %}
          </div>
        </form>

        <div class="row justify-content-between">
          <h5 class="text-primary ml-3 mr-3">
            <span class="text-dark">▼</span> 작성 목록
          </h5>
        </div>

        <div id="centerManagerdiv">
          <table id="showcentermanagers" class="display" style="width:100%">
            <thead style="width:100%">
            <tr style="background-color: #deeef8; color: black;">
              <td>번호</td>
              <td>기간</td>
              <td>작성자</td>
              <td>작성일시</td>
            </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="postModal" tabindex="-1" role="dialog" aria-labelledby="postModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="postModalLabel">센터 점검</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="postForm" action="/daesungwork/postchecklist/" method="POST" onkeydown="javascript: if (event.keyCode == 13) {btn_post();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6">
                <label for="modalCenterName" class="text-primary">센터명</label>
                <select class="form-control" name="modalCenterName" id="modalCenterName">
                  {% for center in centers %}
                    <option value="{{ center.centerName }}">
                      {{ center.centerName }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-6">
                <label for="modalEmpName" class="text-primary">점검자</label>
                <select class="form-control" name="modalEmpName" id="modalEmpName">
                  {% for emp in employees %}
                    <option value="{{ emp.empId }}">
                      {{ emp.empName }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-12 mb-3 mb-sm-0">
                <label for="modalCheckDate" class="text-primary">점검일자</label>
                <input type="date" max="9999" class="form-control" name="modalCheckDate" id="modalCheckDate" value="{{ today | date:'Y-m-d' }}">
              </div>
            </div>
            <div class="row m-1">
              {% if checklist %}
                  <table class="pc-table2" style="width: 100%;">
                    <tr style="background-color: #c5e4f8;color: black">
                      <td>항목</td>
                      <td><input type="checkbox" class="checkall">점검여부</td>
                      <td>비고</td>
                      <td>첨부파일</td>
                    </tr>
                    {% for check in checklist %}
                    <tr>
                      <td name="checkListName" style="background-color: #deeef8; color: black">{{ check.checkListName }}</td>
                      <td style="color: black"><input name="checkListBox" type="checkbox" class="check" value="{{ check.checkListId }}"></td>
                      <td><input name="checkListComment" type="text" class="form-control"></td>
                      <td><input name="checkListFiles" type="file" class="file"></td>
                    </tr>
                    {% endfor %}
                  </table>
              {% endif %}
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_post()">등록</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block script %}

<script type="text/javascript">
    $('.checkall').click(function () {
            $('.check').prop('checked', this.checked);
    });

    function replaceAll(str, searchStr, replaceStr) {
          if (str != null) {
              var new_str = str.split(searchStr).join(replaceStr);
              return new_str.split("T").join(" ").slice(0, 16);
          } else {
              return '-'
          }
    }

    function btn_post() {
        if (document.getElementById("modalCheckDate").value === '') {
            alert("점검일자를 입력해주세요.");
            return false;
        }
        const postForm = document.getElementById('postForm');

        // 센터 담당자
        const lengthItem = $('[name="checkListName"]').length;
        const listItem = new Array();
        console.log('lengthItem:', lengthItem);
        for (var i = 0; i <= lengthItem - 1; i++) {
            var data = new Object();
            data.checkListName = $('td[name="checkListName"]').eq(i).text();
            data.checkListBox = $('input[name="checkListBox"]').eq(i).is(":checked");
            data.checkListComment = $('input[name="checkListComment"]').eq(i).val();
            data.checkListFiles = $('input[name="checkListFiles"]').eq(i).val();
            listItem.push(data);
          }
        const jsonCheckList = JSON.stringify(listItem);
        const item = document.createElement("input");
        item.setAttribute("type", "hidden");
        item.setAttribute("name", "jsonCheckList");
        item.setAttribute("value", jsonCheckList);
        postForm.appendChild(item);
        postForm.submit();

    }

    function btn_move(searchMonday){
        if(searchMonday==1){
            const searchForm = document.getElementById("searchForm");
            const searchDayInput = document.createElement("input");
            searchDayInput.setAttribute("type", "hidden");
            searchDayInput.setAttribute("name", "searchDay");
            searchDayInput.setAttribute("value", "{{ lastMonday |date:'Y-m-d'}}");
            searchForm.appendChild(searchDayInput);
            const centerName = document.getElementById("centerName").value;
            const centerNameInput = document.createElement("input");
            centerNameInput.setAttribute("type", "hidden");
            centerNameInput.setAttribute("name", "centerName");
            centerNameInput.setAttribute("value", centerName);
            searchForm.appendChild(centerNameInput);

            searchForm.submit();


        }else{
            const searchForm = document.getElementById("searchForm");
            const searchDay = document.createElement("input");
            searchDay.setAttribute("type", "hidden");
            searchDay.setAttribute("name", "searchDay");
            searchDay.setAttribute("value", "{{ nextMonday |date:'Y-m-d'}}");
            searchForm.appendChild(searchDay);
            const centerName = document.getElementById("centerName").value;
            const centerNameInput = document.createElement("input");
            centerNameInput.setAttribute("type", "hidden");
            centerNameInput.setAttribute("name", "centerName");
            centerNameInput.setAttribute("value", centerName);
            searchForm.appendChild(centerNameInput);

            searchForm.submit();

        }

    }

    $(document).ready(function () {

        $('#showcentermanagers').dataTable({
            "processing": true,
            "ajax": {
                "processing": true,
                "type": 'POST',
                "data": {
                    "userId": "{{ user.employee.empId }}",
                },
                "url": "{% url 'daesungwork:centermanagerasjson' %}",
                "dataSrc": ""
            },
            "columns": [
                {data: "centerManagerId", },
                {data: "startDate",
                  "render": function (data, type, row) {
                        return '<div>'+ row['startDate'] +" ~ "+ row['endDate'] +'</div>'
                  },
                },
                {data: "writeEmp__empName"},
                {data: "createdDatetime"},
            ],
            "columnDefs": [
                {targets: 0, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 1, width: "35%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 2, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 3, width: "35%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
            ],
            "deferRender": true,
            "bLengthChange" : false,
            "order": [[0, 'desc']],
            "searching": false,
            "paging": true,
            "info": false,
            "scrollY": "80vh",
            "scrollX": true,
            "scrollCollapse": true,
            "language": {
                "lengthMenu": "_MENU_",
                "search": "검색:",
                "zeroRecords": "결과 없음",
                "processing": "로딩중",
                "paginate": {
                    "first": "처음",
                    "last": "끝",
                    "next": "→",
                    "previous": "←"
                },
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                $('td:eq(3)', nRow).text(replaceAll(aData.createdDatetime, "-", "-"));
            },
            "footerCallback": function () {
            },
        });

        const centermanagersTable = $('#showcentermanagers').DataTable();

        $("#showcentermanagers").on("click", 'tr', function () {
            const data = centermanagersTable.row(this).data();
            // window.open('about:blank').location.href = '/daesungwork/viewcentermanager/' + data.centerManagerId + '/';
            location.href = '/daesungwork/viewcentermanager/' + data.centerManagerId + '/'
        });
    });


</script>

{% endblock %}