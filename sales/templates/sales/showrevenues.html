{% extends "dashboard/layout.html" %}


{% block title %}
  영업관리
{% endblock %}


{% block css %}

  <style type="text/css">

  </style>

{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-1"></div>

    <div class="col-xl-10">
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 매출 </h6>
        </div>
        <div class="card-body">
          {% csrf_token %}
          <div class="table-responsive">
            <table id="showrevenues" class="hover row-border" width="100%" style="width: 100%;">
              <thead>
              <tr>
                <th>영업부서</th>
                <th>영업담당</th>
                <th>계약명</th>
                <th>거래처</th>
                <th>매출금액</th>
                <th>이익금액</th>
                <th>빌링일자</th>
                <th class="d-none">revenueId</th>
              </tr>
              </thead>
              <tfoot>
                <tr>
                  <th colspan="4" style="text-align:right; white-space:nowrap;">TOTAL : </th>
                  <th style="text-align:center; white-space:nowrap;"></th>
                  <th style="text-align:center; white-space:nowrap;"></th>
                  <th style="text-align:center; white-space:nowrap;"></th>
                </tr>
              </tfoot>

            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-1"></div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">
      function replaceAll(str, searchStr, replaceStr) {
          var new_str = str.split(searchStr).join(replaceStr);
          return new_str.split("T").join(" ").slice(0, 10);
      }

      $(document).ready(function () {
          $('#showrevenues').dataTable({
              "processing": true,
              "ajax": {
                  "processing": true,
                  "url": "{% url 'sales:revenues_ajax_url' %}",
                  "dataSrc": ""
              },
              "columns": [
                  {data: 'contractId__empDeptName'},
                  {data: 'contractId__empName'},
                  {
                      data: 'contractId__contractName',
                      render: function (data, type, row) {return '[' + row["contractId__contractCode"] + '] ' + row["contractId__contractName"];}
                  },
                  {data: 'contractId__saleCompanyName__companyName'},
                  {data: 'revenuePrice'},
                  {data: 'revenueProfitPrice'},
                  {data: 'billingDate'},
                  {data: 'revenueId'},
              ],
              "columnDefs": [
                  {targets: 0, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 1, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, width: "40%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 6, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 7, visible: false}
              ],
              "order": [[0, 'desc']],
              "searching": true,
              "paging": true,
              "info": false,
              "scrollY": "80vh",
              "scrollCollapse": true,
              "language": {
                  "lengthMenu": "_MENU_ 개씩 보기",
                  "search": "검색:",
                  "paginate": {
                      "first": "처음",
                      "last": "끝",
                      "next": "다음",
                      "previous": "이전"
                  },
              },
              "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                  $('td:eq(4)', nRow).text(aData.revenuePrice.toLocaleString() + '원');
                  $('td:eq(5)', nRow).text(aData.revenueProfitPrice.toLocaleString() + '원');
                  $('td:eq(6)', nRow).text(replaceAll(aData.billingDate, "-", "."));
              },
              "footerCallback":function(){
                  var api = this.api(), data;

                  var revenueResult = 0;
                  api.column(4, {search:'applied'}).data().each(function(data,index){
                      revenueResult += parseFloat(data);
                  });
                  $(api.column(4).footer()).html(revenueResult.toLocaleString() +'원');

                  var profitResult = 0;
                  api.column(5, {search:'applied'}).data().each(function(data,index){
                      profitResult += parseFloat(data);
                  });
                  $(api.column(5).footer()).html(profitResult.toLocaleString() +'원');
              },
          });

          var table = $('#showrevenues').DataTable();

          $("#showrevenues").on("click", 'tr', function () {
              const data = table.row(this).data();
              location.href = '/sales/viewrevenue/' + data.revenueId + '/'
          });
      });

  </script>

{% endblock %}