{% extends "dashboard/layout.html" %}


{% block title %}
  영업관리
{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-2"></div>

    <div class="col-xl-8">
      <div class="card shadow mb-4">

        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 영업기회 및 계약 등록 </h6>
        </div>

        <div class="card-body">
          <form id="ContractForm" method="POST">
            {% csrf_token %}
            <div id="Opportunity">
              <div class="form-group row">
                <div class="col-12 mb-3">
                  <label for="contractName" class="font-weight-bold text-primary"> 제목 </label> {{ form.contractName }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="contractStep" class="font-weight-bold text-primary"> 단계 </label> {{ form.contractStep }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="empId" class="font-weight-bold text-primary"> 영업담당 </label> {{ form.empId }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="saleType" class="font-weight-bold text-primary"> 판매유형 </label> {{ form.saleType }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="saleIndustry" class="font-weight-bold text-primary"> 산업군 </label> {{ form.saleIndustry }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <div class="col-6 mb-3">
                  <label for="saleCompanyName" class="font-weight-bold text-primary"> 거래처 </label> {{ form.saleCompanyName }}
                </div>
                <div class="col-6 mb-3">
                  <label for="saleCustomerId" class="font-weight-bold text-primary"> 거래처 담당자 </label> {{ form.saleCustomerId }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-6  mb-3">
                  <label for="endCompanyName" class="font-weight-bold text-primary"> 최종고객사 </label> {{ form.endCompanyName }}
                </div>
                <div class="col-6 mb-3">
                  <label for="endCustomerId" class="font-weight-bold text-primary"> 최종고객사 담당자 </label> {{ form.endCustomerId }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictSalePrice" class="font-weight-bold text-primary"> 예상계약금액(원) </label> {{ form.predictSalePrice }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictProfitPrice" class="font-weight-bold text-primary"> 예상이익금액(원) </label> {{ form.predictProfitPrice }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictProfitRatio" class="font-weight-bold text-primary"> 예상이익율(%) </label> {{ form.predictProfitRatio }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictContractDate" class="font-weight-bold text-primary"> 예상계약일 </label> {{ form.predictContractDate }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="Firm" class="d-none">
              <hr class="divider">
              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="salePrice" class="font-weight-bold text-primary"> 계약금액(원) </label> {{ form.salePrice }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="profitPrice" class="font-weight-bold text-primary"> 이익금액(원) </label> {{ form.profitPrice }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="profitRatio" class="font-weight-bold text-primary"> 이익율(%) </label> {{ form.profitRatio }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="contractDate" class="font-weight-bold text-primary"> 계약일 </label> {{ form.contractDate }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictSalePrice" class="font-weight-bold text-primary"> 계약시작일 </label> {{ form.contractStartDate }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictProfitPrice" class="font-weight-bold text-primary"> 계약종료일 </label> {{ form.contractEndDate }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  여기에 안내문구 같은 것 작성<br>단계변경시 값 초기화 로직에 Datatable 추가해야 됨.
                </div>
              </div>
              <div class="form-group row">
                여기에 category Datatable
              </div>
            </div>

            <div class="text-center">
              <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_cancel()">
                <span class="icon text-white-50"> <i class="fas fa-times"> </i> </span>
                <span class="text"> 취소 </span>
              </a>
              <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
                <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
                <span class="text"> 저장 </span>
              </a>
            </div>
          </form>
        </div>

      </div>
    </div>

    <div class="col-xl-2"></div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function btn_cancel() {
          if (confirm("취소 하시겠습니까?") === true) {
              history.back();
          } else {
              return false;
          }
      }

      function btn_save() {
          if (confirm("저장 하시겠습니까?") === true) {
              document.getElementById("ContractForm").submit();
          }
      }

      function changeCompany(saleCompanyName,selectId) {
          $.ajax({
              url: "{% url 'sales:salemanager_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"saleCompanyName": saleCompanyName},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var salecompany = returnData;
                  $('#'+selectId).empty();

                  for (var count = 0; count < salecompany.length; count++) {
                      var option = $("<option value="+salecompany[count].pk+">" + salecompany[count].fields.customerName + "</option>");
                      $('#'+selectId).append(option);
                  }
              }
          })
      }

      $(document).ready(function () {
          $('#predictSalePrice').on("propertychange change keyup paste input", function () {
              const predictSalePrice = $('#predictSalePrice').val();
              const predictProfitPrice = $('#predictProfitPrice').val();
              $('#predictProfitRatio').val(((predictProfitPrice / predictSalePrice) * 100).toFixed(1));
          });

          $('#predictProfitPrice').on("propertychange change keyup paste input", function () {
              const predictSalePrice = $('#predictSalePrice').val();
              const predictProfitPrice = $('#predictProfitPrice').val();
              $('#predictProfitRatio').val(((predictProfitPrice / predictSalePrice) * 100).toFixed(1));
          });

          $('#salePrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val();
              const profitPrice = $('#profitPrice').val();
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          $('#profitPrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val();
              const profitPrice = $('#profitPrice').val();
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          $('#contractStep').on("propertychange change keyup paste input", function () {
              const contractStep = $('#contractStep').val();
              if (contractStep === 'Firm') {
                  $('#Firm').removeClass('d-none');
              }
              else {
                  $('#Firm').addClass('d-none');
                  $('#salePrice').val('');
                  $('#profitPrice').val('');
                  $('#profitRatio').val('');
                  $('#contractDate').val('');
                  $('#contractStartDate').val('');
                  $('#contractEndDate').val('');
              }
          });
      })

  </script>

{% endblock %}