{% extends "dashboard/layout.html" %}


{% block title %}
  영업관리
{% endblock %}


{% block css %}

  <style type="text/css">
    .input-form {
      border: 1px solid #d1d3e2;
      border-radius: .35rem;
      padding: .375rem .75rem;
      font-size: 0.9em;
      color: #6e707e;
      width: 170px;
    }

    .td-img {
      max-width: 40%;
      height: auto;
    }

    .flow-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .flow-table td, .flow-table th {
      padding: 5px 15px;
      text-align: center;
      vertical-align: middle;
      font-size: 17px;
      border-top: 0px dotted #858796a3;
    }

    .dataTable td {
      padding: 10px;
    }

  </style>

{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-12">
      <div class="card shadow mb-4">

        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 영업기회 및 계약 등록 </h6>
          <div class="dropdown no-arrow">
            <a class="dropdown-toggle mr-2" href="#" role="button" id="customerLink" data-toggle="modal" data-target="#customerModal">
              <i class="fas fa-user-edit text-success"></i>
            </a>
            <a class="dropdown-toggle" href="#" role="button" id="companyLink" data-toggle="modal" data-target="#companyModal">
              <i class="fas fa-city text-warning"></i>
            </a>
          </div>
        </div>

        <div class="card-body">
          <form id="ContractForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <h5 class="text-dark mb-3"><b>
              <span id="OpportunityDown" onclick="downClick('Opportunity', 'OpportunityUp', 'OpportunityDown')">▼</span>
              <span id="OpportunityUp" class="d-none" onclick="upClick('Opportunity', 'OpportunityUp', 'OpportunityDown')">▶</span>
              계약내용
            </b></h5>
            <div id="Opportunity">
              <div class="form-group row">
                <div class="col-2 mb-3">
                  <label for="saleType" class="font-weight-bold text-primary">관리번호</label> {{ form.contractCode }}
                </div>
                <div class="col-10 mb-3">
                  <label for="contractName" class="font-weight-bold text-primary">계약명</label> {{ form.contractName }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-2 mb-3">
                  <label for="empId" class="font-weight-bold text-primary">담당자</label> {{ form.empId }}
                </div>
                <div class="col-2 mb-3">
                  <label for="saleType" class="font-weight-bold text-primary">계약유형</label> {{ form.saleType }}
                </div>
                <div class="col-2 mb-3">
                  <label for="saleIndustry" class="font-weight-bold text-primary">종류</label> {{ form.saleIndustry }}
                </div>
                <div class="col-2 mb-3">
                  <label for="saleCompanyNames" class="font-weight-bold text-primary">거래처(발주처)</label> {{ form.saleCompanyNames }}
                </div>
                <div class="col-2 mb-3">
                  <label for="saleCustomerId" class="font-weight-bold"> 거래처 담당자 </label> {{ form.saleCustomerId }}
                </div>
                 <div class="col-2 mb-3">
                  <label for="saleTaxCustomerId" class="font-weight-bold"> 거래처 세금담당자 </label> {{ form.saleTaxCustomerId }}
                </div>
                <div class="col-2 mb-3 d-none">
                  <label for="endCompanyNames" class="font-weight-bold"> 최종고객사 </label> {{ form.endCompanyNames }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-2 mb-3">
                  <label for="salePrice" class="font-weight-bold text-primary">계약금액 (원) </label> {{ form.salePrice }}
                </div>
                <div class="col-2 mb-3">
                  <label for="profitPrice" class="font-weight-bold text-primary">이익금액 (원) </label> {{ form.profitPrice }}
                </div>
                <div class="col-2 mb-3">
                  <label for="profitRatio" class="font-weight-bold">이익율 (%) </label> {{ form.profitRatio }}
                </div>
                <div class="col-2 mb-3">
                  <label for="contractDate" class="font-weight-bold text-primary">계약일</label> {{ form.contractDate }}
                </div>
                <div class="col-2 mb-3">
                  <label for="contractStartDate" class="font-weight-bold">착수일</label> {{ form.contractStartDate }}
                </div>
                <div class="col-2 mb-3">
                  <label for="contractEndDate" class="font-weight-bold">준공일</label> {{ form.contractEndDate }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-2">
                  <label for="depositCondition" class="font-weight-bold text-primary"> 수금조건 </label> {{ form.depositCondition }}
                </div>
                <div class="col-2">
                  <label for="depositConditionDay" class="font-weight-bold text-primary"> 수금조건일자 </label> {{ form.depositConditionDay }}
                </div>
                <div class="col-8">
                  <label for="comment" class="font-weight-bold"> 참고사항 </label> {{ form.comment }}
                </div>
              </div>
            </div>

            <hr class="divider">
            <div>
              <div class="col-xl-12 pl-0">
                <h5 class="text-dark mb-3"><b>▼ 매출 세부사항</b></h5>
                <table id="categoryItem" class="display" style="width:100%">
                  <thead style="width:100%">
                  <tr>
                    <th>구분</th>
                    <th class="font-weight-bold text-primary">매출처 <i class="fas fa-angle-double-down" onclick="changeRevenueCompany('revenueCategoryCompany')"></i></th>
                    <th class="font-weight-bold text-primary">대분류
                      {% if user.is_staff %}
                      <a class="text-white" href="#" role="button" id="categoryLink" data-toggle="modal" data-target="#categoryModal">
                        <i class="fas fa-plus-circle fa-fw text-info"></i>
                      </a>
                      {% endif %}
                    </th>
                    <th class="font-weight-bold text-primary">소분류</th>
                    <th>상세내용</th>
                    <th class="font-weight-bold text-primary">공급가액</th>
                    <th class="font-weight-bold text-primary">부가세</th>
                    <th class="font-weight-bold text-primary">합계금액</th>
                    <th><i id="addItem" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                  </tr>
                  </thead>
                  <tfoot>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th class="text-right">TOTAL : </th>
                    <th><span class="totalItemPrice"></span></th>
                    <th><span class="totalItemVatPrice"></span></th>
                    <th><span class="totalItemTotalPrice"></span></th>
                    <th></th>
                  </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div id="revenuediv">
              <hr class="divider">
              <h5 class="text-dark mb-3"><b>▼ 매출 빌링스케줄</b>
                <a class="text-white" href="#" role="button" id="revenuesLink" data-toggle="modal" data-target="#billingRevenueModal">
                  <i class="fas fa-divide text-danger"></i>
                </a>
              </h5>
              <table id="revenue" class="display" style="width:100%">
                <thead style="width:100%">
                <tr>
                  <th>구분</th>
                  <th class="font-weight-bold text-primary">매출예정일</th>
                  <th>매출일</th>
                  <th>수금예정일</th>
                  <th>수금일</th>
                  <th class="font-weight-bold text-primary">매출처 <i class="fas fa-angle-double-down" onclick="changeRevenueCompany('revenueCompany')"></i></th>
                  <th class="font-weight-bold text-primary">매출금액</th>
                  <th class="font-weight-bold text-primary">이익금액</th>
                  <th>비고</th>
                  <th><i id="addRevenue" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th>TOTAL :</th>
                  <th><span class="totalRevenuePrice"></span></th>
                  <th><span class="totalRevenueProfitPrice"></span></th>
                  <th></th>
                  <th></th>
                </tr>
                </tfoot>
              </table>
            </div>

            <hr class="divider">
            <div>
              <div class="col-xl-12 pl-0">
                <h5 class="text-dark mb-3"><b>▼ 매입 세부사항</b></h5>
                <table id="purchaseCategoryItem" class="display" style="width:100%">
                  <thead style="width:100%">
                  <tr>
                    <th>구분</th>
                    <th>매입처</th>
                    <th class="font-weight-bold text-primary">대분류
                      {% if user.is_staff %}
                      <a class="text-white" href="#" role="button" id="classificationModalLink" data-toggle="modal" data-target="#classificationModal">
                        <i class="fas fa-plus-circle fa-fw text-info"></i>
                      </a>
                      {% endif %}
                    </th>
                    <th class="font-weight-bold text-primary">소분류</th>
                    <th>상세내용</th>
                    <th class="font-weight-bold text-primary">공급가액</th>
                    <th class="font-weight-bold text-primary">부가세</th>
                    <th class="font-weight-bold text-primary">합계금액</th>
                    <th><i id="purchaseAddItem" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                  </tr>
                  </thead>
                  <tfoot>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th class="text-right">TOTAL : </th>
                    <th><span class="totalpurchaseItemPrice"></span></th>
                    <th><span class="totalpurchaseItemVatPrice"></span></th>
                    <th><span class="totalpurchaseItemTotalPrice"></span></th>
                    <th></th>
                  </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div id="purchasediv">
              <hr class="divider">
              <h5 class="text-dark mb-3"><b>▼ 매입 빌링스케줄</b></h5>
              <h5 class="text-dark mb-3"><b>&nbsp;&nbsp;&nbsp;(세금계산서 접수항목)</b>
                <a class="text-white" href="#" role="button" id="purchasesLink" data-toggle="modal" data-target="#billingPurchaseModal">
                  <i class="fas fa-divide text-danger"></i>
                </a>
              </h5>
              <table id="purchase" class="display" style="width:100%">
                <thead style="width:100%">
                <tr>
                  <th>구분</th>
                  <th class="font-weight-bold text-primary">매입예정일</th>
                  <th>매입일</th>
                  <th>지급예정일</th>
                  <th>지급일</th>
                  <th class="font-weight-bold text-primary">매입처</th>
                  <th class="font-weight-bold text-primary">매입금액</th>
                  <th>비고</th>
                  <th><i id="addPurchase" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th>TOTAL : </th>
                  <th><span class="totalPurchasePrice"></span></th>
                  <th></th>
                  <th></th>
                </tr>
                </tfoot>
              </table>
            </div>

            <div id="costdiv">
              <hr class="divider">
              <h5 class="text-dark mb-3"><b>&nbsp;&nbsp;&nbsp;(세금계산서 외 기타항목)</b>
              </h5>
              <table id="cost" class="display" style="width:100%">
                <thead style="width:100%">
                <tr>
                  <th>구분</th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th class="font-weight-bold text-primary">지급일</th>
                  <th class="font-weight-bold text-primary">기타항목
                    {% if user.is_staff %}
                    <a class="text-white" href="#" role="button" id="costContentsLink" data-toggle="modal" data-target="#costContentsModal">
                      <i class="fas fa-plus-circle fa-fw text-info"></i>
                    </a>
                    {% endif %}
                  </th>
                  <th class="font-weight-bold text-primary">매입금액</th>
                  <th>비고</th>
                  <th><i id="addCost" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th></th>
                  <th>TOTAL : </th>
                  <th><span class="totalCostPrice"></span></th>
                  <th></th>
                  <th></th>
                </tr>
                </tfoot>
              </table>
            </div>

            <div class="text-center">
              <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_cancel()">
                <span class="icon text-white-50"> <i class="fas fa-times"> </i> </span>
                <span class="text"> 취소 </span>
              </a>
              <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
                <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
                <span class="text"> 저장 </span>
              </a>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- company Modal -->
  <div class="modal fade" id="companyModal" tabindex="-1" role="dialog" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-warning text-gray-100">
          <h5 class="modal-title" id="filterModalLabel">고객사 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="companyForm" onkeydown="javascript: if (event.keyCode == 13) {btn_register();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-12 mb-6 mb-sm-0">
                <label for="companyName" class="font-weight-bold text-primary">고객사 명</label>
                <input type="text" class="form-control" id="companyName" name="companyName">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="ceo" class="font-weight-bold text-secondary">대표자</label>
                <input class="form-control" id="ceo" name="ceo">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="companyNumber" class="font-weight-bold text-secondary">사업자등록번호</label>
                <input class="form-control" id="companyNumber" name="companyNumber">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="companyPhone" class="font-weight-bold text-secondary">전화번호</label>
                <input class="form-control" id="companyPhone" name="companyPhone">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="companyAddress" class="font-weight-bold text-secondary">주소</label>
                <input class="form-control" id="companyAddress" name="companyAddress">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="companyComment" class="font-weight-bold text-secondary">참고사항</label>
                <input class="form-control" id="companyComment" name="companyComment">
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-warning" href="#" onclick="btn_register()">등록</a>
        </div>
      </div>
    </div>
  </div>

  <!-- customer Modal -->
  <div class="modal fade" id="customerModal" tabindex="-1" role="dialog" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-success text-gray-100">
          <h5 class="modal-title" id="customerModalLabel">담당자등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="customerForm" onkeydown="javascript: if (event.keyCode == 13) {btn_customer();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-12">
                <label for="customerCompany" class="font-weight-bold text-primary">고객사 명</label>
                <input type="text" class="magicsearch form-control" id="customerCompany" name="customerCompany" autocomplete="off" onkeydown="magicsearchtab(customerCompany)">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12 mb-6 mb-sm-0">
                <label for="customerName" class="font-weight-bold text-primary">담당자 명</label>
                <input type="text" class="form-control" id="customerName" name="customerName">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="customerDept" class="font-weight-bold text-secondary">담당자 부서</label>
                <input class="form-control" id="customerDept" name="customerDept">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="customerPhone" class="font-weight-bold text-secondary">담당자 연락처</label>
                <input class="form-control" id="customerPhone" name="customerPhone">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="customerEmail" class="font-weight-bold text-secondary">담당자 이메일</label>
                <input class="form-control" id="customerEmail" name="customerEmail">
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-success" href="#" onclick="btn_customer()">등록</a>
        </div>
      </div>
    </div>
  </div>

  <!-- category Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="categoryModalLabel">매출 세부사항 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="categoryForm" onkeydown="javascript: if (event.keyCode == 13) {btn_category();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6">
                <label for="main" class="font-weight-bold text-primary">대분류 명</label>
                <input type="text" class="magicsearch form-control" id="main" name="main" required>
              </div>
               <div class="col-6">
                <label for="sub" class="font-weight-bold text-primary">소분류 명</label>
                <input type="text" class="magicsearch form-control" id="sub" name="sub" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_category()">등록</a>
        </div>
      </div>
    </div>
  </div>


  <!-- classification Modal -->
  <div class="modal fade" id="classificationModal" tabindex="-1" role="dialog" aria-labelledby="classificationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="classificationModalLabel">매입 세부사항 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="classificationForm" onkeydown="javascript: if (event.keyCode == 13) {btn_purchasecategory();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6">
                <label for="main" class="font-weight-bold text-primary">대분류 명</label>
                <input type="text" class="form-control" name="main" id="purchasemain" required>
              </div>
               <div class="col-6">
                <label for="sub" class="font-weight-bold text-primary">소분류 명</label>
                <input type="text" class="form-control" name="sub" id="purchasesub" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_purchasecategory()">등록</a>
        </div>
      </div>
    </div>
  </div>


  <!-- costContents Modal -->
  <div class="modal fade" id="costContentsModal" tabindex="-1" role="dialog" aria-labelledby="costContentsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="costContentsModalLabel">매입내역 항목 등록</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="costContentsForm" onkeydown="javascript: if (event.keyCode == 13) {btn_costContents();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-12">
                <label for="costContents" class="font-weight-bold text-primary">매입항목 명</label>
                <input type="text" class="magicsearch form-control" id="costContents" name="costContents" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_costContents()">등록</a>
        </div>
      </div>
    </div>
  </div>

  <!-- billingRevenue Modal -->
  <div class="modal fade" id="billingRevenueModal" tabindex="-1" role="dialog" aria-labelledby="billingRevenueModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-danger text-gray-100">
          <h5 class="modal-title" id="billingRevenueModalLabel">매출 빌링스케줄 생성</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="billingRevenueForm" onkeydown="javascript: if (event.keyCode == 13) {btn_billing('revenue');}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-12">
                <label for="billingRevenueCompanyName" class="font-weight-bold text-primary">회사 명</label>
                <input type="text" class="magicsearch form-control" autocomplete="off" id="billingRevenueCompanyName" name="billingRevenueCompanyName"
                       onkeydown="magicsearchtab(billingRevenueCompanyName)">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-6">
                <label for="billingRevenueDate" class="font-weight-bold text-primary">빌링 시작 월</label>
                <input type="month" max="9999-12" class="form-control" id="billingRevenueDate" name="billingRevenueDate" required>
              </div>
              <div class="col-6">
                <label for="billingRevenueTimes" class="font-weight-bold text-primary">분할 횟수</label>
                <input type="number" class="form-control" max="100" id="billingRevenueTimes" name="billingRevenueTimes" required>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-6">
                <label for="billingRevenuePrice" class="font-weight-bold text-primary">매출 금액</label>
                <input type="number" class="form-control" id="billingRevenuePrice" name="billingRevenuePrice" required>
              </div>
              <div class="col-6">
                <label for="billingRevenueProfit" class="font-weight-bold text-primary">이익 금액</label>
                <input type="number" class="form-control" id="billingRevenueProfit" name="billingRevenueProfit" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-danger" href="#" onclick="btn_billing('revenue')">생성</a>
        </div>
      </div>
    </div>
  </div>

  <!-- billingPurchase Modal -->
  <div class="modal fade" id="billingPurchaseModal" tabindex="-1" role="dialog" aria-labelledby="billingPurchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-danger text-gray-100">
          <h5 class="modal-title" id="billingPurchaseModalLabel">매입(세금계산서접수) 빌링스케줄 생성</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="billingPurchaseForm" onkeydown="javascript: if (event.keyCode == 13) {btn_billing('purchase');}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6">
                <label for="billingPurchaseCompanyName" class="font-weight-bold text-primary">회사 명</label>
                <input type="text" class="magicsearch form-control" autocomplete="off" id="billingPurchaseCompanyName" name="billingPurchaseCompanyName"
                       onkeydown="magicsearchtab(billingPurchaseCompanyName)">
              </div>
              <div class="col-6">
                <label for="billingPurchaseDate" class="font-weight-bold text-primary">빌링 시작 월</label>
                <input type="month" max="9999-12" class="form-control" id="billingPurchaseDate" name="billingPurchaseDate" required>
              </div>
              <div class="col-6">
                <label for="billingPurchasePrice" class="font-weight-bold text-primary">매입 금액</label>
                <input type="number" class="form-control" id="billingPurchasePrice" name="billingPurchasePrice" required>
              </div>
              <div class="col-6">
                <label for="billingPurchaseTimes" class="font-weight-bold text-primary">분할 횟수</label>
                <input type="number" class="form-control" max="100" id="billingPurchaseTimes" name="billingPurchaseTimes" required>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-danger" href="#" onclick="btn_billing('purchase')">생성</a>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">
      var revenueCounter = 0;
      var purchaseCounter = 0;
      var itemCounter = 0;
      var costCounter = 0;
      var purchaseItemCounter = 0;
      var supportInternalCounter = 0;
      var supportExternalCounter = 0;
      var othersCounter = 0;
      var value = "";
      var resultcompanyName;
      var resultcompanyNameKo;
      var companyList = {{ companyNames|safe }};
      var saleCompanyList = {{ saleCompanyLists|safe }};
      var purchaseCompanyList = {{ purchaseCompanyLists|safe }};

      function magicsearchtab(input) {
          console.log(input);
          value = $(input).attr('data-id');
          $(input).blur(function() {
              if (value !== "") {
                  console.log(value);
                  $(input).trigger('set', {id: value});
              }
          });
      }

      function btn_cancel() {
          if (confirm("취소 하시겠습니까?") === true) {
              history.back();
          } else {
              return false;
          }
      }

      function btn_register() {

          const companyName = document.getElementById("companyName").value;
          const ceo = document.getElementById("ceo").value;
          const companyNumber = document.getElementById("companyNumber").value;
          const companyPhone = document.getElementById("companyPhone").value;
          const companyAddress = document.getElementById("companyAddress").value;
          const companyComment = document.getElementById("companyComment").value;

          if (document.getElementById("companyName").value === '') {
              alert("고객사 명을 입력해주세요.");
              return false;
          }
          $.ajax({
              url: "{% url 'sales:savecompany' %}",
              method: 'POST',
              cache: false,
              data: {
                  "companyName": companyName,
                  "ceo": ceo,
                  "companyNumber": companyNumber,
                  "companyPhone": companyPhone,
                  "companyAddress": companyAddress,
                  "companyComment": companyComment,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 고객사입니다.');
                      companyList ={{ companyNames|safe }};
                  } else if (returnData[0] == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');
                      resultcompanyName = returnData[1];
                      resultcompanyNameKo = returnData[2];
                      companyList.push({id: resultcompanyName, value: resultcompanyNameKo});
                      replaceMagic();
                  }
              }
          });
      }

      function btn_customer() {
          const customerCompany = $("#customerCompany").attr('data-id');
          const customerName = document.getElementById("customerName").value;
          const customerDept = document.getElementById("customerDept").value;
          const customerPhone = document.getElementById("customerPhone").value;
          const customerEmail = document.getElementById("customerEmail").value;

          if (customerCompany === '') {
              alert("고객사 명을 선택해주세요.");
              return false;
          }

          if (customerName === '') {
              alert("담당자 명 입력해주세요.");
              return false;
          }

          $.ajax({
              url: "{% url 'sales:savecustomer' %}",
              method: 'POST',
              cache: false,
              data: {
                  "customerCompany": customerCompany,
                  "customerName": customerName,
                  "customerDept": customerDept,
                  "customerPhone": customerPhone,
                  "customerEmail": customerEmail
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 고객입니다.');
                  } else if(returnData == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');

                      $.ajax({
                      url: "{% url 'sales:salemanager_ajax_url' %}",
                      method: 'POST',
                      cache: false,
                      data: {"saleCompanyName": customerCompany},
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      success: function (returnData) {
                          const saleCompanyNames =  $('#saleCompanyNames');
                          saleCompanyNames.trigger('set',{id: customerCompany});

                          var salecompany = returnData;
                          // 판매 유형
                          const saleType = $("#saleType").val();
                          if(saleType == '직판'){
                              // 최종 고객사 명
                              const endCompanyNames = $('#endCompanyNames');
                              endCompanyNames.trigger('set',{id: customerCompany});
                          }
                          $('#saleCustomerId').empty();
                          $('#saleCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleCustomerId').append(option);
                          }
                          $('#saleTaxCustomerId').empty();
                          $('#saleTaxCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleTaxCustomerId').append(option);
                          }
                      }
                    });
                  }
              }
          });
      }

      function btn_category(){
          const mainCategory = document.getElementById("main").value;
          const subCategory = document.getElementById("sub").value;

          if (mainCategory === '') {
              alert("대분류 명을 입력해주세요.");
              return false;
          }

          if (subCategory === '') {
              alert("소분류 명을 입력해주세요.");
              return false;
          }

          $.ajax({
              url: "{% url 'sales:savecategory' %}",
              method: 'POST',
              cache: false,
              data: {
                  "mainCategory": mainCategory,
                  "subCategory": subCategory,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 세부사항입니다.');
                  } else if(returnData == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');
                      for (var count = 0; count < itemCounter; count++) {
                          var exists = false;
                          $('#item1'+count+' option').each(function(){
                              if (this.value == mainCategory ) {
                                  console.log(this.value);
                                  exists = true;
                                  return false;
                              }
                          });
                          console.log(exists);
                          if(exists==false){
                              const option = $("<option value=" + mainCategory + ">" + mainCategory + "</option>");
                              $('#item1'+count).append(option);
                          }
                      }
                  }
              }
          });
      }

      function btn_purchasecategory(){
          const mainCategory = document.getElementById("purchasemain").value;
          const subCategory = document.getElementById("purchasesub").value;

          if (mainCategory === '') {
              alert("대분류 명을 입력해주세요.");
              return false;
          }

          if (subCategory === '') {
              alert("소분류 명을 입력해주세요.");
              return false;
          }

          $.ajax({
              url: "{% url 'sales:savepurchasecategory' %}",
              method: 'POST',
              cache: false,
              data: {
                  "mainCategory": mainCategory,
                  "subCategory": subCategory,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 세부사항입니다.');
                  } else if(returnData == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');
                      for (var count = 0; count < purchaseItemCounter; count++) {
                          var exists = false;
                          $('#purchaseItem2'+count+' option').each(function(){
                              if (this.value == mainCategory ) {
                                  console.log(this.value);
                                  exists = true;
                                  return false;
                              }
                          });
                          console.log(exists);
                          if(exists==false){
                              const option = $("<option value=" + mainCategory + ">" + mainCategory + "</option>");
                              $('#purchaseItem2'+count).append(option);
                          }
                      }
                  }
              }
          });
      }

      function btn_costContents(){
          const costContents = document.getElementById("costContents").value;

          if (costContents === '') {
              alert("매입항목 명을 입력해주세요.");
              return false;
          }

          $.ajax({
              url: "{% url 'sales:saveclassification' %}",
              method: 'POST',
              cache: false,
              data: {
                  "classification": "매입_미접수",
                  "categoryName": costContents,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 매입항목입니다.');
                  } else if(returnData == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');
                      console.log(costCounter);
                      for (var count = 0; count < costCounter; count++) {
                          var exists = false;
                          $('#cost5'+count+' option').each(function(){
                              if (this.value == costContents ) {
                                  console.log(this.value);
                                  exists = true;
                                  return false;
                              }
                          });
                          console.log(exists);
                          if(exists==false){
                              const option = $("<option value=" + costContents + ">" + costContents + "</option>");
                              $('#cost5'+count).append(option);
                          }
                      }
                  }
              }
          });
      }

      function btn_classification(classification){
          console.log(classification);
          let categoryName = '';
          if(classification =="classificationB"){
               categoryName = document.getElementById("classificationB").value;

          }else if(classification =="classificationC1")
          {
               categoryName = document.getElementById("classificationC1").value;
          }else if(classification =="classificationC2")
          {
               categoryName = document.getElementById("classificationC2").value;
          }

          if (categoryName === '') {
              alert("구분항목 명을 입력해주세요.");
              return false;
          }
          $.ajax({
              url: "{% url 'sales:saveclassification' %}",
              method: 'POST',
              cache: false,
              data: {
                  "classification": classification,
                  "categoryName": categoryName,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  if (returnData == 'N') {
                      alert('이미 등록된 구분 항목입니다.');
                  } else if(returnData == 'Y') {
                      $('.close').click();
                      alert('등록이 완료되었습니다.');
                      if(classification =="classificationB"){
                          for (var count = 0; count < supportInternalCounter; count++) {
                              var exists = false;
                              $('#supportInternal1'+count+' option').each(function(){
                                  if (this.value == categoryName ) {
                                      exists = true;
                                      return false;
                                  }
                              });
                              if(exists==false){
                                  const option = $("<option value=" + categoryName + ">" + categoryName + "</option>");
                                  $('#supportInternal1'+count).append(option);
                              }
                          }
                      }else if(classification =="classificationC1") {
                          for (var count = 0; count < supportExternalCounter; count++) {
                              var exists = false;
                              $('#supportExternal1'+count+' option').each(function(){
                                  if (this.value == categoryName ) {
                                      exists = true;
                                      return false;
                                  }
                              });
                              if(exists==false){
                                  const option = $("<option value=" + categoryName + ">" + categoryName + "</option>");
                                  $('#supportExternal1'+count).append(option);
                              }
                          }
                      }else if(classification =="classificationC2") {
                          for (var count = 0; count < othersCounter; count++) {
                              var exists = false;
                              $('#others1'+count+' option').each(function(){
                                  if (this.value == categoryName ) {
                                      exists = true;
                                      return false;
                                  }
                              });
                              if(exists==false){
                                  const option = $("<option value=" + categoryName + ">" + categoryName + "</option>");
                                  $('#others1'+count).append(option);
                              }
                          }
                      }
                  }
              }
          });
      }

      function btn_billing(classification){
          let company = '';
          let date = '';
          let times = '';
          let price = '';
          let profit = 0;
          if(classification =="revenue"){
               company = document.getElementById("billingRevenueCompanyName").value;
               date = document.getElementById("billingRevenueDate").value;
               times = document.getElementById("billingRevenueTimes").value;
               price = document.getElementById("billingRevenuePrice").value;
               profit = document.getElementById("billingRevenueProfit").value;

          }else if(classification =="purchase") {
              company = document.getElementById("billingPurchaseCompanyName").value;
              date = document.getElementById("billingPurchaseDate").value;
              price = document.getElementById("billingPurchasePrice").value;
              times = document.getElementById("billingPurchaseTimes").value;
          }

          if (company == '') {
              alert("회사 명을 입력해주세요.");
              return false;
          }
          if (date == '') {
              alert("예상 빌링 시작일을 입력해주세요.");
              return false;
          }
          if (times == '') {
              alert("분할 횟수를 입력해주세요.");
              return false;
          }else{
              if(times > 100){
                  alert("분할 횟수가 100을 초과하였습니다.");
                  return false;
              }
          }
          if (price == '') {
              alert("금액을 입력해주세요.");
              return false;
          }

          $.ajax({
              url: "{% url 'sales:calculatebilling' %}",
              method: 'POST',
              cache: false,
              data: {
                  "company": company,
                  "date": date,
                  "times": times,
                  "price": price,
                  "profit": profit,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  const status = returnData[0].result;
                  const data = returnData[1];
                  console.log('status:',status);
                  console.log('data:',data);
                  if (status == 'N') {
                      alert('오류가 발생했습니다 관리자에게 문의하세요 :)');
                  } else if(status == 'Y') {
                      $('.close').click();
                      if(classification =="revenue"){
                          if(revenueCounter==1 & $('#revenue10').val()== '') {
                              for (var count = 0; count < data.length; count++) {
                                  console.log(count);
                                  if (count != data.length - 1) {
                                      $('#addRevenue').click();
                                  }
                                  console.log(data[count]);
                                  setInterval(10);
                                  $('#revenue1' + count).attr('value', data[count].date);
                                  $('#revenue5' + count).trigger('set', {id: data[count].company});
                                  $('#revenue6' + count).val(data[count].price.toLocaleString());
                                  $('#revenue7' + count).val(data[count].profit.toLocaleString());
                              }
                              totalPrice('revenuePrice', 'totalRevenuePrice');
                              totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');
                          }else{
                                for (var count = 0; count < data.length; count++) {
                                    $('#addRevenue').click();
                                    const i = revenueCounter-1;
                                    console.log(i);
                                    setInterval(10);
                                    $('#revenue1' + i).attr('value', data[count].date);
                                    $('#revenue5' + i).trigger('set', {id: data[count].company});
                                    $('#revenue6' + i).val(data[count].price.toLocaleString());
                                    $('#revenue7' + i).val(data[count].profit.toLocaleString());
                                }
                                totalPrice('revenuePrice', 'totalRevenuePrice');
                                totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');

                          }
                      }else if(classification =="purchase") {
                          if (purchaseCounter == 1 & $('#purchase10').val() == '') {
                              for (var count = 0; count < data.length; count++) {
                                  console.log(count);
                                  if (count != data.length - 1) {
                                      $('#addPurchase').click();
                                  }
                                  console.log(data[count]);
                                  $('#purchase1' + count).attr('value', data[count].date);
                                  $('#purchase5' + count).trigger('set', {id: data[count].company});
                                  $('#purchase6' + count).val(data[count].price.toLocaleString());
                              }
                              totalPrice('purchasePrice', 'totalPurchasePrice');
                          } else {
                              for (var count = 0; count < data.length; count++) {
                                  $('#addPurchase').click();
                                  const i = purchaseCounter - 1;
                                  console.log(i);
                                  $('#purchase1' + i).attr('value', data[count].date);
                                  $('#purchase5' + i).trigger('set', {id: data[count].company});
                                  $('#purchase6' + i).val(data[count].price.toLocaleString());
                              }
                              totalPrice('purchasePrice', 'totalPurchasePrice');
                          }
                      }
                  }
              }
          });
      }

      function replaceMagic() {
          $('#saleCompanyNames').magicsearch({
              dataSource: saleCompanyList,
              fields: 'value',
              id: 'id',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
              success: function ($input, data) {
                  $.ajax({
                      url: "{% url 'sales:salemanager_ajax_url' %}",
                      method: 'POST',
                      cache: false,
                      data: {"saleCompanyName": data.id},
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      success: function (returnData) {
                          console.log(data.id);
                          var salecompany = returnData;
                          // 판매 유형
                          const saleType = $("#saleType").val();
                          if(saleType == '직판'){
                              // 최종 고객사 명
                              const endCompanyNames = $('#endCompanyNames');
                              endCompanyNames.trigger('set',{id: data.id});
                          }
                          $('#saleCustomerId').empty();
                          $('#saleCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleCustomerId').append(option);
                          }
                          $('#saleTaxCustomerId').empty();
                          $('#saleTaxCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleTaxCustomerId').append(option);
                          }
                      }
                  });
              }
          });

          var lengthrevenueCompany = $('[name="revenueCompany"]').length;
          var lengthpurchaseCompany = $('[name="purchaseCompany"]').length;

          for (var i = 0; i < lengthrevenueCompany; i++) {
              $('#revenue5' + i).magicsearch({
                  dataSource: saleCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
              });
          }

          for (var j = 0; j < lengthpurchaseCompany; j++) {
              $('#purchase5' + j).magicsearch({
                  dataSource: purchaseCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
              });
          }
      }

      function btn_false(msg) {
          alert(msg);
          $('.money').simpleMoneyFormat();
          return false;
      }

      function btn_save() {
          if (document.getElementById("empId").value === '') {
              alert("영업대표를 입력해주세요.");
              return false;
          }
          if (document.getElementById("contractName").value === '') {
              alert("계약명을 입력해주세요.");
              return false;
          }
          if (document.getElementById("saleCompanyNames").value === '') {
              alert("거래처를 입력해주세요.");
              return false;
          }
          if (document.getElementById("salePrice").value === '') {
              alert("계약금액을 입력해주세요.");
              return false;
          }
          if (document.getElementById("profitPrice").value === '') {
              alert("이익금액을 입력해주세요.");
              return false;
          }
          if (document.getElementById("depositCondition").value === '') {
              alert("수금조건을 입력해주세요.");
              return false;
          }
          if (document.getElementById("depositConditionDay").value === '') {
              alert("수금조건일자를 입력해주세요.");
              return false;
          }
          if (!isDay(document.getElementById("contractDate").value)) {
              alert("유효한 계약일을 입력해주세요.\n(정확한 입력을 위해 달력에서 선택해 주세요.)");
              return false;
          }

          moneyChange();

          const ContractForm = document.getElementById("ContractForm");

          // 매출 세부사항
          const lengthItem = $('[name="itemId"]').length;
          const listItem = new Array();
          for (var i = 0; i <= lengthItem - 1; i++) {
              if ($('input[name="revenueCategoryCompany"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 매출처를 입력해주세요.");
              }
              if ($('select[name="mainCategory"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 대분류를 입력해주세요.");
              }
              if ($('select[name="subCategory"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 소분류를 입력해주세요.");
              }
              if ($('input[name="itemPrice"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 공급가액을 입력해주세요.");
              }
              if ($('input[name="itemVatPrice"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 부가세를 입력해주세요.");
              }
              if ($('input[name="itemTotalPrice"]').eq(i).val() == '') {
                  return btn_false("매출 세부사항의 합계금액을 입력해주세요.");
              }
              var data = new Object();
              data.itemId = $('div[name="itemId"]').eq(i).text();
              data.revenueCategoryCompany = $('input[name="revenueCategoryCompany"]').eq(i).val();
              data.mainCategory = $('select[name="mainCategory"]').eq(i).val();
              data.subCategory = $('select[name="subCategory"]').eq(i).val();
              data.itemName = $('input[name="itemName"]').eq(i).val();
              data.itemPrice = $('input[name="itemPrice"]').eq(i).val();
              data.itemVatPrice = $('input[name="itemVatPrice"]').eq(i).val();
              data.itemTotalPrice = $('input[name="itemTotalPrice"]').eq(i).val();
              listItem.push(data);
          }
          const jsonItem = JSON.stringify(listItem);
          const item = document.createElement("input");
          item.setAttribute("type", "hidden");
          item.setAttribute("name", "jsonItem");
          item.setAttribute("value", jsonItem);
          ContractForm.appendChild(item);

          // 매출 빌링스케줄
          const lengthRevenue = $('[name="revenueId"]').length;
          const listRevenue = new Array();
          for (var i = 0; i <= lengthRevenue - 1; i++) {
              if ($('input[name="predictBillingDate"]').eq(i).val() == '') {
                  return btn_false("매출세부정보의 매출예정일을 입력해주세요.");
              }
              if ($('input[name="revenueCompany"]').eq(i).val() == '') {
                  return btn_false("매출세부정보의 매출처를 입력해주세요.")
              }
              if ($('input[name="revenuePrice"]').eq(i).val() == '') {
                  return btn_false("매출세부정보의 매출금액을 입력해주세요.");
              }
              if ($('input[name="revenueProfitPrice"]').eq(i).val() == '') {
                  return btn_false("매출세부정보의 이익금액을 입력해주세요.");
              }
              var data = new Object();
              data.revenueId = $('div[name="revenueId"]').eq(i).text();
              data.predictBillingDate = $('input[name="predictBillingDate"]').eq(i).val();
              data.billingDate = $('input[name="billingDate"]').eq(i).val();
              data.predictDepositDate = $('input[name="predictDepositDate"]').eq(i).val();
              data.depositDate = $('input[name="depositDate"]').eq(i).val();
              data.revenueCompany = $('input[name="revenueCompany"]').eq(i).val();
              data.revenuePrice = $('input[name="revenuePrice"]').eq(i).val();
              data.revenueProfitPrice = $('input[name="revenueProfitPrice"]').eq(i).val();
              data.revenueComment = $('input[name="revenueComment"]').eq(i).val();
              listRevenue.push(data);
          }
          const jsonRevenue = JSON.stringify(listRevenue);
          const revenue = document.createElement("input");
          revenue.setAttribute("type", "hidden");
          revenue.setAttribute("name", "jsonRevenue");
          revenue.setAttribute("value", jsonRevenue);
          ContractForm.appendChild(revenue);

          // 매입 세부사항
          const lengthPurchaseItem = $('[name="purchaseItemId"]').length;
          const listPurchaseItem = new Array();
          for (var i = 0; i <= lengthPurchaseItem - 1; i++) {
              if ($('select[name="purchaseMainCategory"]').eq(i).val() == '') {
                  return btn_false("매입 세부사항의 대분류를 입력해주세요.");
              }
              if ($('select[name="purchaseSubCategory"]').eq(i).val() == '') {
                  return btn_false("매입 세부사항의 소분류를 입력해주세요.");
              }
              if ($('input[name="purchaseItemPrice"]').eq(i).val() == '') {
                  return btn_false("매입 세부사항의 공급가액을 입력해주세요.");
              }
              if ($('input[name="purchaseItemVatPrice"]').eq(i).val() == '') {
                  return btn_false("매입 세부사항의 부가세를 입력해주세요.");
              }
              if ($('input[name="purchaseItemTotalPrice"]').eq(i).val() == '') {
                  return btn_false("매입 세부사항의 합계금액을 입력해주세요.");
              }
              var data = new Object();
              data.purchaseItemId = $('div[name="purchaseItemId"]').eq(i).text();
              data.purchaseCategoryCompany = $('input[name="purchaseCategoryCompany"]').eq(i).val();
              data.purchaseMainCategory = $('select[name="purchaseMainCategory"]').eq(i).val();
              data.purchaseSubCategory = $('select[name="purchaseSubCategory"]').eq(i).val();
              data.purchaseItemName = $('input[name="purchaseItemName"]').eq(i).val();
              data.purchaseItemPrice = $('input[name="purchaseItemPrice"]').eq(i).val();
              data.purchaseItemVatPrice = $('input[name="purchaseItemVatPrice"]').eq(i).val();
              data.purchaseItemTotalPrice = $('input[name="purchaseItemTotalPrice"]').eq(i).val();
              listPurchaseItem.push(data);
          }
          const jsonPurchaseItem = JSON.stringify(listPurchaseItem);
          const purchaseItem = document.createElement("input");
          purchaseItem.setAttribute("type", "hidden");
          purchaseItem.setAttribute("name", "jsonPurchaseItem");
          purchaseItem.setAttribute("value", jsonPurchaseItem);
          ContractForm.appendChild(purchaseItem);

          // 매입 빌링스케줄
          const lengthPurchase = $('[name="purchaseId"]').length;
          const listPurchase = new Array();
          for (var i = 0; i <= lengthPurchase - 1; i++) {
              if ($('input[name="predictPurchaseDate"]').eq(i).val() == '') {
                  return btn_false("매입세부정보의 매입예정일 입력해주세요.");
              }
              if ($('input[name="purchaseCompany"]').eq(i).val() == '') {
                  return btn_false("매입세부정보의 매입처를 입력해주세요.");
              }
              if ($('input[name="purchasePrice"]').eq(i).val() == '') {
                  return btn_false("매입세부정보의 매입금액을 입력해주세요.");
              }
              var data = new Object();
              data.purchaseId = $('div[name="purchaseId"]').eq(i).text();
              data.predictPurchaseDate = $('input[name="predictPurchaseDate"]').eq(i).val();
              data.purchaseDate = $('input[name="purchaseDate"]').eq(i).val();
              data.predictWithdrawDate = $('input[name="predictWithdrawDate"]').eq(i).val();
              data.withdrawDate = $('input[name="withdrawDate"]').eq(i).val();
              data.purchaseCompany = $('input[name="purchaseCompany"]').eq(i).val();
              data.purchasePrice = $('input[name="purchasePrice"]').eq(i).val();
              data.purchaseComment = $('input[name="purchaseComment"]').eq(i).val();
              listPurchase.push(data);
          }
          const jsonPurchase = JSON.stringify(listPurchase);
          const purchase = document.createElement("input");
          purchase.setAttribute("type", "hidden");
          purchase.setAttribute("name", "jsonPurchase");
          purchase.setAttribute("value", jsonPurchase);
          ContractForm.appendChild(purchase);

          // 원가세부정보
          const lengthCost = $('[name="costId"]').length;
          const listCost = new Array();
          for (var i = 0; i <= lengthCost - 1; i++) {
              if ($('input[name="costDate"]').eq(i).val() == '') {
                  return btn_false("원가세부정보의 매입연도를 입력해주세요.");
              }
              if ($('input[name="costCompany"]').eq(i).val() == '') {
                  return btn_false("원가세부정보의 원가항목을 입력해주세요.");
              }
              if ($('input[name="costPrice"]').eq(i).val() == '') {
                  return btn_false("원가세부정보의 원가금액을 입력해주세요.");
              }
              var data = new Object();
              data.costId = $('div[name="costId"]').eq(i).text();
              data.costDate = $('input[name="costDate"]').eq(i).val();
              data.costCompany = $('select[name="costCompany"]').eq(i).val();
              data.costPrice = $('input[name="costPrice"]').eq(i).val();
              data.costComment = $('input[name="costComment"]').eq(i).val();
              listCost.push(data);
          }
          const jsonCost = JSON.stringify(listCost);
          const cost = document.createElement("input");
          cost.setAttribute("type", "hidden");
          cost.setAttribute("name", "jsonCost");
          cost.setAttribute("value", jsonCost);
          ContractForm.appendChild(cost);


          // 금액 일치 계산
          if ('{{ contractStep }}' !== 'Drop') {
              let salePrice = Number($('#salePrice').val().replace(/,/g, ''));
              let profitPrice = Number($('#profitPrice').val().replace(/,/g, ''));
              // sumRevenueItemPrice: 매출 세부사항의 합계금액의 합
              let sumRevenueItemTotalPrice = 0;
              for (i=0; i<$('input[name="itemTotalPrice"]').length; i++) {
                  sumRevenueItemTotalPrice += Number($('input[name="itemTotalPrice"]').eq(i).val().replace(/,/g, ''));
              }
              // sumRevenueBillingPrice: 매출 빌링스케쥴의 매출금액의 합
              let sumRevenueBillingPrice = 0;
              for (i=0; i<$('input[name="revenuePrice"]').length; i++) {
                  sumRevenueBillingPrice += Number($('input[name="revenuePrice"]').eq(i).val().replace(/,/g, ''));
              }
              // sumProfitBillingPrice: 매출 빌링스케쥴의 이익금액의 합
              let sumProfitBillingPrice = 0;
              for (i=0; i<$('input[name="revenueProfitPrice"]').length; i++) {
                  sumProfitBillingPrice += Number($('input[name="revenueProfitPrice"]').eq(i).val().replace(/,/g, ''));
              }
              // sumPurchaseItemPrice: 매입 세부사항의 합계금액의 합
              let sumPurchaseItemTotalPrice = 0;
              for (i=0; i<$('input[name="purchaseItemTotalPrice"]').length; i++) {
                  sumPurchaseItemTotalPrice += Number($('input[name="purchaseItemTotalPrice"]').eq(i).val().replace(/,/g, ''));
              }
              // sumPurchaseBillingPrice: 매입 빌링스케쥴의 매입금액의 합
              let sumPurchaseBillingPrice = 0;
              for (i=0; i<$('input[name="purchasePrice"]').length; i++) {
                  sumPurchaseBillingPrice += Number($('input[name="purchasePrice"]').eq(i).val().replace(/,/g, ''));
              }
              // sumCostBillingPrice: 매입 빌링스케쥴(세금계산서 미접수항목)의 매입금액의 합
              let sumCostBillingPrice = 0;
              for (i=0; i<$('input[name="costPrice"]').length; i++) {
                  sumCostBillingPrice += Number($('input[name="costPrice"]').eq(i).val().replace(/,/g, ''));
              }

              if (salePrice !== sumRevenueItemTotalPrice) {
                  return btn_false(
                      "계약금액 : " + salePrice.toLocaleString() + "\n" +
                      "매출 세부사항 합계금액의 합 : " + sumRevenueItemTotalPrice.toLocaleString() + "\n" +
                      "차액 : " + (salePrice - sumRevenueItemTotalPrice).toLocaleString() + "\n" +
                      "계약금액과 매출 세부사항 합계금액의 합이 일치하지 않습니다."
                  );
              }
              if (sumRevenueItemTotalPrice !== sumRevenueBillingPrice) {
                  return btn_false(
                      "매출 세부사항 합계금액의 합 : " + sumRevenueItemTotalPrice.toLocaleString() + "\n" +
                      "매출 빌링스케줄의 매출금액의 합 : " + sumRevenueBillingPrice.toLocaleString() + "\n" +
                      "차액 : " + (sumRevenueItemTotalPrice - sumRevenueBillingPrice).toLocaleString() + "\n" +
                      "매출 세부사항 합계금액의 합과 매출 빌링스케줄의 매출금액의 합이 일치하지 않습니다."
                  );
              }
              if (sumPurchaseItemTotalPrice !== (sumPurchaseBillingPrice + sumCostBillingPrice)) {
                  return btn_false(
                      "매입 세부사항의 금액의 합 : " + sumPurchaseItemTotalPrice.toLocaleString() + "\n" +
                      "매입 빌링스케쥴의 매입금액의 합 : " + (sumPurchaseBillingPrice + sumCostBillingPrice).toLocaleString() + "\n" +
                      "차액 : " + (sumPurchaseItemTotalPrice - (sumPurchaseBillingPrice + sumCostBillingPrice)).toLocaleString() + "\n" +
                      "매입 세부사항의 금액의 합과 매입 빌링스케쥴(계산서 접수항목 + 미접수항목)의 매입금액의 합이 일치하지 않습니다."
                  );
              }
          }

          if (confirm("저장 하시겠습니까?") === true) {
              ContractForm.submit();
          }
      }

      function itemChange(main, sub) {
          var selectItem = $(main).val();

          $.ajax({
              url: "{% url 'sales:category_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                  }
              }
          });
      }

      function itemChangeAdd(main, sub, subCategory, itemCounter) {
          console.log(main, sub, subCategory, itemCounter);
          if ($.type(main) === 'string') {
              main = '#' + main
          }
          if ($.type(sub) === 'string') {
              sub = '#' + sub
          }
          var selectItem = $(main).val();
          console.log(selectItem);

          $.ajax({
              url: "{% url 'sales:category_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                      $('#item2' + itemCounter).val(subCategory).prop("selected", true);
                  }
              }
          });
      }

      function purchaseItemChangeAdd(main, sub, subCategory, itemCounter) {
          console.log(main, sub, subCategory, itemCounter);
          if ($.type(main) === 'string') {
              main = '#' + main
          }
          if ($.type(sub) === 'string') {
              sub = '#' + sub
          }
          var selectItem = $(main).val();
          console.log(selectItem);

          $.ajax({
              url: "{% url 'sales:clssificaionasjson' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                      $('#purchaseItem3' + itemCounter).val(subCategory).prop("selected", true);
                  }
              }
          });
      }

      function changeRevenueCompany(objName) {
          $('input[name=' + objName + ']').trigger('set', {id: $('#saleCompanyNames').attr('data-id')});
      }

      function changeCondition() {
          if ($('#depositCondition').val() == '계산서 발행 후' || $('#depositCondition').val() == '당월' || $('#depositCondition').val() == '익월') {
              $('#depositConditionDay').removeAttr('readonly');
          } else {
              $('#depositConditionDay').val(0);
              $('#depositConditionDay').attr('readonly', '');
          }
      }

      function changeBillingDates(billingDate, predictBillingDate, predictExecutionDate) {
          const date = $('#' + billingDate).val();
          $('#' + predictBillingDate).val(date.substring(0, 7));

          if (typeof (predictExecutionDate) != 'undefined') {
              const condition = $('#depositCondition').val();
              if (condition === '당월 말') {
                  const tmld = new Date(date.substring(0, 4), date.substring(5, 7), 0);
                  $('#' + predictExecutionDate).val(date.substring(0, 8) + tmld.getDate());
              } else if (condition === '익월 초') {
                  const nmfd = new Date(date.substring(0, 4), date.substring(5, 7), 1);
                  $('#' + predictExecutionDate).val(nmfd.getFullYear() + '-' + ((nmfd.getMonth() + 1) > 9 ? '' : '0') + (nmfd.getMonth() + 1) + '-' + '01');
              } else if (condition === '익월 말') {
                  const nmld = new Date(date.substring(0, 4), date.substring(5, 7) * 1 + 1, 0);
                  $('#' + predictExecutionDate).val(nmld.getFullYear() + '-' + ((nmld.getMonth() + 1) > 9 ? '' : '0') + (nmld.getMonth() + 1) + '-' + (nmld.getDate() > 9 ? '' : '0') + nmld.getDate());
              } else if (condition === '계산서 발행 후') {
                  const aftd = new Date(date.substring(0, 4), date.substring(5, 7) * 1 - 1, date.substring(8, 10));
                  aftd.setDate(aftd.getDate() + $('#depositConditionDay').val() * 1);
                  $('#' + predictExecutionDate).val(aftd.getFullYear() + '-' + ((aftd.getMonth() + 1) > 9 ? '' : '0') + (aftd.getMonth() + 1) + '-' + (aftd.getDate() > 9 ? '' : '0') + aftd.getDate());
              } else if (condition === '당월') {
                  const tmsd = new Date(date.substring(0, 4), date.substring(5, 7) * 1 - 1, $('#depositConditionDay').val());
                  $('#' + predictExecutionDate).val(tmsd.getFullYear() + '-' + ((tmsd.getMonth() + 1) > 9 ? '' : '0') + (tmsd.getMonth() + 1) + '-' + (tmsd.getDate() > 9 ? '' : '0') + tmsd.getDate());
              } else if (condition === '익월') {
                  const nmsd = new Date(date.substring(0, 4), date.substring(5, 7) * 1, $('#depositConditionDay').val());
                  $('#' + predictExecutionDate).val(nmsd.getFullYear() + '-' + ((nmsd.getMonth() + 1) > 9 ? '' : '0') + (nmsd.getMonth() + 1) + '-' + (nmsd.getDate() > 9 ? '' : '0') + nmsd.getDate());
              }
          }
      }

      function changeExecutionDates(executionDate, predictExecutionDate) {
          const date = $('#' + executionDate).val();
          $('#' + predictExecutionDate).val(date);
      }

      function calProfit(revenueName, totalRevenueName, purchaseName, totalPurchaseName, profitName) {
          let profit;
          let revenue = 0;
          let totalRevenue = 0;
          let purchase = 0;
          let totalPurchase = 0;

          const revenueObj = $('input[name=' + revenueName + ']');
          const totalRevenueObj = $('input[name=' + totalRevenueName + ']');
          const purchaseObj = $('input[name=' + purchaseName + ']');
          const totalPurchaseObj = $('input[name=' + totalPurchaseName + ']');

          // 매출세부사항의 공급가액
          for (let i=0; i<revenueObj.length; i++) {
              revenue += Number(revenueObj.eq(i).val().replace(/,/g, ''))
          }
          // 매출세부사항의 합계금액
          for (let i=0; i<totalRevenueObj.length; i++) {
              totalRevenue += Number(totalRevenueObj.eq(i).val().replace(/,/g, ''))
          }
          // 매입세부사항의 공급가액
          for (let i=0; i<purchaseObj.length; i++) {
              purchase += Number(purchaseObj.eq(i).val().replace(/,/g, ''))
          }
          // 매입세부사항의 합계금액
          for (let i=0; i<totalPurchaseObj.length; i++) {
              totalPurchase += Number(totalPurchaseObj.eq(i).val().replace(/,/g, ''))
          }

          // 계약금액 : 매출합계금액(부가세포함)
          $('#salePrice').val(totalRevenue.toLocaleString());

          // 이익 : 매출공급가액(부가세미포함) - 매입공급가액(부가세미포함)
          profit = revenue - purchase;
          $('#profitPrice').val(profit.toLocaleString());

          if (totalRevenue === 0) {
              $('#profitRatio').val(0)
          } else {
              $('#profitRatio').val(((profit/totalRevenue)*100).toFixed(0));
          }

          // 매출별 이익 : 이익 / 매출개수
          const profitObj = $('input[name=' + profitName + ']');
          let revenueProfit = Math.floor((profit / profitObj.length));
          let adjustment = profit - (revenueProfit * profitObj.length);
          for (let i=0; i<profitObj.length; i++) {
              if (i === profitObj.length-1) {
                  profitObj.eq(i).val((revenueProfit + adjustment).toLocaleString())
              } else {
                  profitObj.eq(i).val(revenueProfit.toLocaleString())
              }
          }
          $('.totalRevenueProfitPrice').text(profit.toLocaleString());
      }

      function sumPrice() {
          let revenueItemPriceObj = $('input[name=itemPrice]');
          let revenueItemVatPriceObj = $('input[name=itemVatPrice]');
          let revenueItemTotalPriceObj = $('input[name=itemTotalPrice]');
          let purchaseItemPriceObj = $('input[name=purchaseItemPrice]');
          let purchaseItemVatPriceObj = $('input[name=purchaseItemVatPrice]');
          let purchaseItemTotalPriceObj = $('input[name=purchaseItemTotalPrice]');

          let revenueLength = revenueItemPriceObj.length;
          let purchaseLength = purchaseItemPriceObj.length;

          let revenueSumPrice;  // 매출세부사항 : 공급가액 + 부가세
          let revenueTotalPrice = 0;  // 매출세부사항 : 합계금액의 합
          for (let i=0; i<revenueLength; i++) {
              revenueSumPrice = Number(revenueItemPriceObj.eq(i).val().replace(/,/g, '')) +
                  Number(revenueItemVatPriceObj.eq(i).val().replace(/,/g, ''));
              revenueItemTotalPriceObj.eq(i).val(revenueSumPrice.toLocaleString());
              revenueTotalPrice += revenueSumPrice;
          }
          $('.totalItemTotalPrice').text(revenueTotalPrice.toLocaleString());

          let purchaseSumPrice;  // 매입세부사항 : 공급가액 + 부가세
          let purchaseTotalPrice = 0;  // 매입세부사항 : 합계금액의 합
          for (let i=0; i<purchaseLength; i++) {
              purchaseSumPrice = Number(purchaseItemPriceObj.eq(i).val().replace(/,/g, '')) +
                  Number(purchaseItemVatPriceObj.eq(i).val().replace(/,/g, ''))
              purchaseItemTotalPriceObj.eq(i).val(purchaseSumPrice.toLocaleString());
              purchaseTotalPrice += purchaseSumPrice;
          }
          $('.totalpurchaseItemTotalPrice').text(purchaseTotalPrice.toLocaleString());
      }

      function totalPrice(inputName, className) {
          let price = 0;
          for (var i = 0; i < $('input[name=' + inputName + ']').length; i++) {
              price += Number($('input[name=' + inputName + ']').eq(i).val().replace(/,/g, ''));
          }
          $('.' + className).text(price.toLocaleString());
          $('input.' + className).val(price.toLocaleString());
          calProfit('itemPrice', 'itemTotalPrice', 'purchaseItemPrice', 'purchaseItemTotalPrice', 'revenueProfitPrice');
          sumPrice();
      }

      function downClick(table, up, down) {
          $('#' + table).addClass('d-none');
          $('#' + up).removeClass('d-none');
          $('#' + down).addClass('d-none');
      }

      function upClick(table, up, down) {
          $('#' + table).removeClass('d-none');
          $('#' + up).addClass('d-none');
          $('#' + down).removeClass('d-none');
      }

      function typeChange() {
          const saleType = $("#saleType").val();
          const saleCompanyNames = $("#saleCompanyNames").attr('data-id');
          const endCompanyNames = $('#endCompanyNames');
          if(saleType == '직판'){
              endCompanyNames.trigger('set',{id: saleCompanyNames});
          }else{
              endCompanyNames.trigger('clear');
          }
      }

      $(document).ready(function () {
          // 빌링스케줄 생성(매출) 고객사명 자동완성
          const billingRevenueCompanyName = document.getElementById('billingRevenueCompanyName');
          $('#billingRevenueCompanyName').magicsearch({
              dataSource: saleCompanyList,
              fields: 'value',
              id: 'id',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
          });

          billingRevenueCompanyName.removeAttribute("style");
          billingRevenueCompanyName.parentElement.removeAttribute("style");

          // 빌링스케줄 생성(접수) 고객사명 자동완성
          const billingPurchaseCompanyName = document.getElementById('billingPurchaseCompanyName');
          $('#billingPurchaseCompanyName').magicsearch({
              dataSource: purchaseCompanyList,
              fields: 'value',
              id: 'id',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
          });

          billingPurchaseCompanyName.removeAttribute("style");
          billingPurchaseCompanyName.parentElement.removeAttribute("style");

          // 담당자 등록 고객사명 자동완성
          const customerCompany = document.getElementById('customerCompany');
          $('#customerCompany').magicsearch({
              dataSource: companyList,
              fields: 'value',
              id: 'id',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
          });

          customerCompany.removeAttribute("style");
          customerCompany.parentElement.removeAttribute("style");

          // 거래처 자동완성
          const saleCompanyNames = document.getElementById('saleCompanyNames');
          {% if saleCompanyNames %}
              saleCompanyNames.setAttribute("data-id", "{{ saleCompanyNames }}");
          {% endif %}
          $('#saleCompanyNames').magicsearch({
              dataSource: saleCompanyList,
              fields: 'value',
              id: 'id',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
              maxShow: 100,
              success: function ($input, data) {
                  $.ajax({
                      url: "{% url 'sales:salemanager_ajax_url' %}",
                      method: 'POST',
                      cache: false,
                      data: {"saleCompanyName": data.id},
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      success: function (returnData) {
                          const saleType = $("#saleType").val();
                          const endCompanyNames = $('#endCompanyNames');
                          if(saleType == '직판'){
                              endCompanyNames.trigger('set',{id: data.id});
                          }
                          var salecompany = returnData;
                          $('#saleCustomerId').empty();
                          $('#saleCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleCustomerId').append(option);
                          }
                          $('#saleTaxCustomerId').empty();
                          $('#saleTaxCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleTaxCustomerId').append(option);
                          }
                      }
                  });
              }
          });
          saleCompanyNames.removeAttribute("style");
          saleCompanyNames.parentElement.removeAttribute("style");

          // 계약종료일 자동입력
          $('#contractStartDate').on("propertychange change keyup paste input", function () {
              $('#contractEndDate').val($('#contractStartDate').val());
          });

          // 수금조건
          changeCondition();

          $('#depositCondition').on("propertychange change keyup paste input", function () {
              changeCondition();
          });

          // 세부사항
          var t1 = $('#categoryItem').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 2, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 3, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 4, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 5, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 6, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 7, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 8, width: "5%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
              ],
          });

          $('#addItem').on('click', function () {
              t1.row.add([
                  '<div class="text-center d-none" value="0" name="itemId" id="item0' + itemCounter + '">추가</div>',
                  '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 200px;" ' +
                    'name="revenueCategoryCompany" id="item1' + itemCounter + '" ' +
                    'onkeydown="magicsearchtab(item1' + itemCounter + ')">',
                  '<select class="input-form" size="1" id="item2' + itemCounter + '" ' +
                    'name="mainCategory" onchange="itemChange(item2' + itemCounter + ",item3" + itemCounter + ')">' +
                    '</select>',
                  '<select class="input-form" size="1" id="item3' + itemCounter + '" ' +
                    'name="subCategory"> <option value="init" selected="selected">--소분류--</option>' +
                    '</select>',
                  '<input style="width:200px" class="input-form" name="itemName" id="item4' + itemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="itemPrice" id="item5' + itemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="itemVatPrice" id="item6' + itemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="itemTotalPrice" id="item7' + itemCounter + '">',
                  '<i class="fas fa-times-circle" name="remove" >'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              document.getElementById("item1" + itemCounter).setAttribute("data-id", $('#saleCompanyNames').attr('data-id'));
              $('#item1' + itemCounter).magicsearch({
                  dataSource: saleCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
                  maxShow: 100,
              });
              $.ajax({
                  url: "{% url 'sales:maincategory_ajax_url' %}",
                  method: 'POST',
                  cache: false,
                  data:{"contractId": ''},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var maincategory = returnData;
                      $('#item2'+itemCounter).empty();
                      $('#item2'+itemCounter).append('<option value="" selected="">--대분류--</option>');
                      for (var count=0; count<maincategory.length; count++) {
                          var option = $("<option value=" + maincategory[count].mainCategory + ">" + maincategory[count].mainCategory + "</option>");
                          $('#item2'+itemCounter).append(option);
                      }
                      itemCounter++;
                  }, error:function(request,status,error){
                      alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                  }
              });
              $('input[name=itemPrice]').on("change keyup paste input", function() {
                  totalPrice('itemPrice', 'totalItemPrice');
              });
              $('input[name=itemVatPrice]').on("change keyup paste input", function() {
                  totalPrice('itemVatPrice', 'totalItemVatPrice');
              });
              $('input[name=itemTotalPrice]').on("change keyup paste input", function() {
                  totalPrice('itemTotalPrice', 'totalItemTotalPrice');
              });
          });

          {% if items %}
              {% for item in items %}
                  t1.row.add([
                      '<div class="text-center d-none" value="0" name="itemId" id="item0' + itemCounter + '">{{ item.contractItemId }}</div>',
                      '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 200px;" name="revenueCategoryCompany" ' +
                        'data-id="{% if item.companyName %}{{ item.companyName }}{% endif %}"' +
                        'id="item1' + itemCounter + '" onkeydown="magicsearchtab(item1' + itemCounter + ')">',
                      '<select class="input-form" size="1" id="item2' + itemCounter + '" ' +
                        'name="mainCategory" onchange="itemChange(item2' + itemCounter + ",item3" + itemCounter + ')">' +
                        '</select>',
                      '<select class="input-form" size="1" id="item3' + itemCounter + '" ' +
                        'name="subCategory"> <option value="init" selected="selected">--소분류--</option>' +
                        '<select>',
                      '<input style="width:200px" class="input-form" name="itemName" ' +
                        'id="item4' + itemCounter + '" value="{{ item.itemName }}">',
                      '<input style="width:200px" class="money input-form" name="itemPrice" ' +
                        'id="item5' + itemCounter + '" value="{{ item.itemPrice }}">',
                      '<input style="width:200px" class="money input-form" name="itemVatPrice" ' +
                        'id="item6' + itemCounter + '" value="{{ item.itemVatPrice }}">',
                      '<input style="width:200px" class="money input-form" name="itemTotalPrice" ' +
                        'id="item7' + itemCounter + '" value="{{ item.itemTotalPrice }}">',
                      '<i class="fas fa-times-circle" name="remove" >'
                  ]).draw(false);
                  itemCounter++;
              {% endfor %}
              $.ajax({
                  url: "{% url 'sales:maincategory_ajax_url' %}",
                  method: 'POST',
                  cache: false,
                  data: {"contractId":"{{ contractId }}"},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var category = returnData[0];
                      var data = returnData[1];
                      for(var i=0;i<data.length;i++){
                          $('#item2'+i).empty();
                          $('#item2'+i).append('<option value="" selected="">--대분류--</option>');
                          for (var count = 0; count < category.length; count++) {
                              var option = $("<option value=" + category[count].mainCategory + ">" + category[count].mainCategory + "</option>");
                              $('#item2'+i).append(option);
                          }
                          $('#item2' + i).val(data[i].mainCategory).prop("selected", true);
                          itemChangeAdd("item2" + i, "item3" + i, data[i].subCategory, i);
                      }
                  }, error:function(request,status,error){
                      alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                  }
              });

              for (var p = 0; p < itemCounter; p++) {
                  $('#item1' + p).magicsearch({
                      dataSource: saleCompanyList,
                      fields: 'value',
                      id: 'id',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                      maxShow: 100,
                  });
              }

              $('.money').simpleMoneyFormat();
              $('input[name=itemPrice]').on("change keyup paste input", function() {
                  totalPrice('itemPrice', 'totalItemPrice');
              });
              $('input[name=itemVatPrice]').on("change keyup paste input", function() {
                  totalPrice('itemVatPrice', 'totalItemVatPrice');
              });
              $('input[name=itemTotalPrice]').on("change keyup paste input", function() {
                  totalPrice('itemTotalPrice', 'totalItemTotalPrice');
              });
          {% else %}
              $('#addItem').click();
          {% endif %}

          $('#categoryItem').on('click', 'i', function () {
              t1
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
              totalPrice('itemPrice', 'totalItemPrice');
              totalPrice('itemVatPrice', 'totalItemVatPrice');
              totalPrice('itemTotalPrice', 'totalItemTotalPrice');
          });

          // 매출 빌링스케쥴
          var t2 = $('#revenue').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {
                      targets: 1, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 2, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 3, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 4, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 5, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 6, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 7, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 8, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
                  {
                      targets: 9, width: "4%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                          $(td).css('padding-bottom', '30px');
                          $(td).css('padding-top', '20px');
                      }
                  },
              ],
          });

          $('#addRevenue').on('click', function () {
              t2.row.add([
                  '<div class="text-center d-none" value="0" name="revenueId" id="revenue0' + revenueCounter + '">추가</div>',
                  '<input class="input-form" type="month" max="9999-12" name="predictBillingDate" id="revenue1' + revenueCounter + '">',
                  '<input class="input-form" type="date" max="9999-12-31" name="billingDate" id="revenue2' + revenueCounter + '" ' +
                  'onchange="changeBillingDates(\'revenue2' + revenueCounter + '\',\'revenue1' + revenueCounter + '\',\'revenue3' + revenueCounter + '\')">',
                  '<input class="input-form" type="date" max="9999-12-31" name="predictDepositDate" id="revenue3' + revenueCounter + '">',
                  '<input class="input-form" type="date" max="9999-12-31" name="depositDate" id="revenue4' + revenueCounter + '" ' +
                  'onchange="changeExecutionDates(\'revenue4' + revenueCounter + '\',\'revenue3' + revenueCounter + '\')">',
                  '<input class="magicsearch input-form" autocomplete="off" type="text" name="revenueCompany" ' +
                  'id="revenue5' + revenueCounter + '" onkeydown="magicsearchtab(revenue5' + revenueCounter + ')">',
                  '<input class="money input-form" name="revenuePrice" id="revenue6' + revenueCounter + '">',
                  '<input class="money input-form" name="revenueProfitPrice" id="revenue7' + revenueCounter + '" readonly style="background-color: #eaecf4">',
                  '<input class="input-form" type="text" name="revenueComment" id="revenue8' + revenueCounter + '">',
                  '<i class="fas fa-times-circle" name="remove">'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              document.getElementById("revenue5" + revenueCounter).setAttribute("data-id", $('#saleCompanyNames').attr('data-id'));
              $('#revenue5' + revenueCounter).magicsearch({
                  dataSource: saleCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
                  maxShow: 100,
              });

              $('input[name=revenuePrice]').on("change keyup paste input", function() {
                  totalPrice('revenuePrice', 'totalRevenuePrice');
              });
              $('input[name=revenueProfitPrice]').on("change keyup paste input", function() {
                  totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');
              });

              revenueCounter++;
          });

          {% if revenues %}
              {% for revenue in revenues %}
                  t2.row.add([
                      '<div class="text-center d-none" value="0" name="revenueId" id="revenue0' + revenueCounter + '">{{ revenue.revenueId }}</div>',
                      '<input class="input-form {% if revenue.revenueStatus == 'Y' %}notChange{% endif %}" type="month" max="9999-12" name="predictBillingDate" id="revenue1' + revenueCounter + '" value="{{ revenue.predictBillingDate | date:"Y-m" }}">',
                      '<input class="input-form {% if revenue.revenueStatus == 'Y' %}notChange{% endif %}" type="date" max="9999-12-31" name="billingDate" id="revenue2' + revenueCounter + '" value="{{ revenue.billingDate | date:"Y-m-d" }}" ' +
                          'onchange="changeBillingDates(\'revenue2' + revenueCounter + '\',\'revenue1' + revenueCounter + '\',\'revenue3' + revenueCounter + '\')">',
                      '<input class="input-form" type="date" max="9999-12-31" name="predictDepositDate" id="revenue3' + revenueCounter + '" value="{{ revenue.predictDepositDate | date:"Y-m-d" }}">',
                      '<input class="input-form" type="date" max="9999-12-31" name="depositDate" id="revenue4' + revenueCounter + '" value="{{ revenue.depositDate | date:"Y-m-d" }}" ' +
                          'onchange="changeExecutionDates(\'revenue4' + revenueCounter + '\',\'revenue3' + revenueCounter + '\')">',
                      '<input class="magicsearch input-form {% if revenue.revenueStatus == 'Y' %}notChange{% endif %}" autocomplete="off" type="text" name="revenueCompany" id="revenue5' + revenueCounter + '" data-id="{% if revenue.revenueCompany %}{{ revenue.revenueCompany }}{% endif %}" onkeydown="magicsearchtab(revenue5' + revenueCounter + ')">',
                      '<input class="money input-form {% if revenue.revenueStatus == 'Y' %}notChange{% endif %}" name="revenuePrice" id="revenue6' + revenueCounter + '" value="{{ revenue.revenuePrice }}">',
                      '<input class="money input-form {% if revenue.revenueStatus == 'Y' %}notChange{% endif %}" name="revenueProfitPrice" id="revenue7' + revenueCounter + '" value="{{ revenue.revenueProfitPrice }}" readonly style="background-color: #eaecf4">',
                      '<input class="input-form" type="text" name="revenueComment" id="revenue8' + revenueCounter + '" value="{{ revenue.comment }}">',
                      {% if revenue.revenueStatus == 'Y' %}
                          '<span class="small">{{ revenue.empId.empName }}</span>'
                      {% else %}
                          '<i class="fas fa-times-circle" name="remove">'
                      {% endif %}
                  ]);
                  revenueCounter++;
              {% endfor %}
              t2.draw();
              for (var r = 0; r < revenueCounter; r++) {
                  $('#revenue5' + r).magicsearch({
                      dataSource: saleCompanyList,
                      fields: 'value',
                      id: 'id',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                      maxShow: 100,
                  });
              }
              $('.money').simpleMoneyFormat();
              $('input[name=revenuePrice]').on("change keyup paste input", function() {
                  totalPrice('revenuePrice', 'totalRevenuePrice');
              });
              $('input[name=revenueProfitPrice]').on("change keyup paste input", function() {
                  totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');
              });
              $('.notChange').attr('readonly', '');
              $('.notChange').css("pointer-events", "none");
              $('.notChange').css("background-color", '#eaecf4');
          {% else %}
              $('#addRevenue').click();
          {% endif %}

          $('#revenue').on('click', 'i', function () {
              t2
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
              totalPrice('revenuePrice', 'totalRevenuePrice');
              totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');
          });

          // 매입세부정보 (세금계산서 접수항목)
          var t3 = $('#purchase').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 2, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 3, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 4, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 5, width: "18%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 6, width: "18%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 7, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 8, width: "4%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
              ],
          });


          $('#addPurchase').on('click', function () {
              t3.row.add([
                  '<div class="text-center d-none" value="0" name="purchaseId" id="purchase0' + purchaseCounter + '">추가</div>',
                  '<input class="input-form" type="month" max="9999-12" name="predictPurchaseDate" id="purchase1' + purchaseCounter + '">',
                  '<input class="input-form" type="date" max="9999-12-31" name="purchaseDate" id="purchase2' + purchaseCounter + '" ' +
                  'onchange="changeBillingDates(\'purchase2' + purchaseCounter + '\',\'purchase1' + purchaseCounter + '\')">',
                  '<input class="input-form" type="date" max="9999-12-31" name="predictWithdrawDate" id="purchase3' + purchaseCounter + '">',
                  '<input class="input-form" type="date" max="9999-12-31" name="withdrawDate" id="purchase4' + purchaseCounter + '" ' +
                  'onchange="changeExecutionDates(\'purchase4' + purchaseCounter + '\',\'purchase3' + purchaseCounter + '\')">',
                  '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 255px;" name="purchaseCompany" ' +
                  'id="purchase5' + purchaseCounter + '" onkeydown="magicsearchtab(purchase5' + purchaseCounter + ')">',
                  '<input class="money input-form" style="width: 255px;"  name="purchasePrice" id="purchase6' + purchaseCounter + '">',
                  '<input class="input-form" type="text" name="purchaseComment" id="purchase7' + purchaseCounter + '">',
                  '<i class="fas fa-times-circle" name="remove">'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              $('#purchase5' + purchaseCounter).magicsearch({
                  dataSource: purchaseCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
                  maxShow: 100,
              });

              $('input[name=purchasePrice]').on("change keyup paste input", function() {
                  totalPrice('purchasePrice', 'totalPurchasePrice');
              });

              purchaseCounter++;
          });

          {% if purchases %}
              {% for purchase in purchases %}
                  t3.row.add([
                      '<div class="text-center d-none" value="0" name="purchaseId" id="purchase0' + purchaseCounter + '">{{ purchase.purchaseId }}</div>',
                      '<input class="input-form" type="month" max="9999-12" name="predictPurchaseDate" id="purchase1' + purchaseCounter + '" value="{{ purchase.predictBillingDate | date:"Y-m" }}">',
                      '<input class="input-form" type="date" max="9999-12-31" name="purchaseDate" id="purchase2' + purchaseCounter + '" value="{{ purchase.billingDate | date:"Y-m-d" }}" ' +
                      'onchange="changeBillingDates(\'purchase2' + purchaseCounter + '\',\'purchase1' + purchaseCounter + '\')">',
                      '<input class="input-form" type="date" max="9999-12-31" name="predictWithdrawDate" id="purchase3' + purchaseCounter + '" value="{{ purchase.predictWithdrawDate | date:"Y-m-d" }}">',
                      '<input class="input-form" type="date" max="9999-12-31" name="withdrawDate" id="purchase4' + purchaseCounter + '" value="{{ purchase.withdrawDate | date:"Y-m-d" }}" ' +
                      'onchange="changeExecutionDates(\'purchase4' + purchaseCounter + '\',\'purchase3' + purchaseCounter + '\')">',
                      '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 255px;" name="purchaseCompany" id="purchase5' + purchaseCounter + '" data-id="{% if purchase.purchaseCompany %}{{ purchase.purchaseCompany }}{% endif %}" onkeydown="magicsearchtab(purchase5' + purchaseCounter + ')">',
                      '<input class="money input-form" style="width: 255px;" name="purchasePrice" id="purchase6' + purchaseCounter + '" value="{{ purchase.purchasePrice }}">',
                      '<input class="input-form" type="text" name="purchaseComment" id="purchase7' + purchaseCounter + '" value="{{ purchase.comment }}">',
                      '<i class="fas fa-times-circle" name="remove">'
                  ]);
                  purchaseCounter++;
              {% endfor %}
              t3.draw();
              for (var p = 0; p < purchaseCounter; p++) {
                  $('#purchase5' + p).magicsearch({
                      dataSource: purchaseCompanyList,
                      fields: 'value',
                      id: 'id',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                      maxShow: 100,
                  });
              }
              $('.money').simpleMoneyFormat();

              $('input[name=purchasePrice]').on("change keyup paste input", function() {
                  totalPrice('purchasePrice', 'totalPurchasePrice');
              });
          {% else %}
              $('#addPurchase').click();
          {% endif %}

          $('#purchase').on('click', 'i', function () {
              t3
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
              totalPrice('purchasePrice', 'totalPurchasePrice');
          });

          // 매입세부정보 (세금계산서 미접수항목)
          var t4 = $('#cost').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, width: "18%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 6, width: "18%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 7, width: "12%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 8, width: "4%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
              ],
          });

          $('#addCost').on('click', function () {
              t4.row.add([
                  '<div class="d-none" value="0" name="costId" id="cost0' + costCounter + '">추가</div>',
                  '<input class="input-form d-none" type="month" max="9999-12" name="" id="cost1' + costCounter + '">',
                  '<input class="input-form d-none" type="date" max="9999-12-31" name="" id="cost2' + costCounter + '" ' +
                  'onchange="changeBillingDates(\'cost2' + costCounter + '\',\'cost1' + costCounter + '\')">',
                  '<input class="input-form d-none" type="date" max="9999-12-31" name="" id="cost3' + costCounter + '">',
                  '<input class="input-form" type="date" max="9999-12-31" name="costDate" id="cost4' + costCounter + '">',
                  '<select style="width:255px" class="input-form" id="cost5' + costCounter + '" name="costCompany" ></select>',
                  '<input class="money input-form" style="width: 255px;"  name="costPrice" id="cost6' + costCounter + '">',
                  '<input class="input-form" type="text" name="costComment" id="cost7' + costCounter + '">',
                  '<i class="fas fa-times-circle" name="remove">'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              $.ajax({
                      url: "{% url 'sales:classification_ajax_url' %}",
                      method: 'POST',
                      cache: false,
                      data: {'classification': '매입_미접수',
                             'contractId':''},
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      success: function (returnData) {
                          var costcontents = returnData;
                          $('#cost5'+costCounter).empty();
                          $('#cost5'+costCounter).append('<option value="" selected="">------</option>');
                          for (var count = 0; count < costcontents.length; count++) {
                              var option = $("<option value=" + costcontents[count].categoryName + ">" + costcontents[count].categoryName + "</option>");
                              $('#cost5'+costCounter).append(option);
                          }
                          costCounter++;
                      },error:function(request,status,error){
                          alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                      }

              });

              $('input[name=costPrice]').on("change keyup paste input", function() {
                  totalPrice('costPrice', 'totalCostPrice');
              });

          });

          {% if costs %}
              {% for cost in costs %}
                  t4.row.add([
                      '<div class="d-none" value="0" name="costId" id="cost0' + costCounter + '">{{ cost.costId }}</div>',
                      '<input class="input-form d-none" type="month" max="9999-12" name="" id="cost1' + costCounter + '" value="">',
                      '<input class="input-form d-none" type="date" max="9999-12-31" name="" id="cost2' + costCounter + '" value="" ' +
                      'onchange="changeBillingDates(\'cost2' + costCounter + '\',\'cost1' + costCounter + '\')">',
                      '<input class="input-form d-none" type="date" max="9999-12-31" name="" id="cost3' + costCounter + '" value="">',
                      '<input class="input-form" type="date" max="9999-12-31" name="costDate" id="cost4' + costCounter + '" value="{{ cost.billingDate | date:"Y-m-d" }}">',
                      '<select style="width:255px" class="input-form" id="cost5' + costCounter + '" name="costCompany"></select>',
                      '<input class="money input-form" style="width: 255px;" name="costPrice" id="cost6' + costCounter + '" value="{{ cost.costPrice }}">',
                      '<input class="input-form" type="text" name="costComment" id="cost7' + costCounter + '" value="{{ cost.comment }}">',
                      '<i class="fas fa-times-circle" name="remove">'
                  ]);
                  costCounter++;
              {% endfor %}
              t4.draw();
              $.ajax({
                  url: "{% url 'sales:classification_ajax_url' %}",
                  method: 'POST',
                  cache: false,
                  data: {'classification': '매입_미접수',
                        'contractId': '{{ contractId }}'},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var classification = returnData[0];
                      var data = returnData[1];
                      for(var i=0;i<data.length;i++){
                          $('#cost5'+i).empty();
                          $('#cost5'+i).append('<option value="" selected="">------</option>');
                          for (var count = 0; count < classification.length; count++) {
                              var option = $("<option value=" + classification[count].categoryName + ">" + classification[count].categoryName + "</option>");
                              $('#cost5'+i).append(option);
                          }
                          $('#cost5' + i).val(data[i].costCompany).prop("selected", true);
                      }
                  },error:function(request,status,error){
                          alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                  }
              });

              $('.money').simpleMoneyFormat();
              $('input[name=costPrice]').on("change keyup paste input", function() {
                  totalPrice('costPrice', 'totalCostPrice');
              });
          {% endif %}

          $('#cost').on('click', 'i', function () {
              t4
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
              totalPrice('costPrice', 'totalCostPrice');
          });

          // 매입 세부사항
          var t5 = $('#purchaseCategoryItem').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 2, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 3, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 4, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 5, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 6, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 7, width: "15%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
                  {targets: 8, width: "5%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                    createdCell: function (td, cellData, rowData, row, col) {
                      $(td).css('padding-bottom', '30px');
                      $(td).css('padding-top', '20px');
                    }
                  },
              ],
          });

          $('#purchaseAddItem').on('click', function () {
              t5.row.add([
                  '<div class="text-center d-none" value="0" name="purchaseItemId" id="purchaseItem0' + purchaseItemCounter + '">추가</div>',
                  '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 200px;" ' +
                    'name="purchaseCategoryCompany" id="purchaseItem1' + purchaseItemCounter + '" ' +
                    'onkeydown="magicsearchtab(purchaseItem1' + purchaseItemCounter + ')">',
                  '<select class="input-form" size="1" id="purchaseItem2' + purchaseItemCounter + '" ' +
                    'name="purchaseMainCategory" onchange="purchaseItemChangeAdd(purchaseItem2' + purchaseItemCounter + ",purchaseItem3" + purchaseItemCounter + ')">' +
                    '</select>',
                  '<select class="input-form" size="1" id="purchaseItem3' + purchaseItemCounter + '" ' +
                    'name="purchaseSubCategory"> <option value="init" selected="selected">--소분류--</option>' +
                    '</select>',
                  '<input style="width:200px" class="input-form" name="purchaseItemName" id="purchaseItem4' + purchaseItemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="purchaseItemPrice" id="purchaseItem5' + purchaseItemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="purchaseItemVatPrice" id="purchaseItem6' + purchaseItemCounter + '">',
                  '<input style="width:200px" class="money input-form" name="purchaseItemTotalPrice" id="purchaseItem7' + purchaseItemCounter + '">',
                  '<i class="fas fa-times-circle" name="remove" >'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              $('#purchaseItem1' + purchaseItemCounter).magicsearch({
                  dataSource: purchaseCompanyList,
                  fields: 'value',
                  id: 'id',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
                  maxShow: 100,
              });
              $.ajax({
                  url: "{% url 'sales:purchasemaincategory_asjson' %}",
                  method: 'POST',
                  cache: false,
                  data:{"contractId": ''},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var maincategory = returnData;
                      $('#purchaseItem2'+purchaseItemCounter).empty();
                      $('#purchaseItem2'+purchaseItemCounter).append('<option value="" selected="">--대분류--</option>');
                      for (var count = 0; count < maincategory.length; count++) {
                          var option = $("<option value=" + maincategory[count].mainCategory + ">" + maincategory[count].mainCategory + "</option>");
                          $('#purchaseItem2'+purchaseItemCounter).append(option);
                      }
                      purchaseItemCounter++;
                  },error:function(request,status,error){
                      alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                  }
              });
              $('input[name=purchaseItemPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemPrice', 'totalpurchaseItemPrice');
              });
              $('input[name=purchaseItemVatPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemVatPrice', 'totalpurchaseItemVatPrice');
              });
              $('input[name=purchaseItemTotalPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemTotalPrice', 'totalpurchaseItemTotalPrice');
              });
          });

          {% if purchaseItems %}
              {% for item in purchaseItems %}
                  t5.row.add([
                      '<div class="text-center d-none" value="0" name="purchaseItemId" id="purchaseItem0' + purchaseItemCounter + '">{{ item.contractItemId }}</div>',
                      '<input class="magicsearch input-form" autocomplete="off" type="text" style="width: 200px;" name="purchaseCategoryCompany" ' +
                      {% if item.companyName %}
                      'data-id="{{ item.companyName }}"' +
                      {% endif %}
                      'id="purchaseItem1' + purchaseItemCounter + '" onkeydown="magicsearchtab(purchaseItem1' + purchaseItemCounter + ')">',
                      '<select class="input-form" size="1" id="purchaseItem2' + purchaseItemCounter + '" ' +
                        'name="purchaseMainCategory" onchange="purchaseItemChangeAdd(purchaseItem2' + purchaseItemCounter + ",purchaseItem3" + purchaseItemCounter + ')">' +
                        '</select>',
                      '<select class="input-form" size="1" id="purchaseItem3' + purchaseItemCounter + '"' +
                        'name="purchaseSubCategory"> <option value="init" selected="selected">--소분류--</option>' +
                        '<select>',
                      '<input style="width:200px" class="input-form" name="purchaseItemName" id="purchaseItem4' + purchaseItemCounter + '" value="{{ item.itemName }}">',
                      '<input style="width:200px" class="money input-form" name="purchaseItemPrice" id="purchaseItem5' + purchaseItemCounter + '" value="{{ item.itemPrice }}">',
                      '<input style="width:200px" class="money input-form" name="purchaseItemVatPrice" id="purchaseItem6' + purchaseItemCounter + '" value="{{ item.itemVatPrice }}">',
                      '<input style="width:200px" class="money input-form" name="purchaseItemTotalPrice" id="purchaseItem7' + purchaseItemCounter + '" value="{{ item.itemTotalPrice }}">',
                      '<i class="fas fa-times-circle" name="remove" >'
                  ]).draw(false);
                  purchaseItemCounter++;
              {% endfor %}
              t5.draw();
              $.ajax({
                  url: "{% url 'sales:purchasemaincategory_asjson' %}",
                  method: 'POST',
                  cache: false,
                  data: {"contractId":"{{ contractId }}"},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var category = returnData[0];
                      var data = returnData[1];
                      for(var i=0;i<data.length;i++){
                          $('#purchaseItem1'+i).empty();
                          $('#purchaseItem1'+i).append('<option value="" selected="">--대분류--</option>');
                          for (var count = 0; count < category.length; count++) {
                              var option = $("<option value=" + category[count].mainCategory + ">" + category[count].mainCategory + "</option>");
                              $('#purchaseItem2'+i).append(option);
                          }
                          $('#purchaseItem2' + i).val(data[i].mainCategory).prop("selected", true);
                          purchaseItemChangeAdd("purchaseItem2" + i, "purchaseItem3" + i, data[i].subCategory, i);
                      }
                  },error:function(request,status,error){
                          alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                  }
              });

               for (var p = 0; p < purchaseItemCounter; p++) {
                  $('#purchaseItem1' + p).magicsearch({
                      dataSource: purchaseCompanyList,
                      fields: 'value',
                      id: 'id',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                      maxShow: 100,
                  });
              }

              $('.money').simpleMoneyFormat();
              $('input[name=purchaseItemPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemPrice', 'totalpurchaseItemPrice');
              });
              $('input[name=purchaseItemVatPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemVatPrice', 'totalpurchaseItemVatPrice');
              });
              $('input[name=purchaseItemTotalPrice]').on("change keyup paste input", function() {
                  totalPrice('purchaseItemTotalPrice', 'totalpurchaseItemTotalPrice');
              });
          {% else %}
              $('#purchaseAddItem').click();
          {% endif %}

          $('#purchaseCategoryItem').on('click', 'i', function () {
              t5
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
              totalPrice('purchaseItemPrice', 'totalpurchaseItemPrice');
              totalPrice('purchaseItemVatPrice', 'totalpurchaseItemVatPrice');
              totalPrice('purchaseItemTotalPrice', 'totalpurchaseItemTotalPrice');
          });

          // 합계 수동으로 구해서 넣어주는 것
          totalPrice('itemPrice', 'totalItemPrice');
          totalPrice('itemVatPrice', 'totalItemVatPrice');
          totalPrice('itemTotalPrice', 'totalItemTotalPrice');
          totalPrice('revenuePrice', 'totalRevenuePrice');
          totalPrice('revenueProfitPrice', 'totalRevenueProfitPrice');
          totalPrice('purchasePrice', 'totalPurchasePrice');
          totalPrice('costPrice', 'totalCostPrice');
          totalPrice('purchaseItemPrice', 'totalpurchaseItemPrice');
          totalPrice('purchaseItemVatPrice', 'totalpurchaseItemVatPrice');
          totalPrice('purchaseItemTotalPrice', 'totalpurchaseItemTotalPrice');
      })
  </script>

{% endblock %}