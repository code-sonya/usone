{% extends "dashboard/layout.html" %}


{% block title %}
  영업관리
{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-2"></div>

    <div class="col-xl-8">
      <div class="card shadow mb-4">

        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 영업기회 및 계약 등록 </h6>
        </div>

        <div class="card-body">
          <form id="ContractForm" method="POST">
            {% csrf_token %}
            <div id="Opportunity">
              <div class="form-group row">
                <div class="col-12 mb-3">
                  <label for="contractName" class="font-weight-bold text-primary"> 제목 </label> {{ form.contractName }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="contractStep" class="font-weight-bold text-primary"> 단계 </label> {{ form.contractStep }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="empId" class="font-weight-bold text-primary"> 영업담당 </label> {{ form.empId }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="saleType" class="font-weight-bold text-primary"> 판매유형 </label> {{ form.saleType }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="saleIndustry" class="font-weight-bold text-primary"> 산업군 </label> {{ form.saleIndustry }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <div class="col-6 mb-3">
                  <label for="saleCompanyName" class="font-weight-bold text-primary"> 거래처 </label> {{ form.saleCompanyName }}
                </div>
                <div class="col-6 mb-3">
                  <label for="saleCustomerId" class="font-weight-bold text-primary"> 거래처 담당자 </label> {{ form.saleCustomerId }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-6  mb-3">
                  <label for="endCompanyName" class="font-weight-bold text-primary"> 최종고객사 </label> {{ form.endCompanyName }}
                </div>
                <div class="col-6 mb-3">
                  <label for="endCustomerId" class="font-weight-bold text-primary"> 최종고객사 담당자 </label> {{ form.endCustomerId }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictSalePrice" class="font-weight-bold text-primary"> 예상계약금액(원) </label> {{ form.predictSalePrice }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictProfitPrice" class="font-weight-bold text-primary"> 예상이익금액(원) </label> {{ form.predictProfitPrice }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictProfitRatio" class="font-weight-bold text-primary"> 예상이익율(%) </label> {{ form.predictProfitRatio }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictContractDate" class="font-weight-bold text-primary"> 예상계약일 </label> {{ form.predictContractDate }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="Firm" class="d-none">
              <hr class="divider">
              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="salePrice" class="font-weight-bold text-primary"> 계약금액(원) </label> {{ form.salePrice }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="profitPrice" class="font-weight-bold text-primary"> 이익금액(원) </label> {{ form.profitPrice }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="profitRatio" class="font-weight-bold text-primary"> 이익율(%) </label> {{ form.profitRatio }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="contractDate" class="font-weight-bold text-primary"> 계약일 </label> {{ form.contractDate }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="predictSalePrice" class="font-weight-bold text-primary"> 계약시작일 </label> {{ form.contractStartDate }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="predictProfitPrice" class="font-weight-bold text-primary"> 계약종료일 </label> {{ form.contractEndDate }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-12 mb-3">
                      <label for="predictSalePrice" class="font-weight-bold text-primary"> 참고사항 </label> {{ form.comment }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-xl-12">
                  <span id="addRow" class="btn btn-outline-info">+ 항목 추가</span>
                  <table id="categoryItem" class="display" style="width:100%">
                    <thead style="width:100%">
                    <tr>
                      <th>구분</th>
                      <th>대분류</th>
                      <th>소분류</th>
                      <th>상세내용</th>
                      <th>가격</th>
                      <th></th>
                    </tr>
                    </thead>
                  </table>
                </div>
              </div>
            </div>
            <div class="text-center">
              <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_cancel()">
                <span class="icon text-white-50"> <i class="fas fa-times"> </i> </span>
                <span class="text"> 취소 </span>
              </a>
              <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
                <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
                <span class="text"> 저장 </span>
              </a>
            </div>
          </form>
        </div>

      </div>
    </div>

    <div class="col-xl-2"></div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function btn_cancel() {
          if (confirm("취소 하시겠습니까?") === true) {
              history.back();
          } else {
              return false;
          }
      }

      function btn_save() {
          const Main = $('[name="mainCategory"]');
          const listItem = new Array();

          for (var i = 0; i <= Main.length - 1; i++) {
              // 객체 생성
              var data = new Object();
              if ($('div[name="idx"]').eq(i).text() === '추가') {
                  data.idx = 0
              }
              data.main = $('select[name="mainCategory"]').eq(i).val();
              data.sub = $('select[name="subCategory"]').eq(i).val();
              data.detail = $('input[name="detail"]').eq(i).val();
              data.price = $('input[name="price"]').eq(i).val();
              listItem.push(data);
          }

          const jsonData = JSON.stringify(listItem);
          const jsonItem = document.createElement("input");
          jsonItem.setAttribute("type", "hidden"); jsonItem.setAttribute("name", "jsonItem"); jsonItem.setAttribute("value", jsonData);

          const ContractForm = document.getElementById("ContractForm");
          ContractForm.appendChild(jsonItem);

          console.log(jsonData);
          if (confirm("저장 하시겠습니까?") === true) {
              ContractForm.submit();
          }
      }

      function changeCompany(saleCompanyName, selectId) {
          $.ajax({
              url: "{% url 'sales:salemanager_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"saleCompanyName": saleCompanyName},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var salecompany = returnData;
                  $('#' + selectId).empty();

                  for (var count = 0; count < salecompany.length; count++) {
                      var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                      $('#' + selectId).append(option);
                  }
              }
          })
      }

      function itemChange(main, sub) {
          var selectItem = $(main).val();

          $.ajax({
              url: "{% url 'sales:category_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                  }
              }
          });
      }

      $(document).ready(function () {
          var t = $('#categoryItem').DataTable({
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex); // or whatever you choose to set as the id
              },
          });
          var counter = 0;
          $('#addRow').on('click', function () {
              console.log('click');
              t.row.add([
                  '<div class="text-center" value="0" name="idx" id="item0' + counter + '">추가</div>',
                  '<select size="1" id="item1' + counter + '" name="mainCategory" onchange="itemChange( item1' + counter + ",item2" + counter + ')"> <option value="init" selected="selected">--대분류--</option> <option value="상품_Oracle">상품_Oracle</option> <option value="상품_IBM">상품_IBM</option> <option value="상품_Lenovo">상품_Lenovo</option> <option value="상품_기타">상품_기타</option> </select>',
                  '<select size="1" id="item2' + counter + '" name="subCategory"> <option value="init" selected="selected">--소분류--</option> ',
                  '<input type="text" name="detail" id="item3' + counter + '">',
                  '<input type="text" name="price" id="item4' + counter + '">',
                  '<i class="fas fa-times-circle" name="remove" >'
              ]).draw(false);
              console.log(counter);
              counter++;
          });

          $('#categoryItem').on('click', 'i', function () {
              t
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
          });

          $('#predictSalePrice').on("propertychange change keyup paste input", function () {
              const predictSalePrice = $('#predictSalePrice').val();
              const predictProfitPrice = $('#predictProfitPrice').val();
              $('#predictProfitRatio').val(((predictProfitPrice / predictSalePrice) * 100).toFixed(1));
          });

          $('#predictProfitPrice').on("propertychange change keyup paste input", function () {
              const predictSalePrice = $('#predictSalePrice').val();
              const predictProfitPrice = $('#predictProfitPrice').val();
              $('#predictProfitRatio').val(((predictProfitPrice / predictSalePrice) * 100).toFixed(1));
          });

          $('#salePrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val();
              const profitPrice = $('#profitPrice').val();
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          $('#profitPrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val();
              const profitPrice = $('#profitPrice').val();
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          $('#contractStep').on("propertychange change keyup paste input", function () {
              const contractStep = $('#contractStep').val();
              if (contractStep === 'Firm') {
                  console.log('Firm');
                  $('#Firm').removeClass('d-none');
                  t.clear().draw();
                  counter = 0;
                  $('#addRow').click();
              } else {
                  $('#Firm').addClass('d-none');
                  $('#salePrice').val('');
                  $('#profitPrice').val('');
                  $('#profitRatio').val('');
                  $('#contractDate').val('');
                  $('#contractStartDate').val('');
                  $('#contractEndDate').val('');
                  t.clear().draw();
                  counter = 0
                  $('#addRow').click();

              }
          });
      })

  </script>

{% endblock %}