{% extends "dashboard/layout.html" %}


{% block title %}
  영업관리
{% endblock %}


{% block css %}

  <style type="text/css">

  </style>

{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-1"></div>

    <div class="col-xl-10">
      <div class="card shadow mb-4">

        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 영업기회 및 계약 등록 </h6>
        </div>

        <div class="card-body">
          <form id="ContractForm" method="POST">
            {% csrf_token %}
            <div id="Opportunity">
              <div class="form-group row">
                <div class="col-3 mb-3">
                  <label for="contractCode" class="font-weight-bold text-primary"> 관리번호 </label> {{ form.contractCode }}
                </div>
                <div class="col-9 mb-3">
                  <label for="contractName" class="font-weight-bold text-primary"> 계약명 </label> {{ form.contractName }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="contractStep" class="font-weight-bold text-primary"> 단계 </label> {{ form.contractStep }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="empId" class="font-weight-bold text-primary"> 영업담당 </label> {{ form.empId }}
                    </div>
                  </div>
                </div>
                <div class="col-xl-6">
                  <div class="form-group row mb-0">
                    <div class="col-6 mb-3">
                      <label for="saleType" class="font-weight-bold text-primary"> 판매유형 </label> {{ form.saleType }}
                    </div>
                    <div class="col-6 mb-3">
                      <label for="saleIndustry" class="font-weight-bold text-primary"> 산업군 </label> {{ form.saleIndustry }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <div class="col-4 mb-3">
                  <label for="saleCompanyNames" class="font-weight-bold text-primary"> 거래처 </label> {{ form.saleCompanyNames }}
                </div>
                <div class="col-4 mb-3">
                  <label for="saleCustomerId" class="font-weight-bold text-primary"> 거래처 담당자 </label> {{ form.saleCustomerId }}
                </div>
                <div class="col-4  mb-3">
                  <label for="endCompanyNames" class="font-weight-bold text-primary"> 최종고객사 </label> {{ form.endCompanyNames }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-4 mb-3">
                  <label for="salePrice" class="font-weight-bold text-primary"> <span name="predict">예상</span>계약금액 (원) </label> {{ form.salePrice }}
                </div>
                <div class="col-4 mb-3">
                  <label for="profitPrice" class="font-weight-bold text-primary"> <span name="predict">예상</span>이익금액 (원) </label> {{ form.profitPrice }}
                </div>
                <div class="col-4 mb-3">
                  <label for="profitRatio" class="font-weight-bold text-primary"> <span name="predict">예상</span>이익율 (%) </label> {{ form.profitRatio }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-4 mb-3">
                  <label for="contractDate" class="font-weight-bold text-primary"> <span name="predict">예상</span>계약일 </label> {{ form.contractDate }}
                </div>
                <div class="col-4">
                  <label for="contractStartDate" class="font-weight-bold text-primary"> 계약시작일 </label> {{ form.contractStartDate }}
                </div>
                <div class="col-4">
                  <label for="contractEndDate" class="font-weight-bold text-primary"> 계약종료일 </label> {{ form.contractEndDate }}
                </div>
              </div>

              <div class="form-group row">
                <div class="col-xl-12">
                  <label for="comment" class="font-weight-bold text-primary"> 참고사항 </label> {{ form.comment }}
                </div>
              </div>
            </div>

            <hr class="divider">
            <div class="form-group row">
              <div class="col-xl-12">
                <h5 class="text-dark mb-3"><b> ▼ 세부사항</b></h5>
                <table id="categoryItem" class="display" style="width:100%">
                  <thead style="width:100%">
                  <tr>
                    <th>구분</th>
                    <th>대분류</th>
                    <th>소분류</th>
                    <th>상세내용</th>
                    <th>금액</th>
                    <th><i id="addItem" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                  </tr>
                  </thead>
                </table>
              </div>
            </div>

            <hr class="divider">
            <div class="form-group row">
              <div class="col-xl-12">
                <h5 class="text-dark mb-3"><b>▼ 매출세부정보</b></h5>
                <table id="revenue" class="display" style="width:100%">
                  <thead style="width:100%">
                  <tr>
                    <th>구분</th>
                    <th>매출예정일</th>
                    <th>매출일</th>
                    <th>수금예정일</th>
                    <th>수금일</th>
                    <th onclick="changeRevenueCompany()">매출처</th>
                    <th>매출금액</th>
                    <th>GP</th>
                    <th>비고</th>
                    <th><i id="addRevenue" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                  </tr>
                  </thead>
                </table>
              </div>
            </div>

            <hr class="divider">
            <div class="form-group row">
              <div class="col-xl-12">
                <h5 class="text-dark mb-3"><b>▼ 매입세부정보</b></h5>
                <table id="purchase" class="display" style="width:100%">
                  <thead style="width:100%">
                  <tr>
                    <th>구분</th>
                    <th>매입예정일</th>
                    <th>매입일</th>
                    <th>지급예정일</th>
                    <th>지급일</th>
                    <th onclick="changeRevenueCompany()">매입처</th>
                    <th>매입금액</th>
                    <th>비고</th>
                    <th><i id="addPurchase" class="fas fa-plus-square fa-fw text-info" style="font-size: 2rem"></i></th>
                  </tr>
                  </thead>
                </table>
              </div>
            </div>

            <div class="text-center">
              <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_cancel()">
                <span class="icon text-white-50"> <i class="fas fa-times"> </i> </span>
                <span class="text"> 취소 </span>
              </a>
              <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
                <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
                <span class="text"> 저장 </span>
              </a>
            </div>
          </form>
        </div>

      </div>
    </div>

    <div class="col-xl-1"></div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function btn_cancel() {
          if (confirm("취소 하시겠습니까?") === true) {
              location.href = "/sales/showcontracts"
          } else {
              return false;
          }
      }

      function btn_save() {
          moneyChange();

          const ContractForm = document.getElementById("ContractForm");

          // 세부사항
          const lengthItem = $('[name="itemId"]').length;
          const listItem = new Array();
          for (var i = 0; i <= lengthItem - 1; i++) {
              var data = new Object();
              data.itemId = $('div[name="itemId"]').eq(i).text();
              data.mainCategory = $('select[name="mainCategory"]').eq(i).val();
              data.subCategory = $('select[name="subCategory"]').eq(i).val();
              data.itemName = $('input[name="itemName"]').eq(i).val();
              data.itemPrice = $('input[name="itemPrice"]').eq(i).val();
              listItem.push(data);
          }
          const jsonItem = JSON.stringify(listItem);
          const item = document.createElement("input");
          item.setAttribute("type", "hidden");
          item.setAttribute("name", "jsonItem");
          item.setAttribute("value", jsonItem);
          ContractForm.appendChild(item);

          // 매출세부정보
          const lengthRevenue = $('[name="revenueId"]').length;
          const listRevenue = new Array();
          for (var i = 0; i <= lengthRevenue - 1; i++) {
              var data = new Object();
              data.revenueId = $('div[name="revenueId"]').eq(i).text();
              data.predictBillingDate = $('input[name="predictBillingDate"]').eq(i).val();
              data.billingDate = $('input[name="billingDate"]').eq(i).val();
              data.predictDepositDate = $('input[name="predictDepositDate"]').eq(i).val();
              data.depositDate = $('input[name="depositDate"]').eq(i).val();
              data.revenueCompany = $('input[name="revenueCompany"]').eq(i).val();
              data.revenuePrice = $('input[name="revenuePrice"]').eq(i).val();
              data.revenueProfitPrice = $('input[name="revenueProfitPrice"]').eq(i).val();
              data.revenueComment = $('input[name="revenueComment"]').eq(i).val();
              listRevenue.push(data);
          }
          const jsonRevenue = JSON.stringify(listRevenue);
          const revenue = document.createElement("input");
          revenue.setAttribute("type", "hidden");
          revenue.setAttribute("name", "jsonRevenue");
          revenue.setAttribute("value", jsonRevenue);
          ContractForm.appendChild(revenue);

          // 매입세부정보
          const lengthPurchase = $('[name="purchaseId"]').length;
          const listPurchase = new Array();
          for (var i = 0; i <= lengthPurchase - 1; i++) {
              var data = new Object();
              data.purchaseId = $('div[name="purchaseId"]').eq(i).text();
              data.predictPurchaseDate = $('input[name="predictPurchaseDate"]').eq(i).val();
              data.purchaseDate = $('input[name="purchaseDate"]').eq(i).val();
              data.predictWithdrawDate = $('input[name="predictWithdrawDate"]').eq(i).val();
              data.withdrawDate = $('input[name="withdrawDate"]').eq(i).val();
              data.purchaseCompany = $('input[name="purchaseCompany"]').eq(i).val();
              data.purchasePrice = $('input[name="purchasePrice"]').eq(i).val();
              data.purchaseComment = $('input[name="purchaseComment"]').eq(i).val();
              listPurchase.push(data);
          }
          const jsonPurchase = JSON.stringify(listPurchase);
          const purchase = document.createElement("input");
          purchase.setAttribute("type", "hidden");
          purchase.setAttribute("name", "jsonPurchase");
          purchase.setAttribute("value", jsonPurchase);
          ContractForm.appendChild(purchase);

          let sumItemPrice = 0;
          for (i = 0; i < $('input[name="itemPrice"]').length; i++) {
              sumItemPrice += Number($('input[name="itemPrice"]').eq(i).val().replace(/,/g, ''));
          }

          let sumRevenuePrice = 0;
          for (i = 0; i < $('input[name="revenuePrice"]').length; i++) {
              sumRevenuePrice += Number($('input[name="revenuePrice"]').eq(i).val().replace(/,/g, ''));
          }

          let sumRevenueProfitPrice = 0;
          for (i = 0; i < $('input[name="revenueProfitPrice"]').length; i++) {
              sumRevenueProfitPrice += Number($('input[name="revenueProfitPrice"]').eq(i).val().replace(/,/g, ''));
          }

          if ($('#contractStep').val() === 'Firm') {
              if (sumItemPrice != $('#salePrice').val().replace(/,/g, '')) {
                  alert("계약금액 : " + $('#salePrice').val() + "\n" +
                      "세부금액 : " + sumItemPrice + "\n" +
                      "계약금액과 세부사항 금액의 합이 일치하지 않습니다.");
                  return false;
              }
              if (sumRevenuePrice != $('#salePrice').val().replace(/,/g, '')) {
                  alert("계약금액 : " + $('#salePrice').val() + "\n" +
                      "매출금액 : " + sumRevenuePrice + "\n" +
                      "계약금액과 매출금액의 합이 일치하지 않습니다.");
                  return false;
              }
              if (sumRevenueProfitPrice != $('#profitPrice').val().replace(/,/g, '')) {
                  alert("이익금액 : " + $('#profitPrice').val() + "\n" +
                      "GP : " + sumRevenueProfitPrice + "\n" +
                      "이익금액과 GP의 합이 일치하지 않습니다.");
                  return false;
              }
          }

          if (confirm("저장 하시겠습니까?") === true) {
              ContractForm.submit();
          }
      }

      function itemChange(main, sub) {
          var selectItem = $(main).val();

          $.ajax({
              url: "{% url 'sales:category_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                  }
              }
          });
      }

      function itemChangeAdd(main, sub, subCategory, itemCounter) {
          if ($.type(main) === 'string') {
              main = '#' + main
          }
          if ($.type(sub) === 'string') {
              sub = '#' + sub
          }
          var selectItem = $(main).val();

          $.ajax({
              url: "{% url 'sales:category_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"mainCategory": selectItem},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var mainCategory = returnData;
                  $(sub).empty();

                  for (var count = 0; count < mainCategory.length; count++) {
                      var option = $("<option value=" + mainCategory[count].fields.subCategory + ">" + mainCategory[count].fields.subCategory + "</option>");
                      $(sub).append(option);
                      $('#item2' + itemCounter).val(subCategory).prop("selected", true);
                  }
              }
          });
      }

      function changeRevenueCompany() {
          $('input[name=revenueCompany]').trigger('set', {id: $('#saleCompanyNames').val()});
      }

      $(document).ready(function () {
          // 단계에 따른 표기 방법
          if ($('#contractStep').val() === 'Firm') {
              $('#contractStartDate').removeAttr('readonly');
              $('#contractEndDate').removeAttr('readonly');
              $('span[name=predict]').addClass('d-none');
          }

          $('#contractStep').on("propertychange change keyup paste input", function () {
              const contractStep = $('#contractStep').val();
              if (contractStep === 'Firm') {
                  $('#contractStartDate').removeAttr('readonly');
                  $('#contractEndDate').removeAttr('readonly');
                  $('span[name=predict]').addClass('d-none');
              } else {
                  $('#contractStartDate').val('');
                  $('#contractStartDate').attr('readonly', '');
                  $('#contractEndDate').val('');
                  $('#contractEndDate').attr('readonly', '');
                  $('span[name=predict]').removeClass('d-none');
              }
          });

          // 거래처 자동완성
          const saleCompanyNames = document.getElementById('saleCompanyNames');
          {% if saleCompanyNames %}
              saleCompanyNames.setAttribute("data-id", "{{ saleCompanyNames }}");
          {% endif %}
          $('#saleCompanyNames').magicsearch({
              dataSource: {{ companyNames|safe }},
              fields: 'value',
              id: 'id',
              multiple: false,
              multiField: 'value',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
              success: function ($input, data) {
                  $.ajax({
                      url: "{% url 'sales:salemanager_ajax_url' %}",
                      method: 'POST',
                      cache: false,
                      data: {"saleCompanyName": data.id},
                      headers: {'X-CSRFToken': '{{ csrf_token }}'},
                      success: function (returnData) {
                          var salecompany = returnData;
                          $('#saleCustomerId').empty();
                          $('#saleCustomerId').append('<option value="" selected="">---------</option>');

                          for (var count = 0; count < salecompany.length; count++) {
                              var option = $("<option value=" + salecompany[count].pk + ">" + salecompany[count].fields.customerName + "</option>");
                              $('#saleCustomerId').append(option);
                          }
                      }
                  });
              }
          });
          saleCompanyNames.removeAttribute("style");
          saleCompanyNames.parentElement.removeAttribute("style");

          // 최종고객사 자동완성
          const endCompanyNames = document.getElementById('endCompanyNames');
          {% if endCompanyNames %}
              endCompanyNames.setAttribute("data-id", "{{ endCompanyNames }}");
          {% endif %}
          $('#endCompanyNames').magicsearch({
              dataSource: {{ companyNames|safe }},
              fields: 'value',
              id: 'id',
              multiple: false,
              multiField: 'value',
              format: '%value%',
              multiStyle: {space: 5, width: 80},
              noResult: '검색결과없음',
              focusShow: true,
          });
          endCompanyNames.removeAttribute("style");
          endCompanyNames.parentElement.removeAttribute("style");

          // 세부사항
          var t1 = $('#categoryItem').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, width: "23%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, width: "23%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, width: "23%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, width: "23%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, width: "8%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
              ],
          });

          var itemCounter = 0;

          $('#addItem').on('click', function () {
              t1.row.add([
                  '<div class="text-center d-none" value="0" name="itemId" id="item0' + itemCounter + '">추가</div>',
                  '<select size="1" id="item1' + itemCounter + '" name="mainCategory" onchange="itemChange( item1' + itemCounter + ",item2" + itemCounter + ')">' +
                  '<option value="init" selected="selected">--대분류--</option>' +
                  '<option value="상품_Oracle">상품_Oracle</option>' +
                  '<option value="상품_IBM">상품_IBM</option>' +
                  '<option value="상품_Lenovo">상품_Lenovo</option>' +
                  '<option value="상품_기타">상품_기타</option>' +
                  '<option value="용역_유지보수">용역_유지보수</option>' +
                  '<option value="용역_기술지원">용역_기술지원</option></select>',
                  '<select size="1" id="item2' + itemCounter + '" name="subCategory"> <option value="init" selected="selected">--소분류--</option>',
                  '<input type="text" name="itemName" id="item3' + itemCounter + '">',
                  '<input class="money" name="itemPrice" id="item4' + itemCounter + '">',
                  '<i class="fas fa-times-circle" name="remove" >'
              ]).draw(false);
              itemCounter++;
              $('.money').simpleMoneyFormat();
          });

          {% if items %}
              {% for item in items %}
                  t1.row.add([
                      '<div class="text-center d-none" value="0" name="itemId" id="item0' + itemCounter + '">{{ item.contractItemId }}</div>',
                      '<select size="1" id="item1' + itemCounter + '" name="mainCategory" onchange="itemChange( item1' + itemCounter + ",item2" + itemCounter + ')">' +
                      '<option value="init" selected="selected">--대분류--</option>' +
                      '<option value="상품_Oracle">상품_Oracle</option>' +
                      '<option value="상품_IBM">상품_IBM</option>' +
                      '<option value="상품_Lenovo">상품_Lenovo</option>' +
                      '<option value="상품_기타">상품_기타</option>' +
                      '<option value="용역_유지보수">용역_유지보수</option>' +
                      '<option value="용역_기술지원">용역_기술지원</option></select>',
                      '<select size="1" id="item2' + itemCounter + '" name="subCategory"> <option value="init" selected="selected">--소분류--</option>',
                      '<input type="text" name="itemName" id="item3' + itemCounter + '" value="{{ item.itemName }}">',
                      '<input class="money" name="itemPrice" id="item4' + itemCounter + '" value="{{ item.itemPrice }}">',
                      '<i class="fas fa-times-circle" name="remove" >'
                  ]).draw(false);
                  $('#item1' + itemCounter).val("{{ item.mainCategory }}").prop("selected", true);
                  itemChangeAdd("item1" + itemCounter, "item2" + itemCounter, "{{ item.subCategory }}", itemCounter);
                  itemCounter++;
                  $('.money').simpleMoneyFormat();
              {% endfor %}
          {% else %}
              $('#addItem').click();
          {% endif %}

          $('#categoryItem').on('click', 'i', function () {
              t1
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
          });

          // 매출세부정보
          var t2 = $('#revenue').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 6, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 7, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 8, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 9, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
              ],
          });

          var revenueCounter = 0;

          $('#addRevenue').on('click', function () {
              t2.row.add([
                  '<div class="text-center d-none" value="0" name="revenueId" id="revenue0' + revenueCounter + '">추가</div>',
                  '<input type="date" style="width: 150px;" name="predictBillingDate" id="revenue1' + revenueCounter + '">',
                  '<input type="date" style="width: 150px;" name="billingDate" id="revenue2' + revenueCounter + '">',
                  '<input type="date" style="width: 150px;" name="predictDepositDate" id="revenue3' + revenueCounter + '">',
                  '<input type="date" style="width: 150px;" name="depositDate" id="revenue4' + revenueCounter + '">',
                  '<input class="magicsearch" autocomplete="off" type="text" style="width: 150px;" name="revenueCompany" id="revenue5' + revenueCounter + '">',
                  '<input class="money" style="width: 140px;" name="revenuePrice" id="revenue6' + revenueCounter + '">',
                  '<input class="money" style="width: 140px;" name="revenueProfitPrice" id="revenue7' + revenueCounter + '">',
                  '<input type="text" style="width: 150px;" name="revenueComment" id="revenue8' + revenueCounter + '">',
                  '<i class="fas fa-times-circle" name="remove">'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              document.getElementById("revenue5" + revenueCounter).setAttribute("data-id", $('#saleCompanyNames').val());
              $('#revenue5' + revenueCounter).magicsearch({
                  dataSource: {{ companyNames|safe }},
                  fields: 'value',
                  id: 'id',
                  multiple: false,
                  multiField: 'value',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
              });

              revenueCounter++;
          });

          {% if revenues %}
              {% for revenue in revenues %}
                  t2.row.add([
                      '<div class="text-center d-none" value="0" name="revenueId" id="revenue0' + revenueCounter + '">{{ revenue.revenueId }}</div>',
                      '<input type="date" style="width: 150px;" name="predictBillingDate" id="revenue1' + revenueCounter + '" value="{{ revenue.predictBillingDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="billingDate" id="revenue2' + revenueCounter + '" value="{{ revenue.billingDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="predictDepositDate" id="revenue3' + revenueCounter + '" value="{{ revenue.predictDepositDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="depositDate" id="revenue4' + revenueCounter + '" value="{{ revenue.depositDate | date:"Y-m-d" }}">',
                      '<input class="magicsearch" autocomplete="off" type="text" style="width: 150px;" name="revenueCompany" id="revenue5' + revenueCounter + '" data-id="{{ revenue.revenueCompany }}">',
                      '<input class="money" style="width: 140px;" name="revenuePrice" id="revenue6' + revenueCounter + '" value="{{ revenue.revenuePrice }}">',
                      '<input class="money" style="width: 140px;" name="revenueProfitPrice" id="revenue7' + revenueCounter + '" value="{{ revenue.revenueProfitPrice }}">',
                      '<input type="text" style="width: 150px;" name="revenueComment" id="revenue8' + revenueCounter + '" value="{{ revenue.comment }}">',
                      '<i class="fas fa-times-circle" name="remove">'
                  ]).draw(false);
                  $('.money').simpleMoneyFormat();
                  $('#revenue5' + revenueCounter).magicsearch({
                      dataSource: {{ companyNames|safe }},
                      fields: 'value',
                      id: 'id',
                      multiple: false,
                      multiField: 'value',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                  });
                  revenueCounter++;
              {% endfor %}
          {% else %}
              $('#addRevenue').click();
          {% endif %}

          $('#revenue').on('click', 'i', function () {
              t2
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
          });

          // 매입세부정보
          var t3 = $('#purchase').DataTable({
              "autoWidth": true,
              "searching": false,
              "paging": false,
              "info": false,
              "scrollY": "60vh",
              "scrollX": true,
              "scrollCollapse": true,
              'fnCreatedRow': function (nRow, aData, iDataIndex) {
                  $(nRow).attr('id', 'row' + iDataIndex);
              },
              "ordering": false,
              "columnDefs": [
                  {targets: 0, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap d-none"},
                  {targets: 1, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 5, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 6, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 7, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 8, className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
              ],
          });

          var purchaseCounter = 0;

          $('#addPurchase').on('click', function () {
              t3.row.add([
                  '<div class="text-center d-none" value="0" name="purchaseId" id="purchase0' + purchaseCounter + '">추가</div>',
                  '<input type="date" style="width: 150px;" name="predictPurchaseDate" id="purchase1' + purchaseCounter + '">',
                  '<input type="date" style="width: 150px;" name="purchaseDate" id="purchase2' + purchaseCounter + '">',
                  '<input type="date" style="width: 150px;" name="predictWithdrawDate" id="purchase3' + purchaseCounter + '">',
                  '<input type="date" style="width: 150px;" name="withdrawDate" id="purchase4' + purchaseCounter + '">',
                  '<input class="magicsearch" autocomplete="off" type="text" style="width: 290px;" name="purchaseCompany" id="purchase5' + purchaseCounter + '">',
                  '<input class="money" style="width: 140px;" name="purchasePrice" id="purchase6' + purchaseCounter + '">',
                  '<input type="text" style="width: 150px;" name="purchaseComment" id="purchase7' + purchaseCounter + '">',
                  '<i class="fas fa-times-circle" name="remove">'
              ]).draw(false);
              $('.money').simpleMoneyFormat();
              $('#purchase5' + purchaseCounter).magicsearch({
                  dataSource: {{ companyNames|safe }},
                  fields: 'value',
                  id: 'id',
                  multiple: false,
                  multiField: 'value',
                  format: '%value%',
                  multiStyle: {space: 5, width: 80},
                  noResult: '검색결과없음',
                  focusShow: true,
              });

              purchaseCounter++;
          });

          {% if purchases %}
              {% for purchase in purchases %}
                  t3.row.add([
                      '<div class="text-center d-none" value="0" name="purchaseId" id="purchase0' + purchaseCounter + '">{{ purchase.purchaseId }}</div>',
                      '<input type="date" style="width: 150px;" name="predictPurchaseDate" id="purchase1' + purchaseCounter + '" value="{{ purchase.predictBillingDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="purchaseDate" id="purchase2' + purchaseCounter + '" value="{{ purchase.billingDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="predictWithdrawDate" id="purchase3' + purchaseCounter + '" value="{{ purchase.predictWithdrawDate | date:"Y-m-d" }}">',
                      '<input type="date" style="width: 150px;" name="withdrawDate" id="purchase4' + purchaseCounter + '" value="{{ purchase.withdrawDate | date:"Y-m-d" }}">',
                      '<input class="magicsearch" autocomplete="off" type="text" style="width: 290px;" name="purchaseCompany" id="purchase5' + purchaseCounter + '" data-id="{{ purchase.purchaseCompany }}">',
                      '<input class="money" style="width: 140px;" name="purchasePrice" id="purchase6' + purchaseCounter + '" value="{{ purchase.purchasePrice }}">',
                      '<input type="text" style="width: 150px;" name="purchaseComment" id="purchase7' + purchaseCounter + '" value="{{ purchase.comment }}">',
                      '<i class="fas fa-times-circle" name="remove">'
                  ]).draw(false);
                  $('.money').simpleMoneyFormat();
                  $('#purchase5' + purchaseCounter).magicsearch({
                      dataSource: {{ companyNames|safe }},
                      fields: 'value',
                      id: 'id',
                      multiple: false,
                      multiField: 'value',
                      format: '%value%',
                      multiStyle: {space: 5, width: 80},
                      noResult: '검색결과없음',
                      focusShow: true,
                  });
                  purchaseCounter++;
              {% endfor %}
          {% else %}
              $('#addPurchase').click();
          {% endif %}

          $('#purchase').on('click', 'i', function () {
              t3
                  .row($(this).parents('tr'))
                  .remove()
                  .draw();
          });

          // 이익율 자동계산
          $('#salePrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val().replace(/,/g, '');
              const profitPrice = $('#profitPrice').val().replace(/,/g, '');
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          $('#profitPrice').on("propertychange change keyup paste input", function () {
              const salePrice = $('#salePrice').val().replace(/,/g, '');
              const profitPrice = $('#profitPrice').val().replace(/,/g, '');
              $('#profitRatio').val(((profitPrice / salePrice) * 100).toFixed(1));
          });

          // 계약종료일 자동입력
          $('#contractStartDate').on("propertychange change keyup paste input", function () {
              $('#contractEndDate').val($('#contractStartDate').val())
          });

      })
  </script>

{% endblock %}