{% extends "dashboard/layout.html" %}


{% block title %}
  영업-계약이관
{% endblock %}


{% block css %}

  <style type="text/css">

    .pc-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table td, .pc-table th {
      padding: 5px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid lightgray;
      border-collapse: collapse;
    }

    .thtd {
      text-align: center;
      border: 1px solid lightgray;
      border-collapse: collapse;
    }


  </style>

{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-xl-12">
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 계약 이관 </h6>
        </div>
        <div class="card-body">
          {% csrf_token %}
          <form id="transfercontractForm" action="/sales/savetransfercontract/">
            <div class="row mb-1">
              <div class="col-1">
                <span style="font-size: 20px" class="text-secondary">기존 :  </span>
              </div>
              <div class="col-3">
                <select class="form-control" id="beforeempDeptName" name="beforeempDeptName" onchange="changeDeptName(this.value,'beforeempName')">
                  <option value="전체">----------------</option>
                  <option value="영업1팀">영업1팀</option>
                  <option value="영업2팀">영업2팀</option>
                </select>
              </div>
              <div class="col-3">
                <select class="form-control" id="beforeempName" name="beforeempName" onchange="loadContract(this.value)">
                  <option value='전체'>----------------</option>
                </select>
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-1">
                <span style="font-size: 20px" class="text-primary">변경 :  </span>
              </div>
              <div class="col-3">
                <select class="form-control" id="afterempDeptName" name="afterempDeptName" onchange="changeDeptName(this.value,'afterempName')">
                  <option value="전체">----------------</option>
                  <option value="영업1팀">영업1팀</option>
                  <option value="영업2팀">영업2팀</option>
                </select>
              </div>
              <div class="col-3">
                <select class="form-control" id="afterempName" name="afterempName">
                  <option value='전체'>----------------</option>
                </select>
              </div>
            </div>
            <br>
            <div id="contract" class="d-none">
              <h5 class="text-dark mb-3">
                <b><span>▼</span>미이관 계약</b>
              </h5>
              <table id="beforetransfer" class="pc-table">
              </table>
              <div class="text-center">
                <a href="#" class="btn btn-success btn-icon-split" onclick="btn_save()">
                  <span class="icon text-white-50"> <i class="fas fa-check"> </i> </span>
                  <span class="text"> 계약 이관 확인 </span>
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function replaceAll(str, searchStr, replaceStr) {
          if (str != null) {
              var new_str = str.split(searchStr).join(replaceStr);
              return new_str.split("T").join(" ").slice(0, 10);
          } else {
              return '-'
          }
      }

      function changeDeptName(empDeptName, selectId) {
          $.ajax({
              url: "{% url 'sales:empdept_ajax_url' %}",
              method: 'POST',
              cache: false,
              data: {"empDeptName": empDeptName},
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  var empName = returnData;
                  console.log(empName);
                  $('#' + selectId).empty();

                  $('#' + selectId).append("<option value='전체'>----------------</option>");
                  for (var count = 0; count < empName.length; count++) {
                      var option = $("<option value=" + empName[count].pk + ">" + empName[count].fields.empName + "</option>");
                      $('#' + selectId).append(option);
                  }
              }
          })
      }

      function loadContract(empId) {
          console.log(empId);
          $('#beforetransfer').empty();
          const th = "<thead>" + "<tr class='text-white' style='background-color: #36b9cc'>"
              + "<th colspan=1></th>" + "<th colspan=2>구분</th>" + "<th colspan=6>계약명</th>"
              + "<th colspan=3>계약일</th>" + "<th class=\"d-none\">contractId</th>" + "</tr>" + "</thead>";

          $('#beforetransfer').append(th);

          if (empId != '전체') {
              $.ajax({
                  url: "{% url 'sales:empid_ajax_url' %}",
                  method: 'POST',
                  cache: false,
                  data: {"empId": empId},
                  headers: {'X-CSRFToken': '{{ csrf_token }}'},
                  success: function (returnData) {
                      var contract = returnData;
                      console.log(contract);
                      for (var count = 0; count < contract.length; count++) {
                          const trId = contract[count].contractId;
                          const tr = $("<tr class='thtd' style='background-color:white' id='" + contract[count].contractId + "'><td colspan=1><input type='checkbox' name='contractcheck' value='"
                              + contract[count].contractId + "' onclick='btn_contractcheck(this.value)'></td><td colspan=2>"
                              + contract[count].contractStep + "</td><td colspan=6 class='text-left'>["
                              + contract[count].contractCode + "]" + contract[count].contractName + "</td><td colspan=3>"
                              + contract[count].contractDate + "</td>"
                              + "<td class='d-none'><input name='contractId' value='" + contract[count].contractId + "'></td></tr>"
                          );
                          $('#beforetransfer').append(tr);

                          for (var r = 0; r < contract[count].revenue.length; r++) {
                              console.log(contract[count].revenue[r].revenueId);
                              const table = "<tr name='" + contract[count].contractId + "' class='d-none'><td></td><td colspan=1><input type='checkbox' class='input"+contract[count].contractId
                                  +"' name='revenuecheck' value='"
                                  + contract[count].revenue[r].revenueId
                                  + "' onclick='btn_revenuecheck(this.value)'></td><td colspan=4>" + contract[count].revenue[r].revenueCompany_id + "</td><td colspan=3>"
                                  + replaceAll(contract[count].revenue[r].predictBillingDate) + "</td><td colspan=3>"
                                  + replaceAll(contract[count].revenue[r].billingDate) + "</td>"
                                  + "<td class='d-none'><input name='revenueId' value='" + contract[count].revenue[r].revenueId + "'></td><tr>";
                              $('#' + trId).after(table);
                          }
                          if (0 < contract[count].revenue.length) {
                              const thead = "<tr name='" + contract[count].contractId + "'class='d-none' id='th"
                                  + contract[count].contractId + "'><td></td><td style='background-color:lightsteelblue'></td>" +
                                  "<td style='background-color:lightsteelblue' colspan=4>매출처</td>" +
                                  "<td style='background-color:lightsteelblue' colspan=3>매출예정일" +
                                  "<td style='background-color:lightsteelblue' colspan=3>매출일</td></tr>";
                              $('#' + trId).after(thead);
                          }
                      }
                  }
              });
              $('#contract').attr('class', 'd-block');
          }


      }

      function btn_contractcheck(trId) {
          console.log(trId);
          contracttr = $('#' + trId);
          console.log(contracttr.css('background-color'));
          if (contracttr.css('background-color') == 'rgb(255, 255, 255)') {
              contracttr.css('background-color', 'lightyellow')
          } else {
              contracttr.css('background-color', 'white')
          }
          console.log($('tr[name=' + trId + ']').attr('class'));
          if ($('tr[name=' + trId + ']').attr('class') == 'd-none') {
              $('tr[name=' + trId + ']').attr('class', 'd-table-row');
              {#$('#th' + trId).css('background-color','lightsteelblue')#}
          } else {
              $('tr[name=' + trId + ']').attr('class', 'd-none');
              $('.input'+trId).prop("checked", false);

          }
      }

      function btn_revenuecheck(trId) {
          console.log(trId);
          {#$('tr[name=' + trId + ']').css('background-color', 'lightgrey')#}
      }

      function btn_save() {
          console.log(document.getElementById("afterempName").value);
          if (document.getElementById("afterempName").value === '' || document.getElementById("afterempName").value == '전체') {
              alert("변경할 영업 담당자를 선택해 주세요.");
              return false;
          }

          var DATA;
          $('input:checkbox[name=revenuecheck]').each(function () {
              if ($(this).is(':checked'))
                  DATA += "|" + ($(this).val());
          });

          console.log(DATA);

          if (DATA == 0) {
              alert("선택된 매출이 없습니다.");
              return false;
          }

          if (confirm("계약을 이관 하시겠습니까?") === true) {
              document.getElementById("transfercontractForm").submit();
          }

      }


      function btn_transfer() {
          var DATA;
          $('input:checkbox[name=revenuecheck]').each(function () {
              if ($(this).is(':checked'))
                  DATA += "|" + ($(this).val());
          });

      }

      $(document).ready(function () {

      });

  </script>

{% endblock %}