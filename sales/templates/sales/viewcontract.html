{% extends "dashboard/layout.html" %}
{% load humanize %}

{% block title %}
  영업관리
{% endblock %}


{% block css %}

  <style type="text/css">
    .pc-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table td, .pc-table th {
      padding: 5px;
      text-align: center;
      vertical-align: middle;
      font-size: 15px;
      border-top: 1px dotted #858796a3;
    }

    .pc-table-main {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .pc-table-main td, .pc-table-main th {
      padding: 5px;
      text-align: center;
      vertical-align: middle;
      font-size: 18px;
      border-top: 1px dotted #858796a3;
    }


    .mobile-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }

    .mobile-table td, .mobile-table th {
      padding: 4px;
      vertical-align: middle;
      font-size: 16px;
      border-top: 1px dotted #858796a3;
    }

    .thtd {
      text-align: center;
      border: 1px solid lightgray;
      border-collapse: collapse;
    }

  </style>

{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-1"></div>

    <!-- PC화면-->
    <div class="col-xl-10">
      <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h3 class="m-0 text-gray-800"> [{{ contract.contractCode }}] {{ contract.contractName }} </h3>
        </div>

        <div class="card-body">
          <h5 class="text-dark mb-3"><b> ▼ 계약내용</b></h5>
          <table class="pc-table-main">
            <tbody>
            <tr>
              <td style="width: 20%; border-top: 0px;"><b>단계</b></td>
              <td style="width: 30%; border-top: 0px;">
                {% if contract.contractStep == "Firm" %}
                  <div class="text-primary"> {{ contract.contractStep }}</div>
                {% elif contract.contractStep == "Drop" %}
                  <div class="text-danger"> {{ contract.contractStep }}</div>
                {% else %}
                  <div class="text-success"> {{ contract.contractStep }}</div>
                {% endif %}
              </td>
              <td style="width: 20%; border-top: 0px;"><b>영업담당</b></td>
              <td style="width: 30%; border-top: 0px;">{{ contract.empName }} ({{ contract.empDeptName }})</td>
            </tr>
            <tr>
              <td><b>판매유형</b></td>
              <td>{{ contract.saleType }}</td>
              <td><b>산업군</b></td>
              <td>{{ contract.saleIndustry }}</td>
            </tr>
            <tr>
              <td><b>거래처</b></td>
              <td>
                <a href="/client/viewclient/{{ contract.saleCompanyName.companyName }}" class="text-dark">
                  {{ contract.saleCompanyName.companyName }}
                </a>
                <a href="/client/viewcustomer/{{ contract.saleCustomerId.customerId }}" class="text-dark">
                  {% if contract.saleCustomerName %} ({{ contract.saleCustomerName }}){% endif %}
                </a>
              </td>
              <td><b>최종고객사</b></td>
              <td>
                <a href="/client/viewclient/{{ contract.endCompanyName.companyName }}">
                  {{ contract.endCompanyName.companyName }}
                </a>
              </td>
            </tr>
            <tr>
              <td><b>{% if contract.contractStep != 'Firm' %}예상{% endif %}계약금액</b></td>
              <td>
                <div class="text-danger">{{ contract.salePrice | intcomma }}</div>
              </td>
              <td><b>{% if contract.contractStep != 'Firm' %}예상{% endif %}이익금액</b></td>
              <td>{{ contract.profitPrice | intcomma }} ({{ contract.profitRatio }} %)</td>
            </tr>
            <tr>
              <td><b>{% if contract.contractStep != 'Firm' %}예상{% endif %}계약일</b></td>
              <td>{{ contract.contractDate }}</td>
              <td><b>계약기간</b></td>
              <td>{% if contract.contractStep == 'Firm' and contract.contractStartDate %}{{ contract.contractStartDate }} ~ {{ contract.contractEndDate }}{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td><b>참고사항</b></td>
              <td colspan="3">{% if contract.comment == None %} {% else %}{{ contract.comment }}{% endif %}</td>
            </tr>
            </tbody>
          </table>

          {% if items %}
            <br>
            <h5 class="text-dark mb-3"><b> ▼ 분류</b></h5>
            <table class="pc-table">
              <thead>
              <tr class="btn-secondary">
                <td style="width: 25%; border-top: 0px;">대분류</td>
                <td style="width: 25%; border-top: 0px;">소분류</td>
                <td style="width: 25%; border-top: 0px;">상세내용</td>
                <td style="width: 25%; border-top: 0px;">가격</td>
              </tr>
              </thead>
              <tbody>
              {% for item in items %}
                <tr class="thtd">
                  <td>{{ item.mainCategory }}</td>
                  <td>{{ item.subCategory }}</td>
                  <td>{{ item.itemName }}</td>
                  <td>{{ item.itemPrice | intcomma }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% endif %}


          <br>
          <h5 class="text-dark mb-3"><b> ▼ 년도별 매출·이익 기여도</b></h5>
          <div class="row">
            <div class="col-xl-12">
              <table class="pc-table" width="50%" style="float:left;" colspan="6">
                <thead>
                <tr class="btn-secondary">
                  <td colspan="1" style="border-top: 0px;">해당년도</td>
                  <td colspan="1" style="border-top: 0px;">매출금액</td>
                  <td colspan="1" style="border-top: 0px;">이익금액</td>
                  <td colspan="1" style="border-top: 0px;">이익율</td>
                </tr>
                </thead>
                <tr class="thtd">
                  <td colspan="1" style="border-top: 0px;">2019년</td>
                  <td colspan="1" style="border-top: 0px;">134,522,617</td>
                  <td colspan="1" style="border-top: 0px;">36,786,617</td>
                  <td colspan="1" style="border-top: 0px;">27.3%</td>
                </tr>
                <tr class="thtd">
                  <td colspan="1" style="border-top: 0px;">2020년</td>
                  <td colspan="1" style="border-top: 0px;">28,883,203</td>
                  <td colspan="1" style="border-top: 0px;">12,349,203</td>
                  <td colspan="1" style="border-top: 0px;">42.8%</td>
                </tr>
                <tr class="thtd btn-light">
                  <td colspan="1" style="border-top: 0px;">합계</td>
                  <td colspan="1" style="border-top: 0px;" class="text-danger">163,405,820</td>
                  <td colspan="1" style="border-top: 0px;" class="text-primary">49,135,820</td>
                  <td colspan="1" style="border-top: 0px;" class="text-success">30.1%</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <br>
          <h5 class="text-dark mb-3"><b> ▼ 입출금정보</b></h5>
          <table style="margin-left:20px">
            <thead>
            <tr>
              <td style="width: 25%; border-top: 0px;"><b>연도</b></td>
              <td style="width: 25%; border-top: 0px;" class='text-primary'><b>2019년</b></td>
            </tr>
            <tr>
              <td style="width: 25%; border-top: 0px;">총 수금액</td>
              <td style="width: 25%; border-top: 0px;">{{ totalDeposit.sum_deposit | intcomma }}</td>
            </tr>
            <tr>
              <td style="width: 25%; border-top: 0px;">총 지급액</td>
              <td style="width: 25%; border-top: 0px;">{{ totalWithdraw.sum_purchase | intcomma }}</td>
            </tr>
            <tr>
              <td style="width: 25%; border-top: 0px;">집행률</td>
              <td style="width: 25%; border-top: 0px;">{{ totalRatio }}%</td>
            </tr>
            </thead>
          </table>
          <br>
          <div class="row">
            <div class="col-xl-6">
              <table class="pc-table" width="50%" style="float:left;" colspan="6">
                <thead>
                <tr class="btn-secondary">
                  <td colspan="1" style="border-top: 0px;">매출처</td>
                  <td colspan="1" style="border-top: 0px;">매출액</td>
                  <td colspan="1" style="border-top: 0px;">총수금액</td>
                  <td colspan="1" style="border-top: 0px;">수금률</td>
                </tr>
                </thead>
                <tbody>
                {% for deposit in companyDeposit %}
                  <tr class="thtd">
                    <td colspan="1" style="border-top: 0px;">{% if deposit.revenueCompany == None %}-{% else %}{{ deposit.revenueCompany }}{% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if deposit.sum_deposit == None %}0{% else %}{{ deposit.sum_deposit | intcomma }} {% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if deposit.filter_deposit == None %}0{% else %}{{ deposit.filter_deposit | intcomma }} {% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if deposit.ratio_deposit == None %}0{% else %}{{ deposit.ratio_deposit }}{% endif %}%</td>
                  </tr>
                {% endfor %}
                <tr class="thtd btn-light">
                  <td colspan="1" style="border-top: 0px;">합계</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalDeposit.a_sum_deposit == None %}0{% else %}{{ companyTotalDeposit.a_sum_deposit | intcomma }} {% endif %}</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalDeposit.a_filter_deposit == None %}0{% else %}{{ companyTotalDeposit.a_filter_deposit | intcomma }} {% endif %}</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalDeposit.a_ratio_deposit == None %}0{% else %}{{ companyTotalDeposit.a_ratio_deposit }}{% endif %}%</td>
                </tr>
                </tbody>
              </table>
            </div>
            <div class="col-xl-6">
              <table class="pc-table" width="50%" style="float:left;">
                <thead>
                <tr class="btn-secondary">
                  <td colspan="1" style="border-top: 0px;">매입처</td>
                  <td colspan="1" style="border-top: 0px;">매입액</td>
                  <td colspan="1" style="border-top: 0px;">총지급액</td>
                  <td colspan="1" style="border-top: 0px;">지급률</td>
                </tr>
                </thead>
                <tbody>
                {% for Withdraw in companyWithdraw %}
                  <tr class="thtd">
                    <td colspan="1" style="border-top: 0px;">{% if Withdraw.purchaseCompany == None %}-{% else %}{{ Withdraw.purchaseCompany }}{% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if Withdraw.sum_withdraw == None %}0{% else %}{{ Withdraw.sum_withdraw | intcomma }} {% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if Withdraw.filter_withdraw == None %}0{% else %}{{ Withdraw.filter_withdraw | intcomma }} {% endif %}</td>
                    <td colspan="1" style="border-top: 0px;">{% if Withdraw.ratio_withdraw == None %}0{% else %}{{ Withdraw.ratio_withdraw }}{% endif %}%</td>
                  </tr>
                {% endfor %}
                <tr class="thtd btn-light">
                  <td colspan="1" style="border-top: 0px;">합계</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalWithdraw.a_sum_withdraw == None %}0{% else %}{{ companyTotalWithdraw.a_sum_withdraw | intcomma }} {% endif %}</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalWithdraw.a_filter_withdraw == None %}0{% else %}{{ companyTotalWithdraw.a_filter_withdraw | intcomma }} {% endif %}</td>
                  <td colspan="1" style="border-top: 0px;">{% if companyTotalWithdraw.a_ratio_withdraw == None %}0{% else %}{{ companyTotalWithdraw.a_ratio_withdraw }}{% endif %}%</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          {% if revenues %}
            <br>
            <h5 class="text-dark mb-3"><b> ▼ 매출세부정보</b></h5>
            <table class="pc-table">
              <thead>
              <tr class="btn-primary">
                <td width="5%">회차</td>
                <td width="10%">매출예정일</td>
                <td width="10%">매출일</td>
                <td width="10%">수금예정일</td>
                <td width="10%">수금일</td>
                <td width="15%">매출처</td>
                <td width="12%">매출액</td>
                <td width="13%">GP</td>
                <td width="15%">비고</td>
              </tr>
              </thead>
              <tbody>
              {% for revenue in revenues %}
                <tr {% if revenue.revenueId == revenueId %}style="background-color: #ffffc8"{% endif %} class="thtd">
                  <td class="thtd">{% if revenue.billingTime == None %}-{% else %}{{ revenue.billingTime }}{% endif %}</td>
                  <td class="thtd">{% if revenue.predictBillingDate == None %}-{% else %}{{ revenue.predictBillingDate }}{% endif %}</td>
                  <td class="thtd">{% if revenue.billingDate == None %}-{% else %}{{ revenue.billingDate }}{% endif %}</td>
                  <td class="thtd">{% if revenue.predictDepositDate == None %}-{% else %}{{ revenue.predictDepositDate }}{% endif %}</td>
                  <td class="thtd">{% if revenue.depositDate == None %}-{% else %}{{ revenue.depositDate }}{% endif %}</td>
                  <td class="thtd">{% if revenue.revenueCompany == None %}-{% else %}{{ revenue.revenueCompany }}{% endif %}</td>
                  <td class="thtd">{% if revenue.revenuePrice == None %}-{% else %}{{ revenue.revenuePrice | intcomma }}{% endif %} </td>
                  <td class="thtd">{% if revenue.revenueProfitPrice == None %}-{% else %}{{ revenue.revenueProfitPrice | intcomma }} ({{ revenue.revenueProfitRatio }}%){% endif %} </td>
                  <td class="thtd">{% if revenue.comment == None %}-{% else %}{{ revenue.comment }}{% endif %} </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% endif %}

          <div class="text-center">
            <a href="#" class="btn btn-danger btn-icon-split" onclick="btn_delete()">
              <span class="icon text-white-50"> <i class="fas fa-trash-alt"> </i> </span>
              <span class="text"> 삭제 </span>
            </a>
            <a href="#" class="btn btn-info btn-icon-split" onclick="btn_modify()">
              <span class="icon text-white-50"> <i class="fas fa-edit"> </i> </span>
              <span class="text"> 수정 </span>
            </a>
          </div>
        </div>

      </div>

    </div>

    <div class="col-xl-1"></div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">

      function btn_modify() {
          location.href = '/sales/modifycontract/' + {{ contract.contractId }} +'/';
      }

      function btn_delete() {
          if (confirm("계약 삭제시, 매출 정보까지 함께 삭제됩니다.\n삭제 하시겠습니까?") === true) {
              location.href = '/sales/deletecontract/' + {{ contract.contractId }} +'/';
          }
      }

      function trClick(trId) {
          const con = $("tr[name=" + trId + "]");
          if (con.hasClass('d-none')) {
              con.removeClass('d-none');
          } else {
              con.addClass('d-none');
          }

      }

  </script>

{% endblock %}