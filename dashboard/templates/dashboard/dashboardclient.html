{% extends "dashboard/layout.html" %}
{% block title %}
고객사 분석
{% endblock %}
{% load humanize %}


{% block css %}

<style type="text/css" xmlns="http://www.w3.org/1999/html">
  .buttons-copy {
    background-color: #4e73df;
    color: white;
    margin-bottom: 1rem;
  }

  .buttons-excel {
    background-color: #36b9cc;
    color: white;
    margin-bottom: 1rem;
  }

  .buttons-print {
    background-color: #f6c23e;
    color: white;
    margin-bottom: 1rem;
  }
</style>

{% endblock %}


{% block content %}
<!--<h3>아직 개발 진행중입니다.</h3>-->

<!-- 미수금/미접수 현황 개요 -->
<div class="py-3 d-flex flex-row align-items-center justify-content-between">
  <h3 class="mb-2 text-gray-800">고객사 분석 <span class="h6">
    {% if startdate == '' and enddate == '' %}
    [계약일 기준: 전체]
    {% else %}
    [계약일 기준:{{ startdate }} ~ {{ enddate }}]
    {% endif %}
  </span></h3>
  <div class="dropdown">
    <a class="btn btn-success" href="#" role="button" id="filterLink" data-toggle="modal" data-target="#filterModal">
      <i class="fas fa-filter d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-filter"></i> 조회</span>
    </a>
  </div>
</div>

<!-- 미수금 현황 개요 -->
<div class="row">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-sm font-weight-bold text-primary text-uppercase mb-1">총 계약금액</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ priceSummary.price| intcomma }}
              <div id="price" class="h6 d-none d-xl-block"></div>
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-won-sign fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-sm font-weight-bold text-success text-uppercase mb-1">총 이익금액</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ priceSummary.profit| intcomma }}
              <div id="profit" class="h6 d-none d-xl-block"></div>
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-won-sign fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-sm font-weight-bold text-info text-uppercase mb-1">총 지원시간</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ serviceSummary.serviceHour| floatformat:1 }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-won-sign fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-sm font-weight-bold text-warning text-uppercase mb-1">총 초과근무시간</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ serviceSummary.serviceOverHour| floatformat:1 }}
            </div>
          </div>
          <div class="col-auto">
            <i class="fas fa-won-sign fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 고객사별 매출금액 마진금액 -->
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-2">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-secondary">고객사별 계약금액&이익금액</h6>
        <span class="h6 d-xl-block d-none"><i class="text-info fas fa-palette"><span class="text-secondary small">계약금액 5억이하 </span></i>
          <i class="text-primary fas fa-palette"><span class="text-secondary small">계약금액 5억초과 10억이하 </span></i>
          <i class="text-danger fas fa-palette"><span class="text-secondary small">계약금액 10억초과</span></i></span>
        <h6 class="m-0 font-weight-bold text-secondary">[단위: 백만원]</h6>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="scatterPriceProfit"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-2">
      <div class="card-header">
        <h4 class="m-0 font-weight-bold text-secondary text-center" id="companyName"></h4>
      </div>
    </div>
  </div>
</div>
<!-- 계약금액 마진금액 -->
<div class="row">
  <div class="col-6">
    <div class="card shadow mb-2">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-secondary">계약금액/이익금액</h6>
        <h6 class="m-0 font-weight-bold text-secondary">[단위: 백만원]</h6>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="barPriceProfit"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6">
    <div class="card shadow mb-2">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-secondary">지원시간/초과근무시간</h6>
        <h6 class="m-0 font-weight-bold text-secondary">[단위: 백만원]</h6>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="barOverhour"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 계약 테이블 -->
<div class="row d-none" id="contractsRow">
  <div class="col-12">
    <div class="card shadow mb-2">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-secondary">계약상세정보</h6>
        <h6 class="m-0 font-weight-bold text-secondary">[단위: 백만원]</h6>
      </div>
      <div class="card-body">
         <table id="showcontracts" class="hover row-border" width="100%" style="width: 100%;">
              <thead>
              <tr>
                <th>구분</th>
                <th>관리번호</th>
                <th>소속</th>
                <th>영업대표</th>
                <th>계약명</th>
                <th>거래처</th>
                <th>최종고객사</th>
                <th>계약일</th>
                <th>계약금액</th>
                <th>이익금액</th>
                <th class="d-none">참고사항</th>
                <th class="d-none">계약시작일</th>
                <th class="d-none">계약종료일</th>
                <th class="d-none">종목</th>
                <th class="d-none">상세</th>
                <th class="d-none">산업군</th>
                <th class="d-none">판매유형</th>
                <th class="d-none">대금결제조건1</th>
                <th class="d-none">대금결제조건2</th>
                <th class="d-none">contractId</th>
              </tr>
              </thead>
              <tfoot>
              <tr>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right">TOTAL :</th>
                <th style="padding: 8px 10px; text-align: right"></th>
                <th style="padding: 8px 10px; text-align: right"></th>
              </tr>
              </tfoot>
            </table>
      </div>
    </div>
  </div>
</div>
<!-- 서비스 테이블 -->
<div class="row d-none" id="servicesRow">
  <div class="col-12">
    <div class="card shadow mb-2">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-secondary">지원상세이력</h6>
        <h6 class="m-0 font-weight-bold text-secondary">[단위: 시간]</h6>
      </div>
      <div class="card-body">
       <table id="showservices" class="hover row-border" style="width: 100%;">
          <thead>
          <tr>
            <th class="d-none">serviceId</th>
            <th>날짜</th>
            <th>고객사</th>
            <th>소요시간</th>
            <th>초과근무</th>
            <th>제목</th>
            <th>계약명</th>
          </tr>
          </thead>
          <tfoot>
          <tr>
            <!--<th style="padding: 8px 10px; text-align: right"></th>-->
            <th style="text-align: right"></th>
            <th style="text-align: right"></th>
            <th style="text-align: right">TOTAL :</th>
            <th style="text-align: right"></th>
            <th style="text-align: right"></th>
            <th style="text-align: right"></th>
            <th style="text-align: right"></th>
          </tr>
          </tfoot>
       </table>
      </div>
    </div>
  </div>
</div>

<!-- Filter Modal -->
  <div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">

        <div class="modal-header bg-info text-gray-100">
          <h5 class="modal-title" id="filterModalLabel">검색조건</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span class="text-gray-100" aria-hidden="true">×</span>
          </button>
        </div>

        <div class="modal-body">
          <form id="filterForm" method="POST" onkeydown="javascript: if (event.keyCode == 13) {btn_filter();}">
            {% csrf_token %}
            <div class="row mb-1">
              <div class="col-6 mb-3 mb-sm-0">
                <label for="startdate" class="text-primary">시작일자(계약일기준)</label>
                <input type="date" max="9999-12-31" class="form-control" id="startdate" name="startdate" value="{{ startdate }}">
              </div>
              <div class="col-6 mb-3 mb-sm-0">
                <label for="enddate" class="text-primary">종료일자(계약일기준)</label>
                <input type="date" max="9999-12-31" class="form-control" id="enddate" name="enddate" value="{{ enddate }}">
              </div>
            </div>
            <div class="row mb-1">
              <div class="col-12">
                <label for="endCompanyName" class="text-primary">최종고객사</label>
                <input class="form-control" id="endCompanyName" name="endCompanyName" value="{{ endCompanyName }}">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
          <a class="btn btn-info" href="#" onclick="btn_filter()">검색</a>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block script %}
<script src="/static/hr/js/demo/chart-bar-demo.js"></script>
<script src="/static/hr/js/demo/chart-area-demo.js"></script>
<script src="/static/hr/js/demo/chart-pie-demo.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.4.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-piechart-outlabels"></script>

<script>
    let showcontracts;
    let showservices;

    function btn_filter() {
        document.getElementById("filterForm").submit();
    }

    function replaceAll(str, searchStr, replaceStr) {
          var new_str = str.split(searchStr).join(replaceStr);
          return new_str.split("T").join(" ").slice(0, 10);
    }

    function viewKorean(num) {
        var hanA = new Array("", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10");
        var danA = new Array("", "십", "백", "천", "", "십", "백", "천", "", "십", "백", "천", "", "십", "백", "천");
        var result = "";
        for (i = 0; i < num.length; i++) {
            str = "";
            han = hanA[num.charAt(num.length - (i + 1))];
            // if (han != "") str += han + danA[i];
            if (han != "") str += han;
            if (i == 4) str += "만 ";
            if (i == 8) str += "억 ";
            if (i == 12) str += "조 ";
            result = str + result;
        }
        if (num != 0) result = result + "원";
        return "(" + result + ")";
    }

    function removeData() {
        barPriceProfit.data = {
            labels: ['계약금액', '이익금액'],
            datasets: [],
        };
        barPriceProfit.update();
        barOverhour.data = {
            labels: ["지원시간", "초과근무시간"],
            datasets: [],
        };
        barOverhour.update();
    }

    function pushServiceTable(table) {
        $.ajax({
            url: "{% url 'dashboard:services_ajax_url' %}",
            method: 'POST',
            cache: false,
            data: {
                'startdate': '{{ startdate| date:'Y-m-d' }}',
                'enddate': '{{ enddate| date:'Y-m-d' }}',
                'companyName': filterArray['companyName'],
            },
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function (returnData) {
                for (var i = 0; i < returnData.length; i++) {
                    table.row.add(returnData[i])
                }
                table.draw()
            }
        });
    }

    function pushContractTable(table) {
        $.ajax({
            url: "{% url 'dashboard:contracts_ajax_url' %}",
            method: 'POST',
            cache: false,
            data: {
                'startdate': '{{ startdate| date:'Y-m-d' }}',
                'enddate': '{{ enddate| date:'Y-m-d' }}',
                'companyName': filterArray['companyName'],
            },
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function (returnData) {
                for (var i = 0; i < returnData.length; i++) {
                    table.row.add(returnData[i])
                }
                table.draw()
            }
        });
    }

    function pushData() {

          $.ajax({
              url: "{% url 'dashboard:client_ajax_graph' %}",
              method: 'POST',
              cache: false,
              data: {
                  'startdate': '{{ startdate| date:'Y-m-d' }}',
                  'enddate': '{{ enddate| date:'Y-m-d' }}',
                  'companyName': filterArray['companyName'],
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  const company = returnData[0];
                  const service = returnData[1];
                  barPriceProfit.data.datasets.push({
                    label: "계약금액",
                    backgroundColor: "#4365B0",
                    borderColor: "#4365B0",
                    data: [company.price, 0]
                    }, {
                    label: '이익금액',
                    backgroundColor: '#F29220',
                    borderColor: "#F29220",
                    data: [0, company.profit]
                  });
                  barPriceProfit.update();
                  barOverhour.data.datasets.push({
                    label: "지원시간",
                    backgroundColor: "#1CC88A",
                    borderColor: "#1CC88A",
                    data: [service.servicehour, 0]
                    },{
                    label: '초과근무시간',
                    backgroundColor: '#E74A3B',
                    borderColor: "#E74A3B",
                    data: [0, service.overhour]
                  });
                  barOverhour.update();
              }
          });
      }

    const price = '{{ priceSummary.price }}';
    const profit = '{{ priceSummary.profit }}';
    const spanPrice = $('#price');
    const spanProfit = $('#profit');

    spanPrice.text(viewKorean(price));
    spanProfit.text(viewKorean(profit));

    const filterArray = new Array();
    filterArray['companyName'] = '';
    filterArray['contract'] = '';
    filterArray['service'] = '';

    // 매출금액 마진금액 산포도
    var ctx = document.getElementById("scatterPriceProfit").getContext('2d');
    const scatteroptions = {
        legend: {display:false},
        maintainAspectRatio: false,
        plugins: {
            datalabels: {
                align: 'end',
                anchor: 'end',
                color: function (context) {
                    return context.dataset.backgroundColor;
                },
                font: function (context) {
                    var w = context.chart.width;
                    return {
                        size: w < 512 ? 12 : 14
                    };
                },
                formatter: function (value, context) {
                    if (window.innerWidth < 400) {
                        return ''
                    } else {
                        // return context.dataset.label;
                        if(context.dataset.data[0].x>50000000){
                            return context.dataset.label;
                        }else{
                            return ''
                        }
                    }
                }
            },
        },
        layout: {
            padding: {
                left: 0,
                right: 0,
                top: 0,
                bottom: 0
            }
        },
        responsive: true,
        maintainAspectRatio: false,
        pan: {
          enabled: true,
          mode: "x",
          speed: 10,
          threshold: 10
        },
        zoom: {
          enabled: true,
          drag: false,
          mode: "xy",
          limits: {
            max: 10,
            min: 0.5
          }
        },
        scales: {
            xAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: "이익금액"
                },
                ticks: {
                    min: 0,
                    maxTicksLimit: 5,
                    padding: 5,
                    callback: function (value, index, values) {
                        return number_format(value).slice(0, -8);
                    }
                },
                gridLines: {
                    display: true,
                    drawBorder: true
                },
            }],
            yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: "계약금액"
                },
                ticks: {
                    min: 0,
                    maxTicksLimit: 5,
                    padding: 5,
                    callback: function (value, index, values) {
                        return number_format(value).slice(0, -8);
                    }
                },
                gridLines: {
                    color: "rgb(234, 236, 244)",
                    zeroLineColor: "rgb(234, 236, 244)",
                    drawBorder: true,
                    borderDash: [2],
                    zeroLineBorderDash: [2]
                }
            }],
        },
        tooltips: {
            titleMarginBottom: 5,
            titleFontColor: '#6e707e',
            titleFontSize: 14,
            backgroundColor: "rgb(255,255,255)",
            bodyFontColor: "#323339",
            borderColor: '#dddfeb',
            borderWidth: 3,
            xPadding: 15,
            yPadding: 15,
            displayColors: true,
            caretPadding: 10,
            callbacks: {
                label: function (tooltipItem, chart) {
                    return '총 계약금액: ' + number_format(tooltipItem.yLabel) + '\n 총 이익금액: ' + number_format(tooltipItem.xLabel);
                }
            }
        }
    };

    // End Defining data
    var scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
            {% for company in companySummary %}
            {
                label: '{{ company.endCompanyName__companyNameKo }}',
                data: [{
                      x: {{ company.profit }},
                      y: {{ company.price }}
                }],
                {% if company.price > 1000000000 %}
                borderColor: '#e1e3ee',
                backgroundColor: '#F67A15',
                {% elif company.price <= 1000000000 and company.price > 500000000 %}
                borderColor: '#e1e3ee',
                backgroundColor: '#4e73df'
                {% else %}
                borderColor: '#e1e3ee',
                backgroundColor: '#36b9cc'
                {% endif %}
            },
            {% endfor %}
            ]
        },
        options: scatteroptions
    });

    $("#scatterPriceProfit").click(
      function (evt) {
          const activeElement = scatterChart.getElementAtEvent(evt);
          const idx = activeElement[0]._index;
          const datasetIndex = activeElement[0]._datasetIndex;
          const companyLabel = scatterChart.data.datasets[datasetIndex].label;
          $('#companyName').text(companyLabel);
          filterArray['companyName'] = companyLabel;
          removeData();
          pushData();
          $('#servicesRow').attr('class', 'row d-none');
          $('#contractsRow').attr('class', 'row d-none');
      }
    );

    // Bar Chart 1
    const ctx1 = document.getElementById("barPriceProfit");
    const barPriceProfit = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: ["계약금액", "이익금액"],
            datasets: [{
                label: "계약금액",
                backgroundColor: "#4365B0",
                borderColor: "#4365B0",
                data: [{{ priceSummary.price }}, '']
            },{
                label: "이익금액",
                backgroundColor: "#F29220",
                borderColor: "#F29220",
                data: ['', {{ priceSummary.profit }}]
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                datalabels: {
                    align: 'end',
                    anchor: 'end',
                    color: function (context) {
                        return context.dataset.backgroundColor;
                    },
                    font: function (context) {
                        var w = context.chart.width;
                        return {
                            size: w < 512 ? 12 : 14
                        };
                    },
                    formatter: function(value, context) {
                        if (window.innerWidth < 400) {
                            return ''
                        } else {
                            return number_format(value).slice(0, -8);
                        }
                    }
                }
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0
                }
            },
            scales: {
                xAxes: [{
                    stacked: true,
                    time: {
                        unit: 'week'
                    },
                    gridLines: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        maxTicksLimit: 8
                    },
                    maxBarThickness: 30,
                }],
                yAxes: [{
                    stacked: false,
                    ticks: {
                        min: 0,
                        maxTicksLimit: 5,
                        padding: 5,
                        // Include a dollar sign in the ticks
                        callback: function (value, index, values) {
                            return number_format(value).slice(0, -8);
                        }
                    },
                    gridLines: {
                        color: "rgb(234, 236, 244)",
                        zeroLineColor: "rgb(234, 236, 244)",
                        drawBorder: false,
                        borderDash: [2],
                        zeroLineBorderDash: [2]
                    }
                }],
            },
            tooltips: {
                titleMarginBottom: 5,
                titleFontColor: '#6e707e',
                titleFontSize: 14,
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#4e73df",
                borderColor: '#dddfeb',
                borderWidth: 3,
                xPadding: 15,
                yPadding: 15,
                displayColors: true,
                caretPadding: 10,
                callbacks: {
                    label: function (tooltipItem, chart) {
                        return ' ' + number_format(tooltipItem.yLabel);
                    }
                }
            }
        }
    });

    $("#barPriceProfit").click(
        function (evt) {
            showcontracts.clear().draw();
            $('#servicesRow').attr('class', 'row d-none');
            $('#contractsRow').attr('class', 'row d-block');
            pushContractTable(showcontracts);
        }
    );

    // Bar Chart 2
    const ctx2 = document.getElementById("barOverhour");
    const barOverhour = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ["지원시간", "초과근무시간"],
            datasets: [{
                label: "지원시간",
                backgroundColor: "#1CC88A",
                borderColor: "#1CC88A",
                data: [{{ overhourSummary.servicehour }}, '']
            },{
                label: "초과근무시간",
                backgroundColor: "#E74A3B",
                borderColor: "#E74A3B",
                data: ['', {{ overhourSummary.overhour }}]
            }],
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                datalabels: {
                    align: 'end',
                    anchor: 'end',
                    color: function (context) {
                        return context.dataset.backgroundColor;
                    },
                    font: function (context) {
                        var w = context.chart.width;
                        return {
                            size: w < 512 ? 12 : 14
                        };
                    },
                    formatter: function(value, context) {
                        if (window.innerWidth < 400) {
                            return ''
                        } else {
                            if(value != 0){
                                return number_format(value);
                            }else{
                                return ''
                            }
                        }
                    }
                }
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0
                }
            },
            scales: {
                xAxes: [{
                    stacked: true,
                    time: {
                        unit: 'week'
                    },
                    gridLines: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        maxTicksLimit: 8
                    },
                    maxBarThickness: 30,
                }],
                yAxes: [{
                    stacked: false,
                    ticks: {
                        min: 0,
                        maxTicksLimit: 5,
                        padding: 5,
                        // Include a dollar sign in the ticks
                        callback: function (value, index, values) {
                            return number_format(value).slice(0, -8);
                        }
                    },
                    gridLines: {
                        color: "rgb(234, 236, 244)",
                        zeroLineColor: "rgb(234, 236, 244)",
                        drawBorder: false,
                        borderDash: [2],
                        zeroLineBorderDash: [2]
                    }
                }],
            },
            tooltips: {
                titleMarginBottom: 5,
                titleFontColor: '#6e707e',
                titleFontSize: 14,
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#4e73df",
                borderColor: '#dddfeb',
                borderWidth: 3,
                xPadding: 15,
                yPadding: 15,
                displayColors: true,
                caretPadding: 10,
                callbacks: {
                    label: function (tooltipItem, chart) {
                        return ' ' + number_format(tooltipItem.yLabel);
                    }
                }
            }
        },
    });
    $("#barOverhour").click(
        function (evt) {
            showservices.clear().draw();
            $('#servicesRow').attr('class', 'row d-block');
            $('#contractsRow').attr('class', 'row d-none');
            pushServiceTable(showservices);
        }
    );

   $(document).ready(function () {
       showservices = $('#showservices').DataTable({
            "processing": true,
            "ajax": {
                "processing": true,
                "type": 'POST',
                "data": {
                    'startdate': '{{ startdate| date:'Y-m-d' }}',
                    'enddate': '{{ enddate| date:'Y-m-d' }}',
                    'companyName': filterArray['companyName'],
                },
                "url": "{% url 'dashboard:services_ajax_url' %}",
                "dataSrc": ""
            },

            "columns": [
                {data: "serviceId"},
                {data: "serviceDate"},
                {data: "companyName__companyName"},
                {data: "serviceHour"},
                {data: "serviceOverHour"},
                {data: "serviceTitle"},
                {
                   data: 'contractId__contractName',
                    render: function (data, type, row) {
                        if(row["contractId__contractCode"]!=null){
                            return '[' + row["contractId__contractCode"] + '] ' + row["contractId__contractName"];
                        }
                        else{
                            return '[미지정] 계약명미지정';
                        }
                    }
                },
            ],
            "columnDefs": [
                {targets: 0, className: "d-none"},
                {targets: 1, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 2, width: "20%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
                {targets: 3, width: "5%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 4, width: "5%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 5, width: "25%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
                {targets: 5, width: "35%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
            ],
            "deferRender": true,
            "searching": true,
            "paging": true,
            "info": false,
            "scrollY": "60vh",
            "scrollX": true,
            "scrollCollapse": true,
            "order": [[1, 'desc']],
            "language": {
                "lengthMenu": "_MENU_ 개씩 보기",
                "search": "검색:",
                "paginate": {
                    "first": "처음",
                    "last": "끝",
                    "next": "다음",
                    "previous": "이전"
                },
            },
            "footerCallback": function () {
                var api = this.api(), data;

                var hourResult = 0;
                api.column(3, {search: 'applied'}).data().each(function (data, index) {
                    hourResult += parseFloat(data);
                });
                $(api.column(3).footer()).html(hourResult.toLocaleString());

                var overhourResult = 0;
                api.column(4, {search: 'applied'}).data().each(function (data, index) {
                    overhourResult += parseFloat(data);
                });
                $(api.column(4).footer()).html(overhourResult.toLocaleString());
            },
        });
         var showserviceTable = $('#showservices').DataTable();

        $("#showservices").on("click", 'tr', function () {
            const data = showserviceTable.row(this).data();
            window.open('about:blank').location.href = '/service/viewservice/' + data.serviceId + '/'
        });

        //계약 테이블
        showcontracts = $('#showcontracts').DataTable({
            "processing": true,
            "ajax": {
                "processing": true,
                "type": 'POST',
                "data": {
                    'startdate': '{{ startdate| date:'Y-m-d' }}',
                    'enddate': '{{ enddate| date:'Y-m-d' }}',
                    'companyName': filterArray['companyName'],
                },
                "url": "{% url 'dashboard:contracts_ajax_url' %}",
                "dataSrc": ""
            },
            "columns": [
                {data: "contractStep"},
                {data: "contractCode"},
                {data: "empDeptName"},
                {data: "empName"},
                {data: "contractName"},
                {data: "saleCompanyName__companyNameKo"},
                {data: "endCompanyName__companyNameKo"},
                {data: "contractDate"},
                {data: "salePrice"},
                {data: "profitPrice"},
                {data: "comment"},
                {data: "contractStartDate"},
                {data: "contractEndDate"},
                {data: "mainCategory"},
                {data: "subCategory"},
                {data: "saleIndustry"},
                {data: "saleType"},
                {data: "depositCondition"},
                {data: "depositConditionDay"},
                {data: "contractId"},
            ],
            "columnDefs": [
                {targets: 0, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 1, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 2, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 3, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 4, width: "10%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
                {targets: 5, width: "10%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
                {targets: 6, width: "10%", className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap"},
                {targets: 7, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                {targets: 8, width: "10%", className: "dt-head-center dt-body-right dt-head-nowrap dt-body-nowrap"},
                {targets: 9, width: "10%", className: "dt-head-center dt-body-right dt-head-nowrap dt-body-nowrap"},
                {targets: 10, visible: false},
                {targets: 11, visible: false},
                {targets: 12, visible: false},
                {targets: 13, visible: false},
                {targets: 14, visible: false},
                {targets: 15, visible: false},
                {targets: 16, visible: false},
                {targets: 17, visible: false},
                {targets: 18, visible: false},
                {targets: 19, visible: false},
            ],
            dom: 'Blfrtip',
            buttons: [
                {
                    extend: 'excel',
                    text: '엑셀',
                    footer: true
                },
                {
                    extend: 'copy',
                    text: '복사',
                    footer: true
                },
                {
                    extend: 'print',
                    text: '인쇄',
                    footer: true
                }
            ],
            "deferRender": true,
            "order": [[1, 'desc']],
            "searching": true,
            "paging": true,
            "info": false,
            "scrollY": "80vh",
            "scrollX": true,
            "scrollCollapse": true,
            "language": {
                "lengthMenu": "_MENU_개씩 보기",
                "search": "검색:",
                "zeroRecords": "결과 없음",
                "processing": "로딩중",
                "paginate": {
                    "first": "처음",
                    "last": "끝",
                    "next": "→",
                    "previous": "←"
                },
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                $('td:eq(7)', nRow).text(replaceAll(aData.contractDate, "-", "."));
                if (aData.contractStep == 'Firm') {
                    $('td:eq(0)', nRow).css('color', '#4e73df');
                } else if (aData.contractStep == 'Opportunity') {
                    $('td:eq(0)', nRow).css('color', '#1cc88a');
                }
                $('td:eq(8)', nRow).text(aData.salePrice.toLocaleString());
                $('td:eq(9)', nRow).text(aData.profitPrice.toLocaleString());
            },
            "footerCallback": function () {
                var api = this.api(), data;

                var saleResult = 0;
                api.column(8, {search: 'applied'}).data().each(function (data, index) {
                    saleResult += parseFloat(data);
                });
                $(api.column(8).footer()).html(saleResult.toLocaleString());

                var profitResult = 0;
                api.column(9, {search: 'applied'}).data().each(function (data, index) {
                    profitResult += parseFloat(data);
                });
                $(api.column(9).footer()).html(profitResult.toLocaleString());
            },
        });

        const contractsTable = $('#showcontracts').DataTable();

        $("#showcontracts").on("click", 'tr', function () {
            const data = contractsTable.row(this).data();
            window.open('about:blank').location.href = '/sales/viewcontract/' + data.contractId + '/'
        });
    });

</script>
{% endblock %}