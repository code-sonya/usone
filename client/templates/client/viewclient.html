{% extends "dashboard/layout.html" %}


{% block title %}
  고객사 정보
{% endblock %}


{% block css %}

  <style type="text/css">

    .table {
      color: #333333;
    }

    .table td, .table th {
      padding: .75rem;
      vertical-align: middle;
      border-top: 1px solid #e3e6f0;
      text-align: center;
      white-space: nowrap;
    }

  </style>

{% endblock %}


{% block content %}

  <div class="row">
    <div class="col-xl-1"></div>
    <!-- PC화면 -->
    <div class="col-xl-10 d-xl-block">
      <div class="card shadow mb-4">
        <!-- 카드 제목 : 게시물 제목 -->
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> {{ company.companyName }} </h6>
        </div>
        <!-- 카드 본문 -->
        <div class="card-body">
          {% csrf_token %}
          <table class="table mb-0" width="100%" style="color:black">

            <tbody>
            <tr class="row">
              <td class="col-2"><b>영업대표</b></td>
              <td class="col-10">{{ company.saleEmpId.empName }}</td>
            </tr>

            <tr class="row">
              <td class="col-2"><b>주소</b></td>
              <td class="col-10">{{ company.companyAddress }}</td>
            </tr>

            <tr class="row">
              <th class="col-2">계약만료일</th>
              <td class="col-10">
                <table class="table table" style="margin-bottom: 0px">
                  <thead>
                  <tr class="row">
                    <td class="col-6"><B>DB지원팀</B></td>
                    <td class="col-6"><B>SOLUTION지원</B></td>
                  </tr>
                  </thead>
                  <tbody>
                  <tr class="row">
                    <td class="col-6">{% if company.dbContractEndDate %}{{ company.dbContractEndDate }}{% else %}-{% endif %}</td>
                    <td class="col-6">{% if company.solutionContractEndDate %}{{ company.solutionContractEndDate }}{% else %}-{% endif %}</td>
                  </tr>
                  </tbody>
                </table>
              </td>
            </tr>
            <tr class="row">
              <th class="col-2">담당자</th>
              <td class="col-10">
                {% for customer in customers %}
                  <a href="/client/customer/{{ customer.pk }}">
                    {{ customer.customerName }} ({{ customer.customerPhone }}) </a> <br>
                {% endfor %}
              </td>
            </tr>

            <tr class="row">
              <th class="col-2">엔지니어</th>
              <td class="col-10">
                <table class="table table" style="margin-bottom: 0px">
                  <thead>
                  <tr class="row">
                    <td class="col-3"><B>DB 담당자(정)</B></td>
                    <td class="col-3"><B>DB 담당자(부)</B></td>
                    <td class="col-3"><B>SYSTEM 담당자(정)</B></td>
                    <td class="col-3"><B>SYSTEM 담당자(부)</B></td>
                  </tr>
                  </thead>
                  <tbody>
                  <tr class="row">
                    <td class="col-3">{% if company.dbMainEmpId %}{{ company.dbMainEmpId.empName }}{% else %}-{% endif %}</td>
                    <td class="col-3">{% if company.dbSubEmpId %}{{ company.dbSubEmpId.empName }}{% else %}-{% endif %}</td>
                    <td class="col-3">{% if company.solutionMainEmpId %}{{ company.solutionMainEmpId.empName }}{% else %}-{% endif %}</td>
                    <td class="col-3">{% if company.solutionSubEmpId %}{{ company.solutionSubEmpId.empName }}{% else %}-{% endif %}</td>
                  </tr>
                  </tbody>
                </table>
              </td>
            </tr>

            <tr class="row">
              <td class="col-2"><b>DB COMMNET</b></td>
              <td class="col-10">
                <p id="comment_text">
                  {% if company.dbComment %}{{ company.dbComment }}{% else %}{% endif %}
                </p>
                {% if user.employee.empId == company.dbMainEmpId.empId or user.employee.empId == company.dbSubEmpId.empId %}
                  <textarea id="dbtextArea" style="background-color: lightgoldenrodyellow;display: none" class="form-control" rows="3"> </textarea>
                  <button id="dbcomment" style="background-color: lightseagreen" algin="right" class="btn btn-info" onclick="db_comment()">COMMNET작성</button>
                  <br>
                  <button id="dbcommentSave" style="background-color: lightseagreen;display: none" algin="right" class="btn btn-success" onclick="db_save()">저장</button>
                {% endif %}
              </td>
            </tr>

            <tr class="row">
              <th class="col-2">DB정보</th>
              <td class="col-10">
                <table class="table table">
                  <thead>
                  <tr>
                    <td><b>CLASSIFICATION</b></td>
                    <td><b>SID</b></td>
                    <td><b>VERSION</b></td>
                    <td><b>DBTYPE</b></td>
                    <td><b>OSTYPE</b></td>
                    <td><b>APPLIANCE</b></td>
                    <td><b>DUPLICATION</b></td>
                    <td><b>DATASIZE_MB</b></td>
                    <td><b>REMARKS</b></td>
                  </tr>
                  </thead>

                  <tbody>
                  {% for db in dbms %}
                  <tr>
                    <td> {{ db.CLASSIFICATION }} </td>
                    <td> {{ db.SID }} </td>
                    <td> {{ db.VERSION }} </td>
                    <td> {{ db.DBTYPE }} </td>
                    <td> {{ db.OSTYPE }} </td>
                    <td> {{ db.APPLIANCE }} </td>
                    <td> {{ db.DUPLICATION }} </td>
                    <td> {{ db.DATASIZE_MB }} </td>
                    <td> {{ db.REMARKS }} </td>
                  </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </td>
            </tr>

            <tr class="row">
              <th class="col-2">시스템정보</th>
              <td class="col-10">{{ company.companySystem }}</td>
            </tr>
            <tr class="row">
              <th class="col-2">SYSTEM COMMENT</th>
              <td class="col-10">
                <p id="sol_comment_text">
                  {% if company.SolutionComment %}{{ company.SolutionComment }}{% else %}{% endif %}
                </p>
                {% if user.employee.empId == company.solutionMainEmpId.empId or user.employee.empId == company.solutionSubEmpId.empId %}
                  <textarea id="soltextArea" style="background-color: lightgoldenrodyellow;display: none" class="form-control" rows="3"> </textarea>
                  <button id="solcomment" style="background-color: lightseagreen" algin="right" class="btn btn-info" onclick="sol_comment()">COMMENT작성</button><br>
                  <button id="solcommentSave" style="background-color: lightseagreen;display: none" algin="right" class="btn btn-success" onclick="sol_save()">저장</button>
                {% endif %}
              </td>
            </tr>
            </tbody>
          </table>

        </div>
        <!--card body end -->
      </div>
      <div class="card shadow mb-4">
        <!-- 카드 제목 : 게시물 제목 -->
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 h3 text-gray-800"> 이력 </h6>
        </div>
        <!-- 카드 본문 -->
        <div class="card-body">
        <table id="showclients" class="table mb-0" width="100%" style="color:black">
            <thead>
            <tr>
              <th>날짜</th>
              <th>엔지니어</th>
              <th>지원타입</th>
              <th>지원내용</th>
              <th class="d-none">serviceId</th>
            </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">
      $(document).ready(function () {

          const table = $('#showclients').DataTable({
              data: [],
              columns: [
                  {data: "날짜"},
                  {data: "엔지니어"},
                  {data: "지원타입"},
                  {data: "지원내용"},
                  {data: "serviceId"},
              ],
              columnDefs: [
                  {targets: 0, width: "20%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 1, width: "20%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 2, width: "10%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 3, width: "50%", className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap"},
                  {targets: 4, visible: false}
              ],
              "order": [[4, 'desc']],
              "searching": true,
              "paging": true,
              "info": false,
              "scrollY": "80vh",
              "scrollCollapse": true,
              "language": {
                  "lengthMenu": "_MENU_ 개씩 보기",
                  "search": "검색:",
                  "paginate": {
                      "first": "처음",
                      "last": "끝",
                      "next": "다음",
                      "previous": "이전"
                  },
              }
          });

          {% for service in services %}
              var rowNode = table.row.add({
                  "날짜": "{{ service.serviceDate }}",
                  "엔지니어": "{{ service.empName }}",
                  "지원타입": "{{ service.serviceType }}",
                  "지원내용": "{{ service.serviceTitle }}",
                  "serviceId": "{{ service.serviceId }}",
              }).draw().node();

          {% endfor %}

          $("#showclients").on("click", 'tr', function () {
              const data = table.row(this).data();
              location.href = '/service/viewservice/' + data.serviceId + '/'
          });

      });


      function db_comment() {
          $('#dbcommentSave').css("display", "inline");
          $('#dbtextArea').css("display", "inline");
          $('#dbcomment').css("display", "none");
      }

      function sol_comment() {
          $('#solcommentSave').css("display", "inline");
          $('#soltextArea').css("display", "inline");
          $('#solcomment').css("display", "none");
      }


  </script>

{% endblock %}