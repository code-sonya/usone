{% extends "dashboard/layout.html" %}


{% block title %}
  도서관리
{% endblock %}


{% block css %}

  <style type="text/css">

  </style>

{% endblock %}


{% block content %}

  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h6 class="m-0 h3 text-gray-800">도서신청</h6>
    </div>

    <div class="card-body">
      <div class="mb-3">
        <h5>▼ <span class="text-primary font-weight-bold">소장 도서 목록</span></h5>
      </div>
      <form id="postrentform" class="d-none" method="POST" action="/supply/postrent/">{% csrf_token %}</form>
      <div class="table-responsive">
        <table id="showbooks" class="hover row-border" style="width: 100%;">
          <thead>
          <tr style="background-color: #deeef8; color: black;">
            <th>도서명</th>
            <th>권수</th>
            <th>지은이</th>
            <th>출판사</th>
            <th>상태</th>
            <th>반납예정일</th>
            <th>신청</th>
          </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">
      function replaceAll(str, searchStr, replaceStr) {
          var new_str = str.split(searchStr).join(replaceStr);
          return new_str.split("T").join(" ").slice(0, 10);
      }

      function btn_rent(bookId, type) {
          const form = $('#postrentform');
          $('<input />', {
              type: 'hidden',
              name: 'type',
              value: type
          }).appendTo(form);  // type
          $('<input />', {
              type: 'hidden',
              name: 'bookId',
              value: bookId
          }).appendTo(form);  // bookId
          form.submit();
      }

      $(document).ready(function () {
          const reportsTable = $('#showbooks').DataTable({
              "processing": true,
              "ajax": {
                  "processing": true,
                  "type": 'POST',
                  "data": {
                  },
                  "url": "{% url 'supply:booksasjson' %}",
                  "dataSrc": ""
              },
              "columnDefs": [
                  {
                      targets: 0,
                      width: "30%",
                      className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap",
                      data: "name",
                  },
                  {
                      targets: 1,
                      width: "5%",
                      className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      data: "code",
                  },
                  {
                      targets: 2,
                      width: "10%",
                      className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap",
                      data: "author",
                  },
                  {
                      targets: 3,
                      width: "20%",
                      className: "dt-head-center dt-body-left dt-head-nowrap dt-body-nowrap",
                      data: "publisher",
                  },
                  {
                      targets: 4,
                      width: "10%",
                      className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      data: "status",
                  },
                  {
                      targets: 5,
                      width: "20%",
                      className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      data: "rentalId__predictReturnDate",
                  },
                  {
                      targets: 6,
                      width: "5%",
                      className: "dt-head-center dt-body-center dt-head-nowrap dt-body-nowrap",
                      data: null,
                  },
              ],
              "deferRender": true,
              "order": [[0, 'asc']],
              "searching": true,
              "paging": true,
              "info": false,
              "scrollY": "80vh",
              "scrollX": true,
              "scrollCollapse": true,
              "language": {
                  "lengthMenu": "_MENU_개씩 보기",
                  "search": "검색:",
                  "zeroRecords": "결과 없음",
                  "processing": "로딩중",
                  "paginate": {
                      "first": "처음",
                      "last": "끝",
                      "next": "→",
                      "previous": "←"
                  },
              },
              "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                  let row = $('td', nRow);
                  if (aData.status === 'Y') {
                      row.eq(4).text('대여가능');
                      row.eq(6).html(
                          '<a class="btn btn-primary" href="#" onclick="btn_rent(' + aData.bookId + ', \'rent\')">' +
                          '<i class="fas fa-check d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-check"></i> 신청</span></a>'
                      );
                  } else if (aData.status === 'N') {
                      row.eq(4).text('대출중');
                      if (aData.rentalId__renter__empId === {{ user.employee.empId }}) {
                          row.eq(6).html(
                              '<a class="btn btn-danger" href="#" onclick="btn_rent(' + aData.bookId + ', \'return\')">' +
                              '<i class="fas fa-check d-xl-none"></i><span class="d-none d-xl-block"><i class="fas fa-check"></i> 반납</span></a>'
                          );
                      } else{
                          row.eq(6).text('대출중');
                      }
                  }
                  if (!aData.rentalId__predictReturnDate) {
                      row.eq(5).text('-')
                  }
              },
          });

          $("#showreports").on("click", 'tr', function () {
              const data = reportsTable.row(this).data();
          });
      });

  </script>

{% endblock %}