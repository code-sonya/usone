{% extends "dashboard/layout.html" %}


{% block title %}
 권한관리
{% endblock %}


{% block css %}

  <style type="text/css">

    .pc-table {
      color: #333333;
      table-layout: fixed;
      width: 100%;
      border: 1px solid lightgray;
      margin-bottom: 1rem;
    }

    .pc-table td, .pc-table th {
      padding: 10px 4px 10px 4px;
      text-align: center;
      vertical-align: middle;
      font-size: 15px;
      border: 1px solid lightgray;
    }

  </style>

{% endblock %}


{% block content %}

  <div>
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 h3 text-gray-800">권한관리</h6>
      </div>
      <div class="card-body">
        <div style="font-size:20px" class="text-primary ml-3 mr-3">기본 권한<span class="text-secondary small"> (모든 사용자에게 기본 권한이 부여됩니다.) </span></div>
        <form id="defaultForm" method="POST">
          <div class="row m-1">
            <div class="col-xl-11">
              <select id="defaultAuth" name="defaultAuth" class="multi-select m-3" multiple="multiple">
                {% for menu in menus %}
                <option value="{{ menu.menuId }}" {% if menu.defaultStatus == 'Y' %} selected {% endif %}>
                  {{ menu.subCategory }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-xl-1 text-center">
              <button class="btn btn-primary" onclick="btn_default()">설정</button>
            </div>
          </div>
        </form>
        <div class="table-responsive" id="table_container">
          <table id="showauthorizations" class="hover row-border pc-table m-3" style="width: 100%">
            <thead>
            <tr>
              <td style="width: 50px;" class="bg-light">No</td>
              <td style="width: 120px;" class="bg-light">직원명</td>
              <td style="width: 80px;" class="bg-warning text-white">전체권한</td>
              {% for menu in menus %}
                {% if menu.defaultStatus == "Y" %}
                <td style="width: 120px" class="bg-info text-white">
                  {{ menu.subCategory }}
                </td>
                {% else %}
                <td style="width: 120px" class="bg-light">
                  {{ menu.subCategory }}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
            </thead>
            {% for authorization in authorizations %}
            <tr id="{{ authorization.empId }}">
<!--              <td><input type="checkbox" class="checkBtnAll"></td>-->
              {% for key, value in authorization.items %}
                {% if key == 'all' %}
                <td>
                  <input type="checkbox" {% if value == "Y" %} checked {% endif %} class="checkBtnAll" name="{{ key }}">
                </td>
                {% elif value == 'Y' %}
                <td>
                  <input type="checkbox" checked class="checkBtn" name="{{ key }}">
                </td>
                {% elif value == 'N' %}
                <td>
                  <input type="checkbox" class="checkBtn" name="{{ key }}">
                </td>
                {% else %}
                <td name="{{ key }}">
                  {{ value }}
                </td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script type="text/javascript">
      $('.{{ group.deptId }}'+'all').click(function () {
          $('.{{ group.deptId }}').prop('checked', this.checked);
      });

      $(".checkBtn").click(function(){
          var checkBtn = $(this);
          var tr = checkBtn.parent().parent();
          var empId = tr.attr('id');
          var menuId = checkBtn.attr('name');
          var btnchecked = checkBtn.is(":checked");

          $.ajax({
              url: "{% url 'hr:checkauthorizationasjson' %}",
              method: 'POST',
              cache: false,
              data: {"empId": empId,
                "menuId": menuId,
                "btnchecked": btnchecked,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                  console.log(returnData);
              }
          });
      });

      $(".checkBtnAll").click(function(){
          var checkBtn = $(this);
          var tr = checkBtn.parent().parent();
          var empId = tr.attr('id');
          var btnchecked = checkBtn.is(":checked");

          $.ajax({
              url: "{% url 'hr:allauthorizationasjson' %}",
              method: 'POST',
              cache: false,
              data: {"empId": empId,
                "btnchecked": btnchecked,
              },
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              success: function (returnData) {
                console.log(returnData);
                location.href = "/hr/showauthorizations/";
              }
          });
      });

      function btn_default(){
          if (confirm("기본권한을 수정하시겠습니까?") === true) {
              const defaultForm = document.getElementById('defaultForm');
              defaultForm.submit();
          } else {
              return false;
          }
      }


      $(document).ready(function () {


      });

  </script>

{% endblock %}